<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Quizzo â€” Academic Battle Platform</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Fredoka+One&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<link rel="stylesheet" href="style.css">
</head>
<body>

<button id="dark-mode-toggle" title="Toggle dark mode">
  <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
  DARK
</button>

<div class="connecting-overlay" id="overlay-connecting">
  <div class="co-spinner"></div>
  <div class="co-text" id="co-text">CONNECTING...</div>
</div>

<div class="role-badge tag-blue" id="role-badge" style="display:none;"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â• PORTAL â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen active" id="s-portal">
  <canvas id="portal-canvas"></canvas>
  <div class="portal-ui">
    <div class="logo-wrap">
      <span class="logo-emoji">ğŸª¢</span>
      <div class="logo-title">QUIZZO</div>
      <div class="logo-sub">Academic Battle Platform Â· 1v1 &amp; Group Matches</div>
    </div>
    <div class="mode-cards">
      <div class="mode-card host-card" id="btn-host-card">
        <div class="mc-top">
          <div class="mc-icon-wrap">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          </div>
          <div class="mc-title">HOST A MATCH</div>
        </div>
        <div class="mc-desc">For teachers &amp; instructors. Create a session, manage the lobby, configure question banks, set difficulty and subject, then launch the battle.</div>
        <div class="mc-cta">Set PIN &amp; Create Room â†’</div>
      </div>
      <div class="mode-card join-card" id="btn-join-card">
        <div class="mc-top">
          <div class="mc-icon-wrap">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polyline points="13 17 18 12 13 7"/><polyline points="6 17 11 12 6 7"/></svg>
          </div>
          <div class="mc-title">JOIN MATCH</div>
        </div>
        <div class="mc-desc">For students &amp; players. Enter the room code from your teacher's screen, pick your team, and enter your name. Works for 1v1 and group matches.</div>
        <div class="mc-cta">Enter Room Code &amp; Join â†’</div>
      </div>
    </div>
    <div class="portal-hint">Open this page in multiple tabs â€” one per player + one for the host</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• PIN SCREEN â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="s-pin">
  <div style="display:flex;flex-direction:column;align-items:center;min-height:100%;padding:24px 20px 40px;background:linear-gradient(160deg,#46178f 0%,#2d0f5e 100%);box-sizing:border-box;">
    <div style="width:min(460px,92vw);display:flex;align-items:center;margin-bottom:16px;">
      <div id="pin-back-row">
        <span style="font-size:15px;">â†</span><span>BACK</span>
      </div>
    </div>
    <div class="pin-panel">
      <div class="pin-panel-top"></div>
      <div style="display:flex;align-items:center;justify-content:center;height:52px;" id="pin-screen-icon">
        <svg width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="var(--blue)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
      </div>
      <div class="pin-heading" id="pin-screen-title">SET HOST PIN</div>
      <div class="pin-desc" id="pin-screen-desc">Create a 4-digit PIN to secure your host session.<br><strong style="color:var(--blue);">Only share with trusted co-hosts.</strong></div>
      <div class="pin-step" id="pin-step-lbl">STEP 1 OF 2 â€” ENTER NEW PIN</div>
      <div id="pin-dots">
        <div class="pin-dot"></div><div class="pin-dot"></div>
        <div class="pin-dot"></div><div class="pin-dot"></div>
      </div>
      <div id="pin-msg"></div>

      <!-- Passphrase input â€” shown during setup and reset flows -->
      <div id="pin-passphrase-wrap" style="display:none;width:100%;">
        <label style="font-size:10px;font-weight:800;letter-spacing:2px;color:var(--text-mid);text-transform:uppercase;display:block;margin-bottom:6px;">Secret Passphrase</label>
        <div style="position:relative;">
          <input id="pin-passphrase-input" type="password" maxlength="64"
            style="width:100%;padding:11px 44px 11px 14px;border-radius:var(--r10);border:2px solid #e0e4f0;font-family:var(--font);font-size:15px;font-weight:700;color:var(--text-dark);background:#f7f8ff;outline:none;letter-spacing:1px;transition:border 0.15s;"
            placeholder="Type your passphraseâ€¦" autocomplete="off" spellcheck="false">
          <button id="pin-pass-toggle" type="button" onclick="togglePassphraseVis()"
            style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:15px;color:var(--text-mid);" title="Show/hide">ğŸ‘</button>
        </div>
        <button id="pin-passphrase-btn" class="btn btn-blue" style="width:100%;margin-top:10px;padding:11px;" onclick="submitPassphrase()">CONFIRM â†’</button>
      </div>

      <!-- Recovery code panel â€” shown once after first setup -->
      <div id="pin-recovery-wrap" style="display:none;width:100%;">
        <div style="background:#fff8e6;border:2px solid #ffd97a;border-radius:var(--r10);padding:14px;text-align:center;">
          <div style="font-size:10px;font-weight:800;letter-spacing:2px;color:#8a6400;margin-bottom:8px;">âš  RECOVERY CODE â€” WRITE THIS DOWN</div>
          <div id="pin-recovery-code" style="font-family:var(--font-d);font-size:22px;letter-spacing:6px;color:var(--text-dark);background:#fff;border-radius:8px;padding:10px;border:2px dashed #ffd97a;"></div>
          <div style="font-size:11px;color:#8a6400;margin-top:8px;font-weight:700;line-height:1.5;">If you forget both your PIN and passphrase,<br>this code lets you reset everything. Store it safely.</div>
          <button class="btn btn-primary" style="width:100%;margin-top:12px;" onclick="copyRecoveryCode()">ğŸ“‹ Copy Code</button>
          <button class="btn btn-blue" style="width:100%;margin-top:8px;" onclick="dismissRecoveryCode()">I've saved it â€” Enter Host Panel â†’</button>
        </div>
      </div>

      <!-- Lockout notice -->
      <div id="pin-lockout-wrap" style="display:none;width:100%;text-align:center;">
        <div style="background:#ffe8ec;border:2px solid var(--red-light);border-radius:var(--r10);padding:14px;">
          <div style="font-size:13px;font-weight:800;color:var(--red);margin-bottom:4px;">ğŸ”’ Too many attempts</div>
          <div style="font-size:12px;color:var(--red);font-weight:700;">Try again in <span id="pin-lockout-timer">30</span>s</div>
        </div>
      </div>

      <div class="numpad" id="pin-numpad">
        <button class="pin-key" data-v="1">1</button>
        <button class="pin-key" data-v="2">2</button>
        <button class="pin-key" data-v="3">3</button>
        <button class="pin-key" data-v="4">4</button>
        <button class="pin-key" data-v="5">5</button>
        <button class="pin-key" data-v="6">6</button>
        <button class="pin-key" data-v="7">7</button>
        <button class="pin-key" data-v="8">8</button>
        <button class="pin-key" data-v="9">9</button>
        <button class="pin-key pin-del" data-v="del">âŒ«</button>
        <button class="pin-key" data-v="0">0</button>
        <button class="pin-key pin-ok" data-v="ok">OK âœ“</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• HOST SETUP â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="s-host">
  <div class="setup-panel">
    <div class="setup-topbar">
      <div class="back-btn" id="back-from-host">â†</div>
      <div class="setup-screen-title">Host Dashboard</div>
      <div class="host-badge" id="host-badge-bar">
        NEUTRAL HOST Â· PIN: <span id="host-pin-display" style="letter-spacing:4px;">â€¢â€¢â€¢â€¢</span>
        <button id="toggle-pin-btn" style="background:none;border:none;cursor:pointer;font-size:12px;color:rgba(0,0,0,0.5);padding:0 2px;" title="Show PIN">ğŸ‘</button>
      </div>
    </div>

    <div class="setup-card">
      <div class="host-notice">You are the <strong>neutral host / teacher</strong>. You manage the match and watch all players compete. You do not play on any team.</div>

      <div>
        <div class="setup-section-title">Game Mode</div>
        <div class="game-mode-grid">
          <div class="gm-card speed selected" id="gm-speed" onclick="selectGameMode('speed')">
            <div class="gm-card-badge">Buzzer</div>
            <div class="gm-card-title">First Correct Wins</div>
            <div class="gm-card-sub">First player to answer correctly ends the question instantly. Be fast â€” be right!</div>
          </div>
          <div class="gm-card class" id="gm-class" onclick="selectGameMode('class')">
            <div class="gm-card-badge">Classroom</div>
            <div class="gm-card-title">Class Mode</div>
            <div class="gm-card-sub">Timer runs fully. All answers collected before scoring. Structured and fair.</div>
          </div>
        </div>
        <div id="class-mode-config">
          <span class="cmc-label">Time per question:</span>
          <select class="sg-select" id="sel-timer" style="width:auto;padding:6px 10px;font-size:12px;">
            <option value="15">15 sec</option><option value="20">20 sec</option>
            <option value="30" selected>30 sec</option><option value="45">45 sec</option><option value="60">60 sec</option>
          </select>
          <span class="cmc-label">Streaks:</span>
          <select class="sg-select" id="sel-streaks" style="width:auto;padding:6px 10px;font-size:12px;">
            <option value="on" selected>Enabled</option><option value="off">Disabled</option>
          </select>
        </div>
      </div>

      <div>
        <div class="setup-section-title">Question Type</div>
        <div class="game-mode-grid" style="margin-top:10px;">
          <div class="gm-card qt-abcd selected" id="qt-abcd" onclick="selectQType('abcd')">
            <div class="gm-card-badge" style="background:#e8f4ff;color:var(--blue);">Multiple Choice</div>
            <div class="gm-card-title">A B C D</div>
            <div class="gm-card-sub">Four answer options per question. Works with all question banks.</div>
          </div>
          <div class="gm-card qt-tf" id="qt-tf" onclick="selectQType('tf')">
            <div class="gm-card-badge" style="background:#e8fff0;color:#1a9e5c;">True / False</div>
            <div class="gm-card-title">True or False</div>
            <div class="gm-card-sub">Two big choices only. Great for quick warm-up rounds.</div>
          </div>
        </div>
      </div>
      <div>
        <div class="setup-section-title">Team Names</div>
        <div class="teams-setup" style="margin-top:10px;">
          <div class="field-group">
            <label class="field-label fl-blue">Blue Team</label>
            <input class="field-input blue-field" id="inp-blue" value="APEX" maxlength="12" placeholder="Blue team name">
          </div>
          <div class="ts-vs">VS</div>
          <div class="field-group">
            <label class="field-label fl-red">Red Team</label>
            <input class="field-input red-field" id="inp-red" value="VORTEX" maxlength="12" placeholder="Red team name">
          </div>
        </div>
      </div>
      <div>
        <div class="setup-section-title">Match Settings</div>
        <div class="settings-grid" style="margin-top:10px;">
          <div class="sg-group">
            <label class="sg-label">Subject</label>
            <select class="sg-select" id="sel-subject">
              <option value="math">Mathematics</option><option value="physics">Physics</option>
              <option value="chemistry">Chemistry</option><option value="biology">Biology</option>
              <option value="cs">Computer Science</option><option value="economics">Economics</option>
              <option value="history">History</option><option value="literature">Literature</option>
            </select>
          </div>
          <div class="sg-group">
            <label class="sg-label">Difficulty</label>
            <select class="sg-select" id="sel-diff">
              <option value="mixed">Mixed</option><option value="easy">Easy</option>
              <option value="medium">Medium</option><option value="hard">Hard</option>
            </select>
          </div>
          <div class="sg-group">
            <label class="sg-label">Format</label>
            <select class="sg-select" id="sel-format">
              <option value="bo3">Best of 3</option><option value="bo5">Best of 5</option><option value="single">Single Round</option>
            </select>
          </div>
          <div class="sg-group">
            <label class="sg-label">Questions / Round</label>
            <select class="sg-select" id="sel-qcount">
              <option value="5">5 questions</option><option value="8" selected>8 questions</option>
              <option value="10">10 questions</option><option value="15">15 questions</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- QUESTION BANK -->
    <div class="setup-card qbank-card">
      <div class="qbank-header">
        <div>
          <div class="qbank-title">Question Bank Editor</div>
          <div class="qbank-meta" id="qe-meta">Load or upload questions to preview and edit</div>
        </div>
        <div class="qbank-btns">
          <button class="btn btn-ghost" style="padding:7px 13px;font-size:11px;" id="btn-upload-csv">Upload CSV</button>
          <button class="btn btn-ghost" style="padding:7px 13px;font-size:11px;" id="btn-load-qs">Load Bank</button>
          <button class="btn btn-primary" style="padding:7px 13px;font-size:11px;" id="btn-add-q">+ Add</button>
        </div>
      </div>
      <div id="qe-list">
        <div style="padding:20px;text-align:center;font-size:12px;font-weight:700;color:var(--text-mid);">
          Upload a CSV file or click "Load Bank" to view questions. Click "Add" to create manually.
        </div>
      </div>
      <div id="csv-upload-area">
        <input type="file" id="csv-file-input" accept=".csv">
        <div class="upload-zone" id="upload-drop-zone">
          <div class="upload-zone-title">Drop CSV file here or click to upload</div>
          <div class="upload-zone-sub">Columns: question, option_a, option_b, option_c, option_d, correct (A/B/C/D), difficulty (easy/medium/hard), explanation (optional)</div>
          <span class="upload-template-link" onclick="downloadCsvTemplate()">Download template CSV</span>
        </div>
        <div class="upload-preview" id="upload-preview"></div>
      </div>
    </div>

    <!-- ROOM CODE -->
    <div class="room-code-box">
      <div>
        <div class="rcb-label">Room Code â€” share with students</div>
        <div class="rcb-code" id="room-code-display">----</div>
        <div class="rcb-hint">Players open this file in another tab and enter this code</div>
      </div>
      <button class="rcb-copy-btn" id="rcb-copy-btn" onclick="copyRoomCode()">COPY</button>
    </div>

    <div id="waiting-bar" class="waiting-bar">
      <div class="waiting-dot"></div>
      <div class="waiting-text" id="waiting-text">Share the room code â€” players join from their own tab. Start when ready.</div>
    </div>

    <!-- Anti-cheat status panel -->
    <div style="background:#f0fff4;border:2px solid #6fcf97;border-radius:12px;padding:12px 16px;display:flex;flex-direction:column;gap:6px;">
      <div style="font-size:10px;font-weight:800;letter-spacing:1.5px;color:#1a9e5c;text-transform:uppercase;margin-bottom:2px;">ğŸ›¡ Anti-Cheat Active</div>
      <div style="font-size:11px;font-weight:700;color:#1a7a46;line-height:1.6;">
        âœ“ Answer keys hidden from players until reveal<br>
        âœ“ First Correct mode locks options only after a correct answer is confirmed<br>
        âœ“ Each browser gets one unique player slot<br>
        âœ“ Multi-tab same-browser joining is blocked<br>
        âœ“ Players agreed to honour code on join<br>
        âœ“ Questions randomised fresh each match
      </div>
    </div>

    <button class="btn btn-primary" id="btn-start-host" style="font-size:18px;padding:17px;width:100%;letter-spacing:1px;display:none;">
      âš” START MATCH
    </button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• JOIN SCREEN â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="s-join">
  <div class="join-panel" style="position:relative;z-index:2;">
    <div class="join-topbar">
      <div class="back-btn" id="back-from-join">â†</div>
      <div class="join-title">Join Match</div>
    </div>

    <!-- Desktop: two-column grid. Mobile: single column (CSS handles it) -->
    <div class="join-grid">

      <!-- LEFT COLUMN: code + name + team + join -->
      <div class="join-card join-left">
        <div>
          <label class="code-label">Room Code (from your teacher)</label>
          <input class="code-input" id="code-input" maxlength="4" placeholder="----" autocomplete="off">
        </div>
        <div class="field-group">
          <label class="field-label" style="color:var(--text-mid);">Your Name</label>
          <input class="name-input" id="inp-join-name" maxlength="14" placeholder="Enter your name..." autocomplete="off">
        </div>
        <div>
          <label class="field-label" style="color:var(--text-mid);margin-bottom:10px;display:block;">Pick Your Team</label>
          <div class="team-select-grid">
            <div id="team-opt-blue" class="team-opt-btn team-opt-blue selected" data-team="blue">
              <div class="team-opt-swatch blue-swatch"></div>
              <div><div style="font-family:var(--font-d);font-size:17px;color:var(--blue);">BLUE</div><div class="team-name-label">Left side</div></div>
            </div>
            <div id="team-opt-red" class="team-opt-btn team-opt-red" data-team="red">
              <div class="team-opt-swatch red-swatch"></div>
              <div><div style="font-family:var(--font-d);font-size:17px;color:var(--red);">RED</div><div class="team-name-label">Right side</div></div>
            </div>
          </div>
        </div>
        <div class="join-error" id="join-error"></div>
        <div style="background:#fff8e6;border:2px solid #ffd97a;border-radius:10px;padding:10px 14px;font-size:11px;font-weight:700;color:#8a6400;text-align:center;line-height:1.5;">
          ğŸ“ <strong>Honour Code:</strong> No searching answers online during the match. Play fair and represent your team!
        </div>
        <button class="btn btn-red" id="btn-join" disabled>JOIN ROOM â†’</button>
      </div>

      <!-- RIGHT COLUMN: avatar builder -->
      <div class="join-card join-right">
        <div class="avatar-builder" id="avatar-builder" style="border:none;padding:0;background:transparent;">
          <div class="ab-title">ğŸ¨ Customize Your Character</div>
          <div class="ab-preview-row">
            <div class="ab-canvas-wrap">
              <canvas id="ab-canvas" width="48" height="64" style="width:72px;height:96px;"></canvas>
              <button class="ab-randomize" onclick="randomizeAvatar()" title="Random!">ğŸ²</button>
            </div>
            <div class="ab-name-preview">
              <div class="ab-name-tag" id="ab-name-tag">PLAYER</div><br>
              <span class="ab-team-tag ab-team-blue" id="ab-team-tag">BLUE TEAM</span>
            </div>
          </div>
          <div class="ab-options">
            <div class="ab-row">
              <span class="ab-row-label">Skin</span>
              <div id="ab-skins"></div>
            </div>
            <div class="ab-row">
              <span class="ab-row-label">Hair</span>
              <div id="ab-hairs" style="display:flex;gap:6px;flex-wrap:wrap;"></div>
            </div>
            <div class="ab-row">
              <span class="ab-row-label">Eyes</span>
              <div id="ab-eyes" style="display:flex;gap:6px;flex-wrap:wrap;"></div>
            </div>
            <div class="ab-row">
              <span class="ab-row-label">Top</span>
              <div id="ab-accessories" style="display:flex;gap:6px;flex-wrap:wrap;"></div>
            </div>
          </div>
        </div>
      </div>

    </div><!-- end join-grid -->
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• LINEUP SCREEN â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="s-lineup">
  <div class="lineup-ui">
    <div class="lineup-header">
      <div class="lineup-title">âš” BATTLE LINEUP</div>
      <div class="lineup-sub">Get ready â€” match starts in</div>
    </div>
    <div class="lineup-teams">
      <div class="lineup-team blue-team">
        <div class="lineup-team-label" id="lineup-blue-label">BLUE TEAM</div>
        <div class="lineup-players" id="lineup-blue-players"></div>
      </div>
      <div class="lineup-vs">
        <div class="vs-divider"></div>
        <div class="vs-text">VS</div>
        <div class="vs-divider"></div>
      </div>
      <div class="lineup-team red-team">
        <div class="lineup-team-label" id="lineup-red-label">RED TEAM</div>
        <div class="lineup-players" id="lineup-red-players"></div>
      </div>
    </div>
    <div class="lineup-countdown" id="lineup-countdown">3</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• GAME SCREEN â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="s-game">
  <div class="battle-bar">
    <div class="team-bar blue-bar" id="bar-blue">
      <div class="team-avatar-bar blue" id="av-blue">A</div>
      <div class="team-bar-info">
        <div class="tb-name" id="tb-name-blue">APEX</div>
        <div class="tb-score" id="tb-score-blue">0</div>
        <div class="tb-badges">
          <div class="streak-pill" id="sp-blue">3 streak</div>
          <div class="mult-pill" id="mp-blue">Ã—2.0</div>
        </div>
        <div class="player-count-badge" id="blue-player-count"></div>
      </div>
    </div>
    <div class="bb-center">
      <div class="bbc-top" id="bbc-format">BEST OF 3</div>
      <div class="bbc-rounds" id="bbc-rounds"></div>
      <div class="bbc-label" id="bbc-round">ROUND 1</div>
    </div>
    <div class="team-bar red-bar" id="bar-red">
      <div class="team-bar-info">
        <div class="tb-name" id="tb-name-red">VORTEX</div>
        <div class="tb-score" id="tb-score-red">0</div>
        <div class="tb-badges">
          <div class="mult-pill" id="mp-red">Ã—2.0</div>
          <div class="streak-pill" id="sp-red">3 streak</div>
        </div>
        <div class="player-count-badge" id="red-player-count" style="text-align:right;"></div>
      </div>
      <div class="team-avatar-bar red" id="av-red">V</div>
    </div>
  </div>

  <div class="host-ctrl-strip" id="host-ctrl-strip">
    <span class="hcs-label">TEACHER VIEW â€” NEUTRAL HOST</span>
    <span style="font-size:11px;font-weight:600;color:rgba(0,0,0,0.4);">You are managing the match. Players answer questions.</span>
  </div>

  <div class="arena" id="arena">
    <div class="arena-glow-blue" id="ag-blue"></div>
    <div class="arena-glow-red" id="ag-red"></div>
    <canvas id="rope-canvas"></canvas>
    <div class="win-zone blue"><div class="win-zone-line"></div><div class="win-zone-label">BLUE WIN</div></div>
    <div class="win-zone red"><div class="win-zone-line"></div><div class="win-zone-label">RED WIN</div></div>
    <div class="pp-flash" id="pp-flash"><div class="pp-text blue" id="pp-text">POWER PULL</div></div>
    <!-- Between-question countdown overlay -->
    <div id="ready-overlay">
      <div class="ready-label">Next Question In</div>
      <div class="ready-num" id="ready-num">3</div>
      <div class="ready-sub" id="ready-sub">Get ready...</div>
    </div>
  </div>

  <div class="timer-row" id="timer-row">
    <div class="diff-badge easy" id="diff-badge">EASY</div>
    <div class="timer-meta">
      <div class="timer-label">Time Remaining</div>
      <div class="timer-qinfo" id="q-info">Q 1 / 8 Â· ROUND 1</div>
    </div>
    <div class="timer-num safe" id="timer-num">15</div>
    <div class="chip chip-purple" id="subject-tag-small">MATH</div>
    <div class="chip chip-blue" id="my-role-tag" style="display:none;">BLUE PLAYER</div>
    <div id="timer-bar-fill"></div>
  </div>

  <div class="question-area">
    <div class="question-card">
      <div class="q-text" id="q-text">Waiting for question...</div>
    </div>
    <div class="options-grid" id="opts-grid"></div>
    <!-- POWER-UP BAR (shown only for players, not host) -->
    <div class="powerup-bar" id="powerup-bar" style="display:none;"></div>
    <div class="answer-status">
      <div class="ans-indicator" id="ai-blue"><div class="ans-dot"></div><span id="ai-blue-text">APEX THINKING...</span></div>
      <div class="ans-vs">VS</div>
      <div class="ans-indicator" id="ai-red"><div class="ans-dot"></div><span id="ai-red-text">VORTEX THINKING...</span></div>
    </div>
  </div>
</div>

<!-- EXPLANATION OVERLAY -->
<div id="explanation-overlay">
  <div class="explanation-card">
    <div class="expl-correct">âœ“ CORRECT ANSWER</div>
    <div class="expl-answer" id="expl-answer"></div>
    <div class="expl-text" id="expl-text"></div>
    <div class="expl-timer" id="expl-timer" style="width:100%;"></div>
  </div>
</div>

<!-- FREEZE OVERLAY -->
<div class="freeze-overlay" id="freeze-overlay"></div>

<button id="proj-toggle" onclick="toggleProjection()">PROJECTION MODE</button>

<!-- â•â•â•â•â•â•â•â•â•â•â• ROUND RESULT â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="s-round">
  <div class="round-card" id="round-card">
    <div class="rc-eyebrow">ROUND COMPLETE</div>
    <div class="rc-winner" id="rc-winner">APEX WINS</div>
    <div class="rc-how" id="rc-how">by score Â· round 1</div>
    <div class="rc-scoreline">
      <div class="rcs"><div class="rcs-val blue" id="rcs-blue">0</div><div class="rcs-name" id="rcs-name-blue">APEX</div></div>
      <div class="rcs-sep">â€”</div>
      <div class="rcs"><div class="rcs-val red" id="rcs-red">0</div><div class="rcs-name" id="rcs-name-red">VORTEX</div></div>
    </div>
    <div class="rc-pips" id="rc-pips"></div>
    <div class="rc-stats" id="rc-stats"></div>
    <button class="btn btn-blue" id="btn-next-round" style="font-size:15px;padding:13px 32px;letter-spacing:1px;width:100%;">NEXT ROUND â†’</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• VICTORY â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="s-victory">
  <canvas id="vc-canvas"></canvas>
  <div class="vc-bg-blue" id="vc-bg-blue"></div>
  <div class="vc-bg-red" id="vc-bg-red"></div>
  <div class="victory-panel" id="victory-panel">
    <div class="vp-pre">MATCH COMPLETE Â· FINAL RESULT</div>
    <span class="vp-trophy">ğŸ†</span>
    <div class="vp-name blue" id="vp-name">APEX</div>
    <div class="vp-sub">WINS THE MATCH!</div>
    <div class="vp-stats" id="vp-stats"></div>
    <div class="vp-btns">
      <button class="vp-btn primary-blue" id="btn-rematch">REMATCH</button>
      <button class="vp-btn secondary" id="btn-report-card">ğŸ“‹ Report Cards</button>
      <button class="vp-btn secondary" id="btn-view-analytics">ğŸ“Š Analytics</button>
      <button class="vp-btn secondary" id="btn-back-lobby">â† Lobby</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• REPORT CARD â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="s-report">
  <div class="report-wrap">
    <div class="report-header">
      <div class="report-title">ğŸ“‹ REPORT CARDS</div>
      <div class="report-sub" id="report-sub">Match Results Â· Per Student</div>
    </div>
    <div class="report-cards" id="report-cards"></div>
    <div class="report-footer">
      <button class="report-export-btn btn btn-primary" onclick="exportReportCSV()">â¬‡ Export CSV</button>
      <button class="report-export-btn btn btn-ghost" onclick="showScreen('s-victory')">â† Back</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• ANALYTICS â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="s-analytics">
  <div class="analytics-panel">
    <div class="analytics-topbar">
      <div class="back-btn" id="back-from-analytics" style="background:rgba(255,255,255,0.15);border-color:rgba(255,255,255,0.3);">â†</div>
      <div class="analytics-title">Match Analytics</div>
      <div style="margin-left:auto;display:flex;gap:8px;" id="analytics-export-btns"></div>
    </div>
    <div id="analytics-content"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• QUESTION MODAL â•â•â•â•â•â•â•â•â•â•â• -->
<div id="q-modal" style="display:none;position:fixed;inset:0;z-index:500;background:rgba(70,23,143,0.92);backdrop-filter:blur(16px);align-items:center;justify-content:center;padding:20px;">
  <div style="background:#fff;border-radius:var(--r20);padding:28px;width:min(560px,100%);max-height:90vh;overflow-y:auto;position:relative;animation:cardBounceIn 0.3s cubic-bezier(0.34,1.56,0.64,1);box-shadow:0 10px 0 rgba(0,0,0,0.3);">
    <div style="position:absolute;top:0;left:0;right:0;height:5px;border-radius:var(--r20) var(--r20) 0 0;background:linear-gradient(90deg,var(--blue),var(--purple));"></div>
    <div style="font-family:var(--font-d);font-size:16px;color:var(--purple);margin-bottom:18px;margin-top:4px;" id="qm-title">ADD QUESTION</div>
    <div style="display:flex;flex-direction:column;gap:5px;margin-bottom:12px;">
      <label style="font-size:10px;font-weight:800;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-mid);">Question Text</label>
      <textarea id="qm-q" rows="3" style="background:#f7f8ff;border:2px solid #e0e4f0;border-radius:var(--r10);color:var(--text-dark);font-family:var(--font);font-size:13px;font-weight:600;padding:9px 12px;width:100%;outline:none;resize:none;" placeholder="Type your question here..."></textarea>
    </div>
    <div style="font-size:10px;font-weight:800;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-mid);margin-bottom:9px;">Answer Options â€” â—‰ marks correct answer</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:12px;">
      <div style="display:flex;align-items:center;gap:7px;background:#ffe8ec;border-radius:var(--r10);padding:7px 11px;">
        <input type="radio" name="qm-cor" value="0" id="qm-r0" style="width:15px;height:15px;accent-color:var(--red);cursor:pointer;flex-shrink:0;">
        <label for="qm-r0" style="font-family:var(--font-d);font-size:12px;color:var(--red);min-width:12px;">A</label>
        <input class="qm-opt" id="qm-o0" placeholder="Option A" style="background:transparent;border:none;flex:1;font-family:var(--font);font-size:12px;font-weight:700;color:var(--text-dark);outline:none;">
      </div>
      <div style="display:flex;align-items:center;gap:7px;background:#e8f4ff;border-radius:var(--r10);padding:7px 11px;">
        <input type="radio" name="qm-cor" value="1" id="qm-r1" style="width:15px;height:15px;accent-color:var(--blue);cursor:pointer;flex-shrink:0;">
        <label for="qm-r1" style="font-family:var(--font-d);font-size:12px;color:var(--blue);min-width:12px;">B</label>
        <input class="qm-opt" id="qm-o1" placeholder="Option B" style="background:transparent;border:none;flex:1;font-family:var(--font);font-size:12px;font-weight:700;color:var(--text-dark);outline:none;">
      </div>
      <div style="display:flex;align-items:center;gap:7px;background:#fff3cd;border-radius:var(--r10);padding:7px 11px;">
        <input type="radio" name="qm-cor" value="2" id="qm-r2" style="width:15px;height:15px;accent-color:var(--gold-dark);cursor:pointer;flex-shrink:0;">
        <label for="qm-r2" style="font-family:var(--font-d);font-size:12px;color:var(--gold-dark);min-width:12px;">C</label>
        <input class="qm-opt" id="qm-o2" placeholder="Option C" style="background:transparent;border:none;flex:1;font-family:var(--font);font-size:12px;font-weight:700;color:var(--text-dark);outline:none;">
      </div>
      <div style="display:flex;align-items:center;gap:7px;background:#e8f9e0;border-radius:var(--r10);padding:7px 11px;">
        <input type="radio" name="qm-cor" value="3" id="qm-r3" style="width:15px;height:15px;accent-color:var(--green);cursor:pointer;flex-shrink:0;">
        <label for="qm-r3" style="font-family:var(--font-d);font-size:12px;color:var(--green);min-width:12px;">D</label>
        <input class="qm-opt" id="qm-o3" placeholder="Option D" style="background:transparent;border:none;flex:1;font-family:var(--font);font-size:12px;font-weight:700;color:var(--text-dark);outline:none;">
      </div>
    </div>
    <div style="display:flex;flex-direction:column;gap:5px;margin-bottom:12px;">
      <label style="font-size:10px;font-weight:800;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-mid);">Difficulty</label>
      <select id="qm-diff" style="background:#f7f8ff;border:2px solid #e0e4f0;border-radius:var(--r10);color:var(--text-dark);font-family:var(--font);font-size:13px;font-weight:700;padding:9px 12px;width:100%;outline:none;">
        <option value="easy">Easy â€” 100 pts</option><option value="medium" selected>Medium â€” 200 pts</option><option value="hard">Hard â€” 400 pts</option>
      </select>
    </div>
    <div>
      <div style="font-size:10px;font-weight:800;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-mid);margin-bottom:7px;">ğŸ’¡ Explanation <span style="font-weight:600;text-transform:none;letter-spacing:0;">(shown after answer â€” optional)</span></div>
      <textarea id="qm-explanation" rows="2" style="background:#f7f8ff;border:2px solid #e0e4f0;border-radius:var(--r10);color:var(--text-dark);font-family:var(--font);font-size:13px;font-weight:600;padding:9px 12px;width:100%;outline:none;resize:none;" placeholder="e.g. The speed of light is exactly 299,792,458 m/s by definition..."></textarea>
    </div>
    <div style="font-size:11px;font-weight:700;color:var(--text-mid);margin-bottom:16px;">Select the correct answer (â—‰) before saving</div>
    <div style="display:flex;justify-content:flex-end;gap:9px;">
      <button style="background:#f7f8ff;border:2px solid #e0e0f0;border-radius:var(--r10);color:var(--text-mid);padding:8px 16px;cursor:pointer;font-family:var(--font);font-size:12px;font-weight:800;" id="qm-cancel">CANCEL</button>
      <button class="btn btn-blue" style="padding:8px 16px;font-size:12px;" id="qm-save">SAVE QUESTION</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BROADCAST CHANNEL / LOCALSTORAGE SYNC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CHANNEL_NAME = 'quizzo-v2';
let bc = null;
try { bc = new BroadcastChannel(CHANNEL_NAME); } catch(e) { bc = null; }

function sendMsg(type, data={}) {
  const msg = { type, data, ts: Date.now() };
  if (bc) bc.postMessage(msg);
  else {
    localStorage.setItem('tow_msg', JSON.stringify(msg));
    setTimeout(() => localStorage.setItem('tow_msg', JSON.stringify({...msg, _r:1})), 10);
  }
}

function onMsg(handler) {
  if (bc) bc.onmessage = e => handler(e.data);
  else window.addEventListener('storage', e => {
    if (e.key === 'tow_msg' && e.newValue) {
      try { handler(JSON.parse(e.newValue)); } catch(err) {}
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  QUESTION BANKS (8 subjects Ã— 15 questions)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const QB = {
  math:[
    {q:"Derivative of f(x) = 3xÂ³ âˆ’ 5xÂ² + 2x?",o:["9xÂ² âˆ’ 10x + 2","6xÂ³ âˆ’ 10x + 2","9xÂ² âˆ’ 5x + 2","3xÂ² âˆ’ 10x"],a:0,d:"medium"},
    {q:"lim(xâ†’0) sin(x)/x = ?",o:["0","âˆ","1","Undefined"],a:2,d:"easy"},
    {q:"âˆ«(2x + 3)dx from 0 to 4 = ?",o:["28","20","24","32"],a:0,d:"medium"},
    {q:"Sum of infinite series: 1 + Â½ + Â¼ + â…› + â€¦ = ?",o:["1.5","2","2.5","âˆ"],a:1,d:"easy"},
    {q:"logâ‚‚(128) = ?",o:["6","7","8","9"],a:1,d:"easy"},
    {q:"P(A)=0.4, P(B)=0.3, independent. P(Aâˆ©B) = ?",o:["0.12","0.7","0.1","0.58"],a:0,d:"easy"},
    {q:"Standard deviation of {2,4,4,4,5,5,7,9} = ?",o:["1","2","3","4"],a:1,d:"medium"},
    {q:"Second derivative of y = xâ´ âˆ’ 3xÂ³?",o:["12xÂ² âˆ’ 18x","4xÂ³ âˆ’ 9xÂ²","12x âˆ’ 18","12xÂ² âˆ’ 9x"],a:0,d:"medium"},
    {q:"Area under f(x) = xÂ² from x = 0 to x = 3?",o:["6","9","12","27"],a:1,d:"medium"},
    {q:"|z| when z = 3 + 4i?",o:["3","4","5","7"],a:2,d:"easy"},
    {q:"Solve: 2x + y = 7, x âˆ’ y = 2. Find x.",o:["3","1","5","2"],a:0,d:"medium"},
    {q:"det(2A) if A is 3Ã—3 and det(A) = 5?",o:["10","25","40","160"],a:2,d:"hard"},
    {q:"Eigenvalue equation for matrix A?",o:["Av = Î»v","A + v = Î»","AÎ» = v","det(A) = Î»"],a:0,d:"hard"},
    {q:"n!/(nâˆ’k)! is a?",o:["Combination","Permutation","Factorial","Binomial"],a:1,d:"easy"},
    {q:"Quadratic formula denominator for axÂ²+bx+c=0?",o:["2a","a","2b","aÂ²"],a:0,d:"easy"},
  ],
  physics:[
    {q:"Ball dropped 20m, impact velocity (g=10)?",o:["10 m/s","20 m/s","30 m/s","40 m/s"],a:1,d:"medium"},
    {q:"F = ma is Newton's ___ Law?",o:["First","Second","Third","Fourth"],a:1,d:"easy"},
    {q:"SI unit of electric charge?",o:["Volt","Ampere","Coulomb","Farad"],a:2,d:"easy"},
    {q:"Photon energy: E = ?",o:["mcÂ²","hf","Â½mvÂ²","kT"],a:1,d:"medium"},
    {q:"Speed of light in vacuum?",o:["3Ã—10â¸ m/s","3Ã—10â¶ m/s","3Ã—10Â¹â° m/s","1.5Ã—10â¸ m/s"],a:0,d:"easy"},
    {q:"Heisenberg Uncertainty Principle?",o:["Î”xÎ”p â‰¥ â„/2","E = mcÂ²","F = qvB","pV = nRT"],a:0,d:"hard"},
    {q:"Pendulum period depends on?",o:["Mass only","Length only","Both mass & length","Neither"],a:1,d:"medium"},
    {q:"Ohm's Law: V = ?",o:["IR","I/R","IÂ²R","IRÂ²"],a:0,d:"easy"},
    {q:"Half-life of Carbon-14?",o:["5,730 years","1,000 years","10,000 years","570 years"],a:0,d:"hard"},
    {q:"Force on orbiting satellite toward center?",o:["Centrifugal","Gravity","Normal","Friction"],a:1,d:"medium"},
    {q:"Wave type requiring a medium?",o:["Electromagnetic","Transverse","Mechanical","Light"],a:2,d:"easy"},
    {q:"Elastic collision conserves?",o:["Momentum only","KE only","Both momentum & KE","Neither"],a:2,d:"medium"},
    {q:"Kirchhoff's voltage law: loop sum = ?",o:["1","0","V_source","IÃ—R"],a:1,d:"medium"},
    {q:"SI unit of pressure?",o:["Newton","Pascal","Joule","Watt"],a:1,d:"easy"},
    {q:"Quantum number defining energy level?",o:["n","l","m","s"],a:0,d:"hard"},
  ],
  chemistry:[
    {q:"Molar mass of Hâ‚‚O?",o:["16 g/mol","18 g/mol","20 g/mol","14 g/mol"],a:1,d:"easy"},
    {q:"pH of neutral solution at 25Â°C?",o:["0","7","14","1"],a:1,d:"easy"},
    {q:"Le Chatelier's Principle: equilibrium system?",o:["Goes to completion","Counteracts imposed changes","Entropy increases","Conserves energy"],a:1,d:"medium"},
    {q:"Atoms in one mole (Avogadro's number)?",o:["6.022Ã—10Â²Â³","3.14Ã—10Â²Â³","1.38Ã—10Â²Â³","9.11Ã—10Â²Â³"],a:0,d:"easy"},
    {q:"Hybridization of C in CHâ‚„?",o:["sp","spÂ²","spÂ³","spÂ³d"],a:2,d:"medium"},
    {q:"Strongest intermolecular force?",o:["London dispersion","Dipole-dipole","Hydrogen bonding","Van der Waals"],a:2,d:"medium"},
    {q:"Oxidation state of O in Hâ‚‚Oâ‚‚?",o:["-1","-2","0","+1"],a:0,d:"hard"},
    {q:"Most electronegative element?",o:["Oxygen","Nitrogen","Chlorine","Fluorine"],a:3,d:"easy"},
    {q:"Arrhenius acid donates?",o:["Hâº","OHâ»","eâ»","Hâ‚‚O"],a:0,d:"medium"},
    {q:"Rate = k[A]Â²[B]. Overall order?",o:["2nd","3rd","1st","4th"],a:1,d:"hard"},
    {q:"Bond holding DNA strands?",o:["Covalent","Ionic","Hydrogen","Peptide"],a:2,d:"medium"},
    {q:"Ideal gas law?",o:["PV=nRT","PV=NkT","Pâ‚Vâ‚=Pâ‚‚Vâ‚‚","All correct"],a:3,d:"medium"},
    {q:"2Hâ‚‚ + Oâ‚‚ â†’ 2Hâ‚‚O is a?",o:["Decomposition","Synthesis","Single displacement","Double displacement"],a:1,d:"easy"},
    {q:"DNA replication is?",o:["Conservative","Semi-conservative","Dispersive","Non-conservative"],a:1,d:"medium"},
    {q:"Electron config of Fe?",o:["[Ar]3dâ¶4sÂ²","[Ar]3dâ¸","[Kr]3dâ¶4sÂ²","[Ne]3dâ¶4sÂ²"],a:0,d:"hard"},
  ],
  biology:[
    {q:"Powerhouse of the cell?",o:["Nucleus","Ribosome","Mitochondria","Golgi apparatus"],a:2,d:"easy"},
    {q:"DNA replication type?",o:["Conservative","Semi-conservative","Dispersive","Non-conservative"],a:1,d:"medium"},
    {q:"Universal blood donor type?",o:["A+","Bâˆ’","AB+","Oâˆ’"],a:3,d:"easy"},
    {q:"mRNA role in protein synthesis?",o:["Template for transcription","Carries amino acids","Carries code to ribosome","Catalyzes reactions"],a:2,d:"medium"},
    {q:"Chromosomes align during?",o:["Prophase","Metaphase","Anaphase","Telophase"],a:1,d:"medium"},
    {q:"Natural selection acts on?",o:["Genes directly","Phenotypes","Genotypes","Mutations only"],a:1,d:"medium"},
    {q:"Enzyme synthesizing new DNA?",o:["RNA polymerase","DNA ligase","DNA polymerase","Helicase"],a:2,d:"medium"},
    {q:"Organelle for protein synthesis?",o:["Lysosome","Ribosome","Centrosome","Vacuole"],a:1,d:"easy"},
    {q:"Bond connecting amino acids?",o:["Hydrogen bond","Peptide bond","Ionic bond","Disulfide bond"],a:1,d:"medium"},
    {q:"F2 monohybrid phenotype ratio?",o:["1:1","2:1","3:1","4:1"],a:2,d:"medium"},
    {q:"Krebs cycle generates primarily?",o:["DNA","ATP via ETC","NADH/FADHâ‚‚ and COâ‚‚","Proteins"],a:2,d:"hard"},
    {q:"Antibody-producing cells?",o:["T cells","NK cells","B cells","Macrophages"],a:2,d:"medium"},
    {q:"Central Dogma: DNA â†’ __ â†’ Protein?",o:["Lipid","RNA","ATP","Amino acid"],a:1,d:"medium"},
    {q:"Hardy-Weinberg requires?",o:["Random mating, no mutation, no selection, large pop","Small pop","Strong selection","Genetic drift"],a:0,d:"hard"},
    {q:"Epigenetics: expression changes without?",o:["DNA mutation","DNA sequence changes","RNA editing","Gene deletion"],a:1,d:"hard"},
  ],
  cs:[
    {q:"Time complexity of binary search?",o:["O(n)","O(nÂ²)","O(log n)","O(n log n)"],a:2,d:"easy"},
    {q:"LIFO data structure?",o:["Queue","Stack","Linked List","Tree"],a:1,d:"easy"},
    {q:"O(n log n) typically describes?",o:["Bubble sort","Binary search","Merge sort","Linear search"],a:2,d:"medium"},
    {q:"Deadlock: two processes?",o:["Crash simultaneously","Wait on each other indefinitely","Share memory","Fork infinitely"],a:1,d:"medium"},
    {q:"Quick sort worst-case?",o:["O(n)","O(n log n)","O(nÂ²)","O(log n)"],a:2,d:"medium"},
    {q:"SQL filter after grouping: use?",o:["WHERE","HAVING","ORDER BY","GROUP BY"],a:1,d:"medium"},
    {q:"Hash function's purpose?",o:["Encrypt data","Map to fixed-size keys","Compress files","Sort arrays"],a:1,d:"medium"},
    {q:"Binary tree height h: max nodes?",o:["2h","2^h","2^(h+1)âˆ’1","hÂ²"],a:2,d:"hard"},
    {q:"Dijkstra's finds?",o:["Min spanning tree","Shortest weighted path","All paths","Topological order"],a:1,d:"medium"},
    {q:"Python 'yield' creates a?",o:["Thread","Generator","Decorator","Module"],a:1,d:"medium"},
    {q:"CAP theorem: can guarantee max __ of 3?",o:["1","2","3","0"],a:1,d:"hard"},
    {q:"Memoization means?",o:["Memory management","Caching function results","Encrypting memory","Deallocation"],a:1,d:"medium"},
    {q:"TCP stands for?",o:["Transfer Control Protocol","Transmission Control Protocol","Transport Config Protocol","Terminal Control Protocol"],a:1,d:"easy"},
    {q:"Polymorphism: one interface, __ implementations?",o:["One","Multiple","No","Hidden"],a:1,d:"medium"},
    {q:"DNS stands for?",o:["Domain Name System","Dynamic Network Service","Data Naming Standard","Digital Node Server"],a:0,d:"easy"},
  ],
  economics:[
    {q:"GDP measures?",o:["Govt spending","Total value of goods/services produced","Trade balance","Inflation"],a:1,d:"easy"},
    {q:"Higher price â†’ __ demand (Law of Demand)?",o:["Higher","Lower","Same","Unpredictable"],a:1,d:"easy"},
    {q:"Opportunity cost = ?",o:["Direct cost","Next best alternative foregone","Sunk cost","Marginal cost"],a:1,d:"easy"},
    {q:"Fiscal policy involves?",o:["Central bank rates","Money supply","Govt spending & taxes","Exchange rates"],a:2,d:"medium"},
    {q:"Price elasticity of demand = ?",o:["%Î”Qd/%Î”P","%Î”P/%Î”Qd","Î”Qd/Î”P","Î”P/Î”Qd"],a:0,d:"medium"},
    {q:"Comparative advantage: produce at lower?",o:["Absolute cost","Opportunity cost","Market price","Marginal cost"],a:1,d:"medium"},
    {q:"Stagflation = high inflation + high?",o:["Growth","Unemployment","Investment","Trade surplus"],a:1,d:"hard"},
    {q:"Gini coefficient measures?",o:["Output","Income inequality","Inflation","Unemployment"],a:1,d:"medium"},
    {q:"Moral hazard: risk increases when?",o:["Markets are free","Protected from consequences","Taxes are high","Inflation is low"],a:1,d:"hard"},
    {q:"Quantitative easing: central bank?",o:["Raises rates","Buys assets to inject money","Reduces spending","Increases taxes"],a:1,d:"hard"},
    {q:"Multiplier effect: initial spending creates __ change?",o:["Smaller","Larger","Equal","No"],a:1,d:"medium"},
    {q:"Nash Equilibrium is from?",o:["Macroeconomics","Game theory","Behavioral economics","Keynesian theory"],a:1,d:"medium"},
    {q:"Perfect competition has?",o:["Few sellers","Price makers","Many sellers, homogeneous product","High barriers"],a:2,d:"medium"},
    {q:"Inflation measured by?",o:["GDP growth","CPI","Unemployment rate","Interest rates"],a:1,d:"easy"},
    {q:"Keynesian: wages adjust slowly, causing?",o:["Inflation","Unemployment","Surplus","Growth"],a:1,d:"hard"},
  ],
  history:[
    {q:"World War I began?",o:["1912","1914","1916","1918"],a:1,d:"easy"},
    {q:"Treaty of Versailles ended?",o:["WWII","Cold War","WWI","Crimean War"],a:2,d:"easy"},
    {q:"First US President?",o:["Jefferson","Adams","Washington","Franklin"],a:2,d:"easy"},
    {q:"French Revolution began?",o:["1776","1789","1799","1815"],a:1,d:"easy"},
    {q:"Primary cause of WWI?",o:["German invasion of Poland","Assassination of Franz Ferdinand","Pearl Harbor attack","Economic depression"],a:1,d:"medium"},
    {q:"Berlin Wall fell?",o:["1985","1987","1989","1991"],a:2,d:"medium"},
    {q:"Communist Manifesto authors?",o:["Engels only","Marx only","Marx & Engels","Lenin"],a:2,d:"easy"},
    {q:"Magna Carta signed?",o:["1066","1215","1381","1453"],a:1,d:"medium"},
    {q:"Marshall Plan was?",o:["Military alliance","US plan to rebuild post-WWII Europe","Nuclear treaty","Colonial plan"],a:1,d:"medium"},
    {q:"Opium Wars: China vs?",o:["France","USA","Britain","Russia"],a:2,d:"medium"},
    {q:"India's independence?",o:["1945","1947","1950","1952"],a:1,d:"easy"},
    {q:"Cuban Missile Crisis?",o:["1958","1960","1962","1964"],a:2,d:"medium"},
    {q:"Nuremberg Trials tried war criminals from?",o:["WWI","Cold War","WWII","Vietnam War"],a:2,d:"easy"},
    {q:"Bretton Woods established?",o:["NATO","Gold-standard monetary system","UN","Marshall Plan"],a:1,d:"hard"},
    {q:"Renaissance originated in?",o:["France","Spain","England","Italy"],a:3,d:"easy"},
  ],
  literature:[
    {q:"Author of '1984'?",o:["Aldous Huxley","George Orwell","Ray Bradbury","H.G. Wells"],a:1,d:"easy"},
    {q:"'To be or not to be' â€” play?",o:["Macbeth","Othello","Hamlet","King Lear"],a:2,d:"easy"},
    {q:"'The wind whispered' â€” literary device?",o:["Metaphor","Simile","Personification","Alliteration"],a:2,d:"easy"},
    {q:"Author of 'Pride and Prejudice'?",o:["Charlotte BrontÃ«","Emily BrontÃ«","Jane Austen","Mary Shelley"],a:2,d:"easy"},
    {q:"'The Sound and the Fury' technique?",o:["Omniscient narrator","Stream of consciousness","Epistolary","Third-person limited"],a:1,d:"hard"},
    {q:"Main turning point in a story?",o:["Rising action","Climax","Denouement","Exposition"],a:1,d:"easy"},
    {q:"Kafka's Gregor transforms into?",o:["Wolf","Bird","Insect","Rat"],a:2,d:"medium"},
    {q:"Unreliable narrator has compromised?",o:["Memory","Credibility","Knowledge","Language"],a:1,d:"medium"},
    {q:"Author of 'Lolita'?",o:["Dostoevsky","Chekhov","Nabokov","Tolstoy"],a:2,d:"medium"},
    {q:"Iambic pentameter: __ syllables/line?",o:["8","10","12","14"],a:1,d:"hard"},
    {q:"'Crime and Punishment' protagonist?",o:["Ivan Karamazov","Raskolnikov","Prince Myshkin","Bazarov"],a:1,d:"medium"},
    {q:"Magical realism most associated with?",o:["East Asia","Eastern Europe","Latin America","West Africa"],a:2,d:"medium"},
    {q:"'In medias res' means?",o:["Sudden ending","Beginning mid-action","Two stories","Flashback"],a:1,d:"medium"},
    {q:"'Great Gatsby' decade?",o:["1910s","1920s","1930s","1940s"],a:1,d:"easy"},
    {q:"Harlem Renaissance flourished in?",o:["1900s","1920s","1940s","1960s"],a:1,d:"medium"},
  ],
};

const SUBJ_NAMES={math:"MATHEMATICS",physics:"PHYSICS",chemistry:"CHEMISTRY",biology:"BIOLOGY",cs:"COMPUTER SCIENCE",economics:"ECONOMICS",history:"HISTORY",literature:"LITERATURE"};
const SUBJ_SHORT={math:"MATH",physics:"PHYSICS",chemistry:"CHEM",biology:"BIO",cs:"CS",economics:"ECON",history:"HISTORY",literature:"LIT"};
const DIFF_PTS={easy:100,medium:200,hard:400};
const MULT_TABLE=[1,1,1.5,2,2.5,3,4,5];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ROLE = null;
let ROOM_CODE = null;
let MY_TEAM = 'blue';
let MY_NAME = '';

// â”€â”€ Anti-cheat #3 & #5: Persistent browser identity via sessionStorage â”€â”€
// Each browser tab gets a unique PID that persists through refreshes.
// This lets us reconnect players AND detect multi-tab cheating.
let BROWSER_PID = sessionStorage.getItem('quizzo_browser_pid');
if(!BROWSER_PID){
  BROWSER_PID = 'player_'+Date.now()+'_'+Math.random().toString(36).slice(2,8);
  sessionStorage.setItem('quizzo_browser_pid', BROWSER_PID);
}
let SESSION_PIN = '';
let GAME_MODE = 'speed';
let QUESTION_TYPE = 'abcd';

let G = {
  blueN:'APEX', redN:'VORTEX',
  subject:'math', diff:'mixed', fmt:'bo3', qcount:8,
  totalR:3, toWin:2,
  gameMode:'speed', timerMax:20, streaksEnabled:true, questionType:'abcd',
  players:[],
  questions:[], currentQ:0, currentRound:1,
  blueScore:0, redScore:0,
  blueRoundScore:0, redRoundScore:0,
  roundWins:{blue:0,red:0}, roundHistory:[],
  rope:0.5,
  timerSec:20, timerID:null, qStartTime:0,
  locked:false,
  blueAnswers:{}, redAnswers:{},
  questionLog:[],
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PORTAL CANVAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const pc = document.getElementById('portal-canvas');
const pCtx = pc.getContext('2d');
let pParts = [];
function initPortal(){
  pc.width=window.innerWidth; pc.height=window.innerHeight;
  pParts = Array.from({length:60},()=>({
    x:Math.random()*pc.width, y:Math.random()*pc.height,
    vx:(Math.random()-0.5)*0.6, vy:(Math.random()-0.5)*0.6,
    r:Math.random()*3+1, col:Math.random()>0.5?'255,255,255':'255,204,0',
    a:Math.random()*0.3+0.05,
  }));
}
function animPortal(){
  if(!document.getElementById('s-portal').classList.contains('active')) return;
  requestAnimationFrame(animPortal);
  pCtx.clearRect(0,0,pc.width,pc.height);
  pParts.forEach(p=>{
    p.x+=p.vx; p.y+=p.vy;
    if(p.x<0) p.x=pc.width; if(p.x>pc.width) p.x=0;
    if(p.y<0) p.y=pc.height; if(p.y>pc.height) p.y=0;
    pCtx.beginPath(); pCtx.arc(p.x,p.y,p.r,0,Math.PI*2);
    pCtx.fillStyle=`rgba(${p.col},${p.a})`; pCtx.fill();
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ROPE CANVAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const rc = document.getElementById('rope-canvas');
const rCtx = rc.getContext('2d');
let ropeTime = 0, ropeRAF = null, ropeTarget = 0.5;

// Character animation state
let charAnim = {
  blue: { lunge: 0, lungeDir: 1, stumble: 0 },  // lunge: 0-1, stumble: 0-1
  red:  { lunge: 0, lungeDir: -1, stumble: 0 }
};

function resizeRope(){
  const arena = document.getElementById('arena');
  rc.width = arena.offsetWidth; rc.height = arena.offsetHeight;
}

// Trigger lunge animation for a team
function triggerLunge(team){
  charAnim[team].lunge = 1;
  charAnim[team].stumble = 0;
}
function triggerStumble(team){
  charAnim[team].stumble = 1;
  charAnim[team].lunge = 0;
}

// Draw a tiny pixel character onto the rope canvas
// px,py = center-bottom position, scale = pixel block size, facing = 1(right) or -1(left)
function drawCharOnRope(ctx, av, teamColor, cx, cy, scale, facing, streakLevel){
  const S = scale;
  const W = 12, H = 16;
  // offset so character stands with feet at cy, centered at cx
  const ox = cx - (W*S)/2;
  const oy = cy - H*S;
  const skin = SKIN_COLORS[av.skin] || SKIN_COLORS[0];
  const hair = HAIR_COLORS[av.hair] || HAIR_COLORS[0];
  const tc = teamColor;

  // Fire/energy aura for streak
  if(streakLevel >= 1){
    const auraColors = ['#ff8c00','#ff4500','#ff0000'];
    const auraColor = auraColors[Math.min(streakLevel-1, 2)];
    const intensity = Math.min(streakLevel, 3);
    // Animated flicker using ropeTime
    const flicker = 0.6 + 0.4*Math.sin(ropeTime*8 + cx);
    const auraSize = (S*3 + intensity*S*1.5) * flicker;
    const grd = ctx.createRadialGradient(cx, cy-H*S*0.5, 0, cx, cy-H*S*0.5, H*S*0.8+auraSize);
    grd.addColorStop(0, `rgba(255,220,0,${0.15*intensity*flicker})`);
    grd.addColorStop(0.4, `${auraColor}${Math.round(0.25*intensity*flicker*255).toString(16).padStart(2,'0')}`);
    grd.addColorStop(1, 'rgba(255,69,0,0)');
    ctx.fillStyle = grd;
    ctx.beginPath();
    ctx.ellipse(cx, cy-H*S*0.45, W*S*0.7+auraSize*0.5, H*S*0.65+auraSize*0.4, 0, 0, Math.PI*2);
    ctx.fill();
    // Fire particles
    for(let i=0;i<3*intensity;i++){
      const angle = ropeTime*3 + i*2.1;
      const r = (H*S*0.4 + auraSize*0.3) * (0.7+0.3*Math.sin(ropeTime*5+i));
      const fx = cx + Math.cos(angle)*r*0.6;
      const fy = cy - H*S*0.5 + Math.sin(angle)*r*0.4 - Math.abs(Math.sin(ropeTime*4+i))*S*2;
      const fs = S*(0.8+0.5*Math.sin(ropeTime*6+i*1.3));
      ctx.fillStyle = i%2===0 ? '#ff8c00' : '#fff176';
      ctx.fillRect(fx-fs/2, fy-fs/2, fs, fs);
    }
  }

  ctx.save();
  if(facing === -1){
    // Mirror for red team (facing left)
    ctx.translate(cx*2, 0);
    ctx.scale(-1, 1);
  }

  function px(x, y, c){
    ctx.fillStyle = c;
    ctx.fillRect(ox + x*S, oy + y*S, S, S);
  }

  // Body
  for(let y=8;y<13;y++) for(let x=2;x<10;x++) px(x,y,tc);
  for(let y=8;y<12;y++){ px(1,y,tc); px(10,y,tc); }
  for(let y=11;y<13;y++){ px(0,y,skin); px(11,y,skin); }
  // Hands grabbing rope (slightly forward)
  px(11,10,'#c8924a'); px(12,10,'#c8924a');

  // Legs (pulling stance - bent)
  for(let y=13;y<15;y++){ px(2,y,'#2c3e50'); px(3,y,'#2c3e50'); }
  for(let y=14;y<16;y++){ px(8,y,'#2c3e50'); px(9,y,'#2c3e50'); }
  px(1,14,'#2c3e50'); px(10,15,'#2c3e50');
  // Shoes
  px(1,15,'#1a1a1a'); px(2,15,'#1a1a1a'); px(3,15,'#1a1a1a');
  px(8,15,'#1a1a1a'); px(9,15,'#1a1a1a'); px(10,15,'#1a1a1a');

  // Neck + Head
  for(let y=6;y<8;y++) for(let x=4;x<8;x++) px(x,y,skin);
  for(let y=1;y<7;y++) for(let x=2;x<10;x++) px(x,y,skin);

  // Hair
  for(let x=2;x<10;x++){ px(x,0,hair); px(x,1,hair); }
  px(2,2,hair); px(2,3,hair); px(9,2,hair); px(9,3,hair);

  // Eyes
  const eyeStyle = EYE_STYLES[av.eyes] || 'normal';
  if(eyeStyle==='normal'){ px(4,3,'#1a1a1a'); px(4,4,'#fff'); px(7,3,'#1a1a1a'); px(7,4,'#fff'); }
  else if(eyeStyle==='happy'){ px(4,3,'#1a1a1a'); px(5,4,'#1a1a1a'); px(7,3,'#1a1a1a'); px(6,4,'#1a1a1a'); }
  else if(eyeStyle==='cool'){ px(3,3,'#1a1a1a'); px(4,3,'#1a1a1a'); px(5,3,'#1a1a1a'); px(7,3,'#1a1a1a'); px(8,3,'#1a1a1a'); px(9,3,'#1a1a1a'); }
  else if(eyeStyle==='sleepy'){ px(4,3,'#1a1a1a'); px(5,3,'#1a1a1a'); px(7,3,'#1a1a1a'); px(8,3,'#1a1a1a'); }
  else if(eyeStyle==='star'){ px(4,3,'#FFD700'); px(5,2,'#FFD700'); px(6,3,'#FFD700'); px(5,4,'#FFD700'); px(3,3,'#FFD700'); px(7,3,'#FFD700'); px(8,2,'#FFD700'); px(9,3,'#FFD700'); px(8,4,'#FFD700'); }

  // Mouth (determined grimace while pulling)
  px(4,5,'#1a1a1a'); px(5,5,'#1a1a1a'); px(6,5,'#1a1a1a'); px(7,5,'#1a1a1a');

  // Accessory
  const acc = ACCESSORIES[av.accessory] || 'none';
  if(acc==='crown'){
    ctx.fillStyle='#FFD700';
    ctx.fillRect(ox+3*S, oy, 7*S, S);
    ctx.fillRect(ox+3*S, oy-S, S, S);
    ctx.fillRect(ox+5*S, oy-S, S, S);
    ctx.fillRect(ox+7*S, oy-S, S, S);
    ctx.fillRect(ox+9*S, oy-S, S, S);
  } else if(acc==='glasses'){
    ctx.fillStyle='rgba(0,180,255,0.35)';
    ctx.fillRect(ox+3*S,oy+3*S,3*S,2*S);
    ctx.fillRect(ox+7*S,oy+3*S,3*S,2*S);
    ctx.fillStyle='#333';
    ctx.fillRect(ox+3*S,oy+3*S,3*S,S*0.5);
    ctx.fillRect(ox+7*S,oy+3*S,3*S,S*0.5);
    ctx.fillRect(ox+6*S,oy+3*S,S,S*0.5);
    ctx.fillRect(ox+2*S,oy+3*S,S,S*0.5);
    ctx.fillRect(ox+10*S,oy+3*S,S,S*0.5);
  } else if(acc==='hat'){
    ctx.fillStyle='#2c3e50';
    ctx.fillRect(ox+2*S,oy,8*S,S);
    ctx.fillRect(ox+3*S,oy-S,6*S,S*2);
  } else if(acc==='headband'){
    ctx.fillStyle='#e74c3c';
    ctx.fillRect(ox+2*S,oy+2*S,8*S,S);
  } else if(acc==='halo'){
    ctx.save();
    ctx.strokeStyle='rgba(255,220,0,0.9)';
    ctx.lineWidth=S*0.6;
    ctx.beginPath();
    ctx.ellipse(ox+6*S, oy, 3.5*S, S*0.7, 0, 0, Math.PI*2);
    ctx.stroke();
    ctx.restore();
  } else if(acc==='horns'){
    ctx.fillStyle='#c0392b';
    ctx.fillRect(ox+3*S,oy-S*2,S,S*2);
    ctx.fillRect(ox+8*S,oy-S*2,S,S*2);
    ctx.fillRect(ox+3*S,oy-S*2,S*2,S);
    ctx.fillRect(ox+7*S,oy-S*2,S*2,S);
  } else if(acc==='cap'){
    ctx.fillStyle=tc;
    ctx.fillRect(ox+2*S,oy+S,8*S,S);
    ctx.fillRect(ox+3*S,oy-S,5*S,S*2);
    ctx.fillRect(ox+8*S,oy+S,3*S,S*0.5);
  }

  ctx.restore();
}

function drawRope(ts){
  ropeRAF = requestAnimationFrame(drawRope);
  ropeTime = ts * 0.001;
  const W=rc.width, H=rc.height;
  rCtx.clearRect(0,0,W,H);
  const pos = G.rope;
  const flagX = pos * W;
  const cy = H * 0.52;
  const segs = 60;
  const tension = Math.max(0,1-Math.abs(pos-0.5)*2);
  const sag = 18 * tension;

  // Pure catenary sag â€” no wave, no time-based oscillation
  function ry(t) {
    return cy + Math.sin(t*Math.PI)*sag;
  }

  // Decay animations
  if(charAnim.blue.lunge > 0) charAnim.blue.lunge = Math.max(0, charAnim.blue.lunge - 0.04);
  if(charAnim.blue.stumble > 0) charAnim.blue.stumble = Math.max(0, charAnim.blue.stumble - 0.04);
  if(charAnim.red.lunge > 0) charAnim.red.lunge = Math.max(0, charAnim.red.lunge - 0.04);
  if(charAnim.red.stumble > 0) charAnim.red.stumble = Math.max(0, charAnim.red.stumble - 0.04);

  // === DRAW CHARACTERS ON ROPE ===
  const bluePlayers = G.players ? G.players.filter(p=>p.team==='blue') : [];
  const redPlayers  = G.players ? G.players.filter(p=>p.team==='red')  : [];
  const charScale = Math.max(2, Math.min(4, Math.floor(H / 60)));

  // Character height in pixels
  const charH = 16 * charScale;
  // Feet sit on the rope line
  const ropeY = ry(0); // blue end rope Y
  const ropeYR = ry(1); // red end rope Y

  // Lunge offset: blue lunges right (+x), red lunges left (-x)
  const blueOffset = charAnim.blue.lunge * charScale * 8 - charAnim.blue.stumble * charScale * 5;
  const redOffset  = charAnim.red.lunge  * charScale * 8 - charAnim.red.stumble  * charScale * 5;

  // Blue team: stack from left edge, characters face right
  const blueSpacing = Math.min(charScale * 14, W * 0.12);
  bluePlayers.forEach((p, i) => {
    const bx = charScale * 8 + i * blueSpacing + blueOffset;
    const by = ry(bx/W) + charScale * 2; // feet on rope
    const streak = p.streak || 0;
    const streakLevel = streak >= 6 ? 3 : streak >= 4 ? 2 : streak >= 2 ? 1 : 0;
    drawCharOnRope(rCtx, p.avatar||{skin:0,hair:0,eyes:0,accessory:0}, '#1368ce', bx, by, charScale, 1, streakLevel);
  });

  // Red team: stack from right edge, characters face left
  const redSpacing = Math.min(charScale * 14, W * 0.12);
  redPlayers.forEach((p, i) => {
    const rx = W - charScale * 8 - i * redSpacing + redOffset;
    const ry2 = ry(rx/W) + charScale * 2;
    const streak = p.streak || 0;
    const streakLevel = streak >= 6 ? 3 : streak >= 4 ? 2 : streak >= 2 ? 1 : 0;
    drawCharOnRope(rCtx, p.avatar||{skin:2,hair:3,eyes:0,accessory:0}, '#e21b3c', rx, ry2, charScale, -1, streakLevel);
  });

  // === ROPE ===
  // Shadow
  rCtx.beginPath(); rCtx.moveTo(0,ry(0)+3);
  for(let i=1;i<=segs;i++) rCtx.lineTo(i/segs*W,ry(i/segs)+3);
  rCtx.strokeStyle='rgba(0,0,0,0.15)'; rCtx.lineWidth=10; rCtx.lineCap='round'; rCtx.stroke();

  // Rope gradient
  const grad = rCtx.createLinearGradient(0,0,W,0);
  grad.addColorStop(0,'#1368ce');
  grad.addColorStop(Math.max(0.02,pos-0.08),'#46a6ff');
  grad.addColorStop(pos,'#ffffff');
  grad.addColorStop(Math.min(0.98,pos+0.08),'#ff6b8a');
  grad.addColorStop(1,'#e21b3c');
  rCtx.beginPath(); rCtx.moveTo(0,ry(0));
  for(let i=1;i<=segs;i++) rCtx.lineTo(i/segs*W,ry(i/segs));
  rCtx.strokeStyle=grad; rCtx.lineWidth=8; rCtx.lineCap='round'; rCtx.stroke();

  // Flag
  const flagY=ry(pos);
  rCtx.beginPath(); rCtx.moveTo(flagX,flagY+2); rCtx.lineTo(flagX,flagY-44);
  rCtx.strokeStyle='rgba(255,255,255,0.95)'; rCtx.lineWidth=3; rCtx.stroke();
  const fc=pos<0.48?'#1368ce':pos>0.52?'#e21b3c':'#ffa602';
  rCtx.beginPath(); rCtx.moveTo(flagX,flagY-44); rCtx.lineTo(flagX+22,flagY-34); rCtx.lineTo(flagX,flagY-24); rCtx.closePath();
  rCtx.fillStyle=fc; rCtx.shadowColor=fc; rCtx.shadowBlur=15; rCtx.fill(); rCtx.shadowBlur=0;

  document.getElementById('ag-blue').style.width=(pos*100)+'%';
  document.getElementById('ag-red').style.width=((1-pos)*100)+'%';
}

let ropeAnimFrame = null;
function animateRopeTo(target, duration){
  if(ropeAnimFrame) cancelAnimationFrame(ropeAnimFrame);
  const start = G.rope;
  target = Math.max(0.04,Math.min(0.96,target));
  ropeTarget = target;
  const startTime = performance.now();
  function step(now){
    const t = Math.min(1,(now-startTime)/duration);
    const e = t===1?1:1-Math.pow(2,-10*t)*Math.cos(t*Math.PI*2.5/1.5);
    G.rope = start+(target-start)*e;
    if(t<1){
      ropeAnimFrame = requestAnimationFrame(step);
    } else {
      G.rope = target;
      ropeTarget = target; // ensure velMag = 0 exactly
    }
  }
  ropeAnimFrame = requestAnimationFrame(step);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCREEN NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  const lobbyScreens=['s-portal','s-host','s-join','s-pin','s-lineup'];
  const matchScreens=['s-game','s-round'];
  const endScreens=['s-victory','s-analytics','s-report'];
  if(lobbyScreens.includes(id)){
    if(typeof stopMatchMusic==='function') stopMatchMusic(1.0);
    if(typeof startLobbyMusic==='function'&&!_lobbyPlaying) startLobbyMusic();
  }
  if(matchScreens.includes(id)){
    if(typeof stopLobbyMusic==='function') stopLobbyMusic(0.8);
    if(typeof startMatchMusic==='function'&&!_matchPlaying) startMatchMusic();
  }
  if(endScreens.includes(id)){
    if(typeof stopLobbyMusic==='function') stopLobbyMusic(0.8);
    if(typeof stopMatchMusic==='function') stopMatchMusic(1.5);
  }
}
function showOverlay(show){ document.getElementById('overlay-connecting').classList.toggle('show',show); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ROOM SYNC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genCode(){ return Math.floor(1000+Math.random()*9000).toString(); }
function copyRoomCode(){
  const code = document.getElementById('room-code-display').textContent;
  if(code==='----') return;
  navigator.clipboard.writeText(code).then(()=>{
    const btn=document.getElementById('rcb-copy-btn');
    btn.textContent='COPIED!'; btn.style.background='var(--green-light)';
    setTimeout(()=>{ btn.textContent='COPY'; btn.style.background=''; },1800);
  }).catch(()=>{});
}
function getRoomKey(code){ return 'quizzo_room_'+code; }
function writeRoom(data){ try{localStorage.setItem(getRoomKey(ROOM_CODE),JSON.stringify(data));}catch(e){} sendMsg('room_update',{code:ROOM_CODE,data}); }
function readRoom(code){ try{const r=localStorage.getItem(getRoomKey(code));return r?JSON.parse(r):null;}catch(e){return null;} }
function clearRoom(code){ try{localStorage.removeItem(getRoomKey(code)); localStorage.removeItem('quizzo_lock_'+code);}catch(e){} }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HOST FLOW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lobbyPollInterval = null;

// Poll to update waiting bar â€” start button appears when both teams have players
function startLobbyPoll(){
  clearInterval(lobbyPollInterval);
  lobbyPollInterval = setInterval(()=>{
    const room = readRoom(ROOM_CODE);
    if(!room) return;
    const players = room.players||[];
    const blue = players.filter(p=>p.team==='blue').length;
    const red  = players.filter(p=>p.team==='red').length;
    const total = blue + red;
    const ready = total >= 2 && blue >= 1 && red >= 1;
    const wtEl = document.getElementById('waiting-text');
    const startBtn = document.getElementById('btn-start-host');
    if(wtEl){
      if(total === 0) wtEl.textContent = 'Share the room code â€” players join from their own tab.';
      else if(!ready) wtEl.textContent = `${total} player${total!==1?'s':''} joined â€” need at least 1 player on each team.`;
      else wtEl.textContent = `${total} player${total!==1?'s':''} ready Â· ${blue} Blue Â· ${red} Red â€” start when ready!`;
    }
    if(startBtn) startBtn.style.display = ready ? 'block' : 'none';
  }, 500);
}

function startHost(){
  ROLE='host'; MY_TEAM='none';
  ROOM_CODE=genCode();
  document.getElementById('room-code-display').textContent=ROOM_CODE;
  document.getElementById('role-badge').textContent='HOST Â· NEUTRAL';
  document.getElementById('role-badge').className='role-badge tag-purple';
  document.getElementById('role-badge').style.display='block';
  G.blueN=document.getElementById('inp-blue').value.trim().toUpperCase()||'APEX';
  G.redN=document.getElementById('inp-red').value.trim().toUpperCase()||'VORTEX';
  const roomData={status:'waiting',code:ROOM_CODE,blueN:G.blueN,redN:G.redN,players:[],ts:Date.now()};
  writeRoom(roomData);
  startLobbyPoll();
  showScreen('s-host');
}

function launchGame(){
  clearInterval(lobbyPollInterval);
  G.blueN=document.getElementById('inp-blue').value.trim().toUpperCase()||'APEX';
  G.redN=document.getElementById('inp-red').value.trim().toUpperCase()||'VORTEX';
  G.subject=document.getElementById('sel-subject').value;
  G.diff=document.getElementById('sel-diff').value;
  G.fmt=document.getElementById('sel-format').value;
  G.qcount=parseInt(document.getElementById('sel-qcount').value);
  G.totalR=G.fmt==='bo5'?5:G.fmt==='single'?1:3;
  G.toWin=Math.ceil(G.totalR/2);
  G.gameMode=GAME_MODE;
  G.timerMax=GAME_MODE==='class'?parseInt(document.getElementById('sel-timer').value)||30:20;
  G.streaksEnabled=GAME_MODE!=='class'||document.getElementById('sel-streaks').value!=='off';
  G.questionType=QUESTION_TYPE;
  const room=readRoom(ROOM_CODE)||{};
  // Preserve avatars from joined players
  G.players=(room.players||[]).map(p=>({...p,score:0,streak:0,mult:1,correct:0,answered:0,lastAns:null,avatar:p.avatar||{skin:0,hair:0,eyes:0,accessory:0}}));
  if(!G.players.length){
    G.players=[
      {id:'p1',name:G.blueN,team:'blue',score:0,streak:0,mult:1,correct:0,answered:0,lastAns:null,avatar:{skin:0,hair:0,eyes:2,accessory:1}},
      {id:'p2',name:G.redN,team:'red',score:0,streak:0,mult:1,correct:0,answered:0,lastAns:null,avatar:{skin:2,hair:3,eyes:0,accessory:3}}
    ];
  }
  G.blueScore=0; G.redScore=0; G.blueRoundScore=0; G.redRoundScore=0;
  G.roundWins={blue:0,red:0}; G.roundHistory=[]; G.questionLog=[];
  G.currentRound=1; G.currentQ=0;
  G.rope=0.5; ropeTarget=0.5; G.locked=false;
  G.blueAnswers={}; G.redAnswers={};
  G.questions=shufflePool();
  G.shuffleSeed = Date.now(); // Anti-cheat #6: log when questions were randomised
  console.info(`[Quizzo] Questions randomised at ${new Date(G.shuffleSeed).toLocaleTimeString()} â€” ${G.questions.length} questions loaded for ${G.subject}/${G.diff}`);
  // Write lineup state so clients show lineup screen
  writeRoom(buildRoomState('lineup'));
  // Host also shows lineup, then enters game with ready countdown
  showLineup(()=>{
    enterGame();
    const readyStart = Date.now() + BETWEEN_Q_DELAY;
    G.qStartTime = readyStart;
    const readyRoom = buildRoomState('ready');
    readyRoom.qStartTime = readyStart;
    writeRoom(readyRoom);
    showReadyOverlay(BETWEEN_Q_DELAY / 1000, `Q 1 of ${G.questions.length}`);
    function tickFirst(){
      const remaining = (readyStart - Date.now()) / 1000;
      const numEl = document.getElementById('ready-num');
      if(numEl) numEl.textContent = Math.max(0, Math.ceil(remaining));
      if(remaining <= 0){
        hideReadyOverlay();
        const room = buildRoomState('playing');
        room.qStartTime = readyStart;
        writeRoom(room);
        startTimer(true);
        return;
      }
      setTimeout(tickFirst, 200);
    }
    tickFirst();
  });
}

function buildRoomState(status){
  // Strip answer keys from questions for clients (anti-cheat: prevent console peeking)
  const safeQuestions = G.questions.map(q => {
    const {a, ...rest} = q;
    return rest; // clients never see q.a
  });
  return{
    status,code:ROOM_CODE,
    blueN:G.blueN,redN:G.redN,
    subject:G.subject,diff:G.diff,fmt:G.fmt,qcount:G.qcount,
    totalR:G.totalR,toWin:G.toWin,
    gameMode:G.gameMode,timerMax:G.timerMax,streaksEnabled:G.streaksEnabled,questionType:G.questionType||'abcd',
    players:G.players,questions:safeQuestions,
    currentQ:G.currentQ,currentRound:G.currentRound,
    blueScore:G.blueScore,redScore:G.redScore,
    blueRoundScore:G.blueRoundScore,redRoundScore:G.redRoundScore,
    roundWins:G.roundWins,roundHistory:G.roundHistory,
    questionLog:G.questionLog||[],
    rope:G.rope,locked:G.locked,
    blueAnswers:G.blueAnswers,redAnswers:G.redAnswers,
    qStartTime:G.qStartTime,
    ts:Date.now(),
  };
}

function applyRoomState(room){
  G.blueN=room.blueN;G.redN=room.redN;
  G.subject=room.subject;G.diff=room.diff;G.fmt=room.fmt;G.qcount=room.qcount;
  G.totalR=room.totalR;G.toWin=room.toWin;
  G.gameMode=room.gameMode||'speed';G.timerMax=room.timerMax||20;G.streaksEnabled=room.streaksEnabled!==false;G.questionType=room.questionType||'abcd';
  G.players=room.players||[];G.questions=room.questions||[];
  G.currentQ=room.currentQ||0;G.currentRound=room.currentRound||1;
  G.blueScore=room.blueScore||0;G.redScore=room.redScore||0;
  G.blueRoundScore=room.blueRoundScore||0;G.redRoundScore=room.redRoundScore||0;
  G.roundWins=room.roundWins||{blue:0,red:0};G.roundHistory=room.roundHistory||[];
  G.questionLog=room.questionLog||[];
  // NOTE: G.rope is NOT set here â€” clients animate via animateRopeTo(room.ropeAfter)
  // only on resolving state. Setting it here mid-animation causes jitter/waves.
  G.locked=room.locked||false;
  G.blueAnswers=room.blueAnswers||{};G.redAnswers=room.redAnswers||{};
  G.qStartTime=room.qStartTime||Date.now();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PIXEL AVATAR SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Palette options
const SKIN_COLORS=['#FDDBB4','#F5C28A','#E0965A','#C47038','#8D4A2A','#5C2D0E'];
const HAIR_COLORS=['#1a1a1a','#4a2c0a','#8B4513','#D2691E','#FFD700','#C0392B','#8E44AD','#2980B9','#E8E8E8','#FF69B4'];
const EYE_STYLES=['normal','happy','cool','sleepy','star'];
const ACCESSORIES=['none','crown','glasses','hat','headband','halo','horns','cap'];
const ACC_ICONS={'none':'âœ•','crown':'ğŸ‘‘','glasses':'ğŸ•¶','hat':'ğŸ©','headband':'ğŸ€','halo':'ğŸ˜‡','horns':'ğŸ˜ˆ','cap':'ğŸ§¢'};

let AV = { skin:0, hair:0, eyes:0, accessory:0 };

// Draw pixel character onto a canvas context
// size: pixel size of each "pixel block" (e.g. 4 = 4x4 real pixels per pixel)
function drawPixelChar(ctx, av, teamColor, size=4){
  const W=12, H=16; // pixel grid
  ctx.clearRect(0,0,W*size,H*size);

  const skin=SKIN_COLORS[av.skin]||SKIN_COLORS[0];
  const hair=HAIR_COLORS[av.hair]||HAIR_COLORS[0];
  const tc=teamColor||'#6633cc';

  function px(x,y,c){ ctx.fillStyle=c; ctx.fillRect(x*size,y*size,size,size); }

  // Body (team color shirt)
  for(let y=8;y<13;y++) for(let x=2;x<10;x++) px(x,y,tc);
  // Arms
  for(let y=8;y<12;y++){ px(1,y,tc); px(10,y,tc); }
  // Hands
  for(let y=11;y<13;y++){ px(0,y,skin); px(11,y,skin); }
  // Legs
  for(let y=13;y<16;y++){
    px(2,y,'#2c3e50'); px(3,y,'#2c3e50');
    px(8,y,'#2c3e50'); px(9,y,'#2c3e50');
  }
  // Shoes
  px(1,15,'#1a1a1a'); px(2,15,'#1a1a1a'); px(3,15,'#1a1a1a');
  px(8,15,'#1a1a1a'); px(9,15,'#1a1a1a'); px(10,15,'#1a1a1a');

  // Neck
  for(let y=6;y<8;y++) for(let x=4;x<8;x++) px(x,y,skin);
  // Head
  for(let y=1;y<7;y++) for(let x=2;x<10;x++) px(x,y,skin);

  // Hair
  const eyeStyle=EYE_STYLES[av.eyes]||'normal';
  // Hair top
  for(let x=2;x<10;x++) px(x,1,hair);
  for(let x=2;x<10;x++) px(x,0,hair);
  // Hair sides
  px(2,2,hair); px(2,3,hair); px(9,2,hair); px(9,3,hair);

  // Eyes
  if(eyeStyle==='normal'){ px(4,3,'#1a1a1a'); px(4,4,'#fff'); px(7,3,'#1a1a1a'); px(7,4,'#fff'); }
  else if(eyeStyle==='happy'){ px(4,3,'#1a1a1a'); px(5,4,'#1a1a1a'); px(7,3,'#1a1a1a'); px(6,4,'#1a1a1a'); }
  else if(eyeStyle==='cool'){ px(3,3,'#1a1a1a'); px(4,3,'#1a1a1a'); px(5,3,'#1a1a1a'); px(7,3,'#1a1a1a'); px(8,3,'#1a1a1a'); px(9,3,'#1a1a1a'); }
  else if(eyeStyle==='sleepy'){ px(4,3,'#1a1a1a'); px(5,3,'#1a1a1a'); px(7,3,'#1a1a1a'); px(8,3,'#1a1a1a'); }
  else if(eyeStyle==='star'){ px(4,3,'#FFD700'); px(5,2,'#FFD700'); px(6,3,'#FFD700'); px(5,4,'#FFD700'); px(3,3,'#FFD700'); px(7,3,'#FFD700'); px(8,2,'#FFD700'); px(9,3,'#FFD700'); px(8,4,'#FFD700'); }

  // Mouth (smile)
  px(4,5,'#1a1a1a'); px(7,5,'#1a1a1a'); px(5,6,'#1a1a1a'); px(6,6,'#1a1a1a');

  // Accessory
  const acc=ACCESSORIES[av.accessory]||'none';
  if(acc==='crown'){
    px(3,0,'#FFD700'); px(5,0,'#FFD700'); px(7,0,'#FFD700'); px(9,0,'#FFD700');
    for(let x=3;x<10;x++) px(x,-1<0?0:0,'#FFD700');
    ctx.fillStyle='#FFD700';
    ctx.fillRect(3*size,0,7*size,size);
    px(4,-1<0?0:1,'#FFD700'); px(6,0,'#FFD700'); px(8,0,'#FFD700');
    // spikes
    ctx.fillStyle='#FFD700';
    ctx.fillRect(3*size,0,size,size*2);
    ctx.fillRect(5*size,0,size,size*2);
    ctx.fillRect(7*size,0,size,size*2);
    ctx.fillRect(9*size,0,size,size*2);
    ctx.fillStyle='#FFD700';
    ctx.fillRect(3*size,size,7*size,size);
  } else if(acc==='glasses'){
    ctx.fillStyle='rgba(0,180,255,0.35)';
    ctx.fillRect(3*size,3*size,3*size,2*size);
    ctx.fillRect(7*size,3*size,3*size,2*size);
    ctx.fillStyle='#333'; ctx.fillRect(3*size,3*size,3*size,size/2);
    ctx.fillRect(7*size,3*size,3*size,size/2);
    ctx.fillRect(6*size,3*size,size,size/2);
    ctx.fillRect(2*size,3*size,size,size/2);
    ctx.fillRect(10*size,3*size,size,size/2);
  } else if(acc==='hat'){
    ctx.fillStyle='#2c3e50';
    ctx.fillRect(2*size,0,8*size,size);
    ctx.fillRect(3*size,-size,6*size,size*2);
  } else if(acc==='headband'){
    ctx.fillStyle='#e74c3c';
    ctx.fillRect(2*size,2*size,8*size,size);
  } else if(acc==='halo'){
    ctx.fillStyle='rgba(255,220,0,0.7)';
    ctx.beginPath(); ctx.ellipse(6*size, size*0.5, 3.5*size, size*0.6, 0, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle='rgba(255,220,0,0.9)';
    ctx.beginPath(); ctx.ellipse(6*size, size*0.5, 3.5*size, size*0.6, 0, 0, Math.PI*2); ctx.stroke();
  } else if(acc==='horns'){
    ctx.fillStyle='#c0392b';
    ctx.fillRect(3*size,0,size,size*2);
    ctx.fillRect(8*size,0,size,size*2);
    ctx.fillRect(3*size,0,size*2,size);
    ctx.fillRect(7*size,0,size*2,size);
  } else if(acc==='cap'){
    ctx.fillStyle=tc;
    ctx.fillRect(2*size,size,8*size,size);
    ctx.fillRect(3*size,0,5*size,size*2);
    ctx.fillRect(8*size,size,3*size,size/2);
  }
}

function renderAvatarPreview(){
  const canvas=document.getElementById('ab-canvas');
  if(!canvas) return;
  const ctx=canvas.getContext('2d');
  const teamColor=joinTeamChoice==='blue'?'#1368ce':'#e21b3c';
  drawPixelChar(ctx,AV,teamColor,4);
}

function buildAvatarUI(){
  // Skin swatches
  const skinsEl=document.getElementById('ab-skins');
  if(skinsEl){
    skinsEl.style.cssText='display:flex;gap:6px;flex-wrap:wrap;';
    skinsEl.innerHTML='';
    SKIN_COLORS.forEach((c,i)=>{
      const d=document.createElement('div');
      d.className='ab-swatch'+(i===AV.skin?' sel':'');
      d.style.background=c; d.title='Skin '+i;
      d.onclick=()=>{ AV.skin=i; skinsEl.querySelectorAll('.ab-swatch').forEach((s,j)=>s.classList.toggle('sel',j===i)); renderAvatarPreview(); };
      skinsEl.appendChild(d);
    });
  }
  // Hair swatches
  const hairEl=document.getElementById('ab-hairs');
  if(hairEl){
    hairEl.innerHTML='';
    HAIR_COLORS.forEach((c,i)=>{
      const d=document.createElement('div');
      d.className='ab-swatch'+(i===AV.hair?' sel':'');
      d.style.background=c; d.title='Hair '+i;
      d.onclick=()=>{ AV.hair=i; hairEl.querySelectorAll('.ab-swatch').forEach((s,j)=>s.classList.toggle('sel',j===i)); renderAvatarPreview(); };
      hairEl.appendChild(d);
    });
  }
  // Eye styles
  const eyeEl=document.getElementById('ab-eyes');
  const EYE_LABELS=['ğŸ˜','ğŸ˜„','ğŸ˜','ğŸ˜´','â­'];
  if(eyeEl){
    eyeEl.innerHTML='';
    EYE_STYLES.forEach((s,i)=>{
      const d=document.createElement('div');
      d.className='ab-icon-opt'+(i===AV.eyes?' sel':'');
      d.textContent=EYE_LABELS[i]; d.title=s;
      d.onclick=()=>{ AV.eyes=i; eyeEl.querySelectorAll('.ab-icon-opt').forEach((b,j)=>b.classList.toggle('sel',j===i)); renderAvatarPreview(); };
      eyeEl.appendChild(d);
    });
  }
  // Accessories
  const accEl=document.getElementById('ab-accessories');
  if(accEl){
    accEl.innerHTML='';
    ACCESSORIES.forEach((a,i)=>{
      const d=document.createElement('div');
      d.className='ab-icon-opt'+(i===AV.accessory?' sel':'');
      d.textContent=ACC_ICONS[a]||a; d.title=a;
      d.onclick=()=>{ AV.accessory=i; accEl.querySelectorAll('.ab-icon-opt').forEach((b,j)=>b.classList.toggle('sel',j===i)); renderAvatarPreview(); };
      accEl.appendChild(d);
    });
  }
  renderAvatarPreview();
}

function randomizeAvatar(){
  AV.skin=Math.floor(Math.random()*SKIN_COLORS.length);
  AV.hair=Math.floor(Math.random()*HAIR_COLORS.length);
  AV.eyes=Math.floor(Math.random()*EYE_STYLES.length);
  AV.accessory=Math.floor(Math.random()*ACCESSORIES.length);
  buildAvatarUI();
}

// Update avatar builder preview when team changes
function updateAvatarTeamTag(){
  const tag=document.getElementById('ab-team-tag');
  if(!tag) return;
  tag.className='ab-team-tag '+(joinTeamChoice==='blue'?'ab-team-blue':'ab-team-red');
  tag.textContent=(joinTeamChoice==='blue'?'BLUE':'RED')+' TEAM';
  renderAvatarPreview();
}
function updateAvatarNameTag(){
  const tag=document.getElementById('ab-name-tag');
  const raw=document.getElementById('inp-join-name')?.value.trim().toUpperCase();
  if(tag) tag.textContent=raw||(joinTeamChoice==='blue'?'BLUE PLAYER':'RED PLAYER');
}

// Draw a player avatar on a new canvas element for lineup
function makeLineupCanvas(av, teamColor, scale=3){
  const canvas=document.createElement('canvas');
  canvas.width=12*scale; canvas.height=16*scale;
  canvas.style.width=(12*scale)+'px'; canvas.style.height=(16*scale)+'px';
  canvas.style.imageRendering='pixelated';
  const ctx=canvas.getContext('2d');
  drawPixelChar(ctx,av,teamColor,scale);
  return canvas;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LINEUP SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showLineup(onDone){
  showScreen('s-lineup');
  const blueLabel=document.getElementById('lineup-blue-label');
  const redLabel=document.getElementById('lineup-red-label');
  if(blueLabel) blueLabel.textContent=G.blueN+' (BLUE)';
  if(redLabel) redLabel.textContent=G.redN+' (RED)';

  const blueEl=document.getElementById('lineup-blue-players');
  const redEl=document.getElementById('lineup-red-players');
  blueEl.innerHTML=''; redEl.innerHTML='';

  const blue=G.players.filter(p=>p.team==='blue');
  const red=G.players.filter(p=>p.team==='red');

  function renderTeam(players, container, teamColor, delay){
    players.forEach((p,i)=>{
      const av=p.avatar||{skin:0,hair:0,eyes:0,accessory:0};
      const wrap=document.createElement('div');
      wrap.className='lineup-player';
      wrap.style.animationDelay=(delay+i*120)+'ms';
      const canvasWrap=document.createElement('div');
      canvasWrap.className='lineup-avatar-wrap '+(p.team==='blue'?'blue-border':'red-border');
      canvasWrap.appendChild(makeLineupCanvas(av,teamColor,4));
      const name=document.createElement('div');
      name.className='lineup-pname';
      name.textContent=p.name;
      wrap.appendChild(canvasWrap); wrap.appendChild(name);
      container.appendChild(wrap);
    });
  }

  renderTeam(blue, blueEl, '#1368ce', 0);
  renderTeam(red, redEl, '#e21b3c', 200);

  // Countdown 3â€¦2â€¦1â€¦GO!
  const cd=document.getElementById('lineup-countdown');
  let n=3;
  cd.textContent=n; SFX.countdown();
  const tick=setInterval(()=>{
    n--;
    if(n>0){ cd.textContent=n; SFX.countdown(); }
    else if(n===0){
      cd.className='lineup-go'; cd.textContent='GO!';
      SFX.go();
      clearInterval(tick);
      setTimeout(onDone, 600);
    }
  },1000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CLIENT FLOW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let joinTeamChoice='blue';
document.getElementById('team-opt-blue').addEventListener('click',()=>{
  joinTeamChoice='blue';
  document.getElementById('team-opt-blue').classList.add('selected');
  document.getElementById('team-opt-red').classList.remove('selected');
  updateAvatarTeamTag();
});
document.getElementById('team-opt-red').addEventListener('click',()=>{
  joinTeamChoice='red';
  document.getElementById('team-opt-red').classList.add('selected');
  document.getElementById('team-opt-blue').classList.remove('selected');
  updateAvatarTeamTag();
});
document.getElementById('inp-join-name')?.addEventListener('input', e=>{
  updateAvatarNameTag();
  const hasName = e.target.value.trim().length > 0;
  const joinBtn = document.getElementById('btn-join');
  if(joinBtn) joinBtn.disabled = !hasName;
  if(hasName){
    e.target.style.borderColor='';
    e.target.style.boxShadow='';
    const err=document.getElementById('join-error');
    if(err) err.classList.remove('show');
  }
});

// Init avatar builder on page load
buildAvatarUI();

function joinRoom(){
  const code=document.getElementById('code-input').value.trim().toUpperCase();
  const rawName=document.getElementById('inp-join-name').value.trim().toUpperCase();
  const nameInput=document.getElementById('inp-join-name');
  const err=document.getElementById('join-error');
  if(!rawName){
    err.textContent='Please enter your name before joining.';
    err.classList.add('show');
    nameInput.focus();
    nameInput.style.borderColor='var(--red)';
    nameInput.style.boxShadow='0 0 0 3px rgba(226,27,60,0.15)';
    return;
  }
  nameInput.style.borderColor='';
  nameInput.style.boxShadow='';
  if(code.length!==4){err.textContent='Enter a 4-digit room code.';err.classList.add('show');return;}
  err.classList.remove('show');
  MY_NAME=rawName; MY_TEAM=joinTeamChoice;

  // Anti-cheat #3: use persistent BROWSER_PID so same tab can't join twice
  // and refreshing reconnects to the same player slot
  const pid = BROWSER_PID;
  const playerEntry={id:pid,name:MY_NAME,team:MY_TEAM,score:0,streak:0,mult:1,correct:0,answered:0,lastAns:null,avatar:{...AV}};

  showOverlay(true);
  document.getElementById('co-text').textContent='SEARCHING FOR ROOM '+code+'...';

  let attempts=0;
  const tryJoin=setInterval(()=>{
    attempts++;

    // Check room exists and is joinable
    const room=readRoom(code);
    if(!room){
      if(attempts>30){ clearInterval(tryJoin); showOverlay(false); err.textContent='Room "'+code+'" not found. Check the code and try again.'; err.classList.add('show'); }
      return;
    }

    // Room in a game state â€” can't join
    if(['lineup','playing','ready','resolving','round_end','match_end'].includes(room.status)){
      clearInterval(tryJoin); showOverlay(false);
      err.textContent='Match already started. Ask the host to start a new game.'; err.classList.add('show');
      return;
    }

    // Room is open ('waiting' or 'joined_notify') â€” try to acquire write lock
    const lockKey='quizzo_lock_'+code;
    const myLock=pid+'_'+Date.now();
    try{ localStorage.setItem(lockKey, myLock); } catch(e){}

    // Small delay then check if we won the lock (handles simultaneous joins)
    setTimeout(()=>{
      const currentLock=localStorage.getItem(lockKey);
      // If someone else grabbed the lock at the exact same ms, retry next tick
      if(currentLock!==myLock){ return; }

      // We have the lock â€” do the write
      const fresh=readRoom(code);
      if(!fresh||['lineup','playing','ready','resolving','round_end','match_end'].includes(fresh.status)){
        try{ localStorage.removeItem(lockKey); }catch(e){}
        clearInterval(tryJoin); showOverlay(false);
        if(fresh) { err.textContent='Match already started.'; err.classList.add('show'); }
        return;
      }

      // Anti-cheat #3: Reject if this BROWSER_PID already joined on a DIFFERENT team
      const players=[...(fresh.players||[])];
      const existingPlayer=players.find(p=>p.id===pid);
      if(existingPlayer && existingPlayer.team!==MY_TEAM){
        try{ localStorage.removeItem(lockKey); }catch(e){}
        clearInterval(tryJoin); showOverlay(false);
        err.textContent='âš  This browser is already on the '+existingPlayer.team.toUpperCase()+' team. Use a private/incognito window to join a second team.';
        err.classList.add('show');
        return;
      }
      if(!players.find(p=>p.id===pid)) players.push(playerEntry);
      fresh.players=players;
      fresh.status='waiting'; // always keep 'waiting' so others can join
      fresh.ts=Date.now();
      // Set ROOM_CODE BEFORE writeRoom (writeRoom uses global ROOM_CODE)
      ROOM_CODE=code; ROLE='client';
      writeRoom(fresh);

      // Release lock after a short window
      setTimeout(()=>{ try{ if(localStorage.getItem(lockKey)===myLock) localStorage.removeItem(lockKey); }catch(e){} }, 150);

      // Successfully joined
      clearInterval(tryJoin);
      document.getElementById('role-badge').textContent=MY_TEAM==='blue'?'PLAYER Â· BLUE':'PLAYER Â· RED';
      document.getElementById('role-badge').className=`role-badge tag-${MY_TEAM}`;
      document.getElementById('role-badge').style.display='block';
      sendMsg('client_joined',{code,name:MY_NAME,team:MY_TEAM,pid});

      showOverlay(true);
      document.getElementById('co-text').textContent='âœ“ JOINED! Waiting for host to start...';

      // Wait for host to launch
      const waitPoll=setInterval(()=>{
        const r=readRoom(ROOM_CODE);
        if(!r) return;
        const total=(r.players||[]).length;
        const blue=r.players.filter(p=>p.team==='blue').length;
        const red=r.players.filter(p=>p.team==='red').length;
        if(r.status==='waiting'||r.status==='joined_notify'){
          document.getElementById('co-text').textContent=
            `LOBBY Â· ${blue} Blue Â· ${red} Red Â· ${total} player${total!==1?'s':''} Â· waiting for host...`;
          return;
        }
        if(r.status==='lineup'){
          clearInterval(waitPoll); showOverlay(false);
          applyRoomState(r);
          showLineup(()=>{ enterGame(); listenAsClient(); });
        } else if(r.status==='playing'){
          clearInterval(waitPoll); showOverlay(false);
          applyRoomState(r); enterGame(); listenAsClient();
        }
      },300);
    }, 60); // 60ms lock window

  },300);
}

let clientLastTs=0;
let clientPrevQ=-1, clientPrevRound=-1;

function listenAsClient(){
  const poll=setInterval(()=>{
    const r=readRoom(ROOM_CODE);
    if(r&&r.ts>clientLastTs){ clientLastTs=r.ts; handleClientUpdate(r); }
  },150);
  onMsg(msg=>{
    if(msg.type==='room_update'&&msg.data.code===ROOM_CODE){
      const d=msg.data.data;
      if(d&&d.ts>clientLastTs){ clientLastTs=d.ts; handleClientUpdate(d); }
    }
    // Lock options only when HOST confirms a correct answer was submitted
    if(msg.type==='speed_correct'&&msg.data.code===ROOM_CODE&&G.gameMode==='speed'){
      if(msg.data.qIdx===G.currentQ&&msg.data.round===G.currentRound){
        document.querySelectorAll('.opt:not(.selected-blue):not(.selected-red)').forEach(b=>{
          b.disabled=true; b.style.opacity='0.45';
        });
        const aiEl = document.getElementById('ai-'+msg.data.team);
        if(aiEl){ aiEl.classList.add('answered',msg.data.team); }
      }
    }
  });
}

function handleClientUpdate(room){
  if(room.status==='lineup'){
    applyRoomState(room);
    showLineup(()=>{ enterGame(); });
  } else if(room.status==='ready'){
    applyRoomState(room);
    const screenActive = document.getElementById('s-game').classList.contains('active');
    if(!screenActive){ enterGame(); }
    renderQuestion(); updateBattleUI();
    document.querySelectorAll('.opt').forEach(b=>{ b.disabled=true; b.style.opacity='0.4'; });
    const readyStart = room.qStartTime;
    const initialRemaining = (readyStart - Date.now()) / 1000;
    const label = room.readyLabel || `Q ${(room.currentQ||0) + 1} of ${room.questions?.length || '?'}`;

    // If readyStart already passed (client polled late), unlock immediately
    if(initialRemaining <= 0){
      document.querySelectorAll('.opt').forEach(b=>{ b.disabled=false; b.style.opacity=''; });
      G.qStartTime = readyStart;
      syncClientTimer();
      return;
    }

    showReadyOverlay(initialRemaining, label);
    const myGen = (window._clientReadyGen = (window._clientReadyGen||0) + 1);
    function clientTickReady(){
      if(window._clientReadyGen !== myGen) return;
      const remaining = (readyStart - Date.now()) / 1000;
      const numEl = document.getElementById('ready-num');
      if(numEl) numEl.textContent = Math.max(0, Math.ceil(remaining));
      if(remaining <= 0){
        window._clientReadyGen++;
        hideReadyOverlay();
        document.querySelectorAll('.opt').forEach(b=>{ b.disabled=false; b.style.opacity=''; });
        G.qStartTime = readyStart;
        syncClientTimer();
        return;
      }
      setTimeout(clientTickReady, 200);
    }
    clientTickReady();
  } else if(room.status==='playing'){
    const prevQ=clientPrevQ, prevR=clientPrevRound;
    applyRoomState(room);
    // Always cancel ready tick and clean up overlay when playing state arrives
    window._clientReadyGen = (window._clientReadyGen||0) + 1;
    hideReadyOverlay();
    document.querySelectorAll('.opt').forEach(b=>{ b.disabled=false; b.style.opacity=''; });
    const screenChanged = !document.getElementById('s-game').classList.contains('active');
    if(screenChanged){
      clientPrevQ=room.currentQ; clientPrevRound=room.currentRound;
      enterGame(); syncClientTimer();
    } else if(room.currentQ!==prevQ||room.currentRound!==prevR){
      clientPrevQ=room.currentQ; clientPrevRound=room.currentRound;
      renderQuestion(); updateBattleUI(); syncClientTimer();
    } else { updateBattleUI(); updateAnswerStatus(); }
  } else if(room.status==='resolving'){
    applyRoomState(room);
    revealAnswers(room.resolvedCorrect,room.resolvedBlueAnswers,room.resolvedRedAnswers);
    updateBattleUI();
    if(room.ropeAfter!==undefined) animateRopeTo(room.ropeAfter,520);
    // Mirror character animations for clients
    const bCorrect=Object.values(room.resolvedBlueAnswers||{}).some(a=>a.idx===room.resolvedCorrect);
    const rCorrect=Object.values(room.resolvedRedAnswers||{}).some(a=>a.idx===room.resolvedCorrect);
    if(bCorrect&&!rCorrect){ triggerLunge('blue'); triggerStumble('red'); }
    else if(rCorrect&&!bCorrect){ triggerLunge('red'); triggerStumble('blue'); }
    else if(bCorrect&&rCorrect){ triggerLunge('blue'); triggerLunge('red'); }
    // Play sound based on MY team's result (personalised feedback)
    const myTeamCorrect = MY_TEAM==='blue' ? bCorrect : MY_TEAM==='red' ? rCorrect : (bCorrect||rCorrect);
    const myTeamAnswered = MY_TEAM==='blue'
      ? Object.keys(room.resolvedBlueAnswers||{}).length>0
      : MY_TEAM==='red'
        ? Object.keys(room.resolvedRedAnswers||{}).length>0
        : true;
    if(bCorrect&&rCorrect)     SFX.bothCorrect();
    else if(myTeamCorrect)     { SFX.correct(); SFX.pull(); }
    else if(myTeamAnswered)    SFX.wrongReveal();
    else                       SFX.noAnswer();
  } else if(room.status==='round_end'){
    applyRoomState(room); showRoundResult(room.roundWinner,room.roundHow);
  } else if(room.status==='match_end'){
    applyRoomState(room); showVictory(room.matchWinner);
  } else if(room.status==='rematch'){
    applyRoomState(room); enterGame();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ENTER GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function enterGame(){
  showScreen('s-game');
  resizeRope();
  if(ropeRAF) cancelAnimationFrame(ropeRAF);
  // Reset rope to settled center â€” no animation, no wave
  if(ROLE!=='host'){
    G.rope=0.5; ropeTarget=0.5;
  }
  drawRope(0);
  document.getElementById('tb-name-blue').textContent=G.blueN;
  document.getElementById('tb-name-red').textContent=G.redN;
  document.getElementById('av-blue').textContent=G.blueN[0]||'B';
  document.getElementById('av-red').textContent=G.redN[0]||'R';
  // Player counts
  const bluePlayers=G.players.filter(p=>p.team==='blue');
  const redPlayers=G.players.filter(p=>p.team==='red');
  const blueCount=bluePlayers.length, redCount=redPlayers.length;
  document.getElementById('blue-player-count').textContent=blueCount>1?blueCount+' players':'';
  document.getElementById('red-player-count').textContent=redCount>1?redCount+' players':'';
  // My role tag
  let myTag;
  if(ROLE==='host') myTag='TEACHER Â· WATCHING';
  else if(MY_TEAM==='blue') myTag=`â—€ YOU â€” ${MY_NAME} (BLUE)`;
  else myTag=`YOU â€” ${MY_NAME} (RED) â–¶`;
  document.getElementById('my-role-tag').textContent=myTag;
  document.getElementById('my-role-tag').className=ROLE==='host'?'chip chip-gold':`chip chip-${MY_TEAM}`;
  document.getElementById('my-role-tag').style.display='';
  document.getElementById('host-ctrl-strip').classList.toggle('visible',ROLE==='host');
  // Show powerup bar only for players, reset powerups on new game entry
  const puBar=document.getElementById('powerup-bar');
  if(puBar){
    puBar.style.display=ROLE==='host'?'none':'flex';
    if(ROLE!=='host'){ myPowerups={shield:0,double:0,freeze:0}; renderPowerupBar(); }
  }
  document.getElementById('bbc-format').textContent=G.fmt==='bo5'?'BEST OF 5':G.fmt==='single'?'SINGLE ROUND':'BEST OF 3';
  document.getElementById('ai-blue-text').textContent=G.blueN.toUpperCase()+' TEAM';
  document.getElementById('ai-red-text').textContent=G.redN.toUpperCase()+' TEAM';
  G.blueAnswers={}; G.redAnswers={};
  // Clear any stale per-player answer keys from localStorage
  if(ROOM_CODE){ try{ const toRemove=[];for(let i=0;i<localStorage.length;i++){const k=localStorage.key(i);if(k&&(k.startsWith('quizzo_ans_'+ROOM_CODE+'_')||k.startsWith('quizzo_speed_'+ROOM_CODE+'_')))toRemove.push(k);}toRemove.forEach(k=>localStorage.removeItem(k));}catch(e){} }
  updateBattleUI();
  renderQuestion();
  if(ROLE==='host') startTimer();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  QUESTION RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const KEYS=['A','B','C','D'];
const SUBJ_TAG_COLORS={math:'chip-blue',physics:'chip-purple',chemistry:'chip-green',biology:'chip-green',cs:'chip-gold',economics:'chip-gold',history:'chip-red',literature:'chip-red'};

function shufflePool(){
  const subj=G.subject||'math';
  let bank=[...(customBanks[subj]||QB[subj]||QB.math)];
  if(G.diff&&G.diff!=='mixed') bank=bank.filter(q=>q.d===G.diff);
  if(!bank.length) bank=[...(QB[subj]||QB.math)];
  for(let i=bank.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[bank[i],bank[j]]=[bank[j],bank[i]];}
  bank=bank.slice(0,G.qcount||8);

  // True/False mode â€” convert each question
  if(G.questionType==='tf'){
    bank=bank.map(q=>{
      const correctOpt=q.o[q.a]; // the correct answer text
      // Randomly decide if "True" = correct or incorrect
      const trueIsCorrect=Math.random()<0.5;
      const statement=trueIsCorrect
        ? `${q.q}\n\nâœ… "${correctOpt}" is the correct answer.`
        : `${q.q}\n\nâŒ "${q.o[(q.a+1)%q.o.length]}" is the correct answer.`;
      return {
        q: statement,
        o: ['TRUE','FALSE'],
        a: trueIsCorrect ? 0 : 1,
        d: q.d,
        explanation: q.explanation||''
      };
    });
  }
  return bank;
}

function renderQuestion(){
  const q=G.questions[G.currentQ];
  if(!q) return;
  document.getElementById('q-text').textContent=q.q;
  document.getElementById('q-info').textContent=`Q ${G.currentQ+1}/${G.questions.length} Â· ROUND ${G.currentRound}`;
  const db=document.getElementById('diff-badge');
  db.textContent=q.d.toUpperCase(); db.className='diff-badge '+q.d;
  const stag=document.getElementById('subject-tag-small');
  stag.textContent=SUBJ_SHORT[G.subject]||G.subject.toUpperCase();
  stag.className='chip '+(SUBJ_TAG_COLORS[G.subject]||'chip-purple');
  // Mode tag on question card
  const qcard=document.querySelector('.question-card');
  let stEl=qcard.querySelector('.speed-mode-tag');
  if(G.gameMode==='speed'){
    if(!stEl){stEl=document.createElement('div');stEl.className='speed-mode-tag';stEl.textContent='âš¡ FIRST CORRECT';qcard.appendChild(stEl);}
    else { stEl.textContent='âš¡ FIRST CORRECT'; }
  } else {
    if(!stEl){stEl=document.createElement('div');stEl.className='speed-mode-tag';stEl.style.background='linear-gradient(90deg,var(--blue),#2980b9)';stEl.textContent='ğŸ« CLASS';qcard.appendChild(stEl);}
    else { stEl.textContent='ğŸ« CLASS'; stEl.style.background='linear-gradient(90deg,var(--blue),#2980b9)'; }
  }
  const grid=document.getElementById('opts-grid');
  grid.innerHTML='';
  const isTF = G.questionType==='tf';
  grid.className = isTF ? 'options-grid tf-mode' : 'options-grid';
  q.o.forEach((opt,i)=>{
    const btn=document.createElement('button');
    if(ROLE==='host'){
      btn.className='opt opt-neutral'; btn.disabled=true;
    } else {
      btn.className='opt'; btn.dataset.idx=i;
      btn.addEventListener('click',()=>{ SFX.click(); submitAnswer(i); });
    }
    if(isTF){
      btn.classList.add(i===0?'tf-true':'tf-false');
      btn.innerHTML=`<span class="opt-text">${i===0?'âœ“ TRUE':'âœ— FALSE'}</span>`;
    } else {
      btn.innerHTML=`<span class="opt-key">${KEYS[i]}</span><span class="opt-text">${opt}</span>`;
    }
    grid.appendChild(btn);
  });
  G.blueAnswers={}; G.redAnswers={};
  if(ROOM_CODE){try{const t=[];for(let i=0;i<localStorage.length;i++){const k=localStorage.key(i);if(k&&(k.startsWith('quizzo_ans_'+ROOM_CODE+'_')||k.startsWith('quizzo_speed_'+ROOM_CODE+'_')))t.push(k);}t.forEach(k=>localStorage.removeItem(k));}catch(e){}}
  updateAnswerStatus();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ANSWERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function submitAnswer(idx){
  if(ROLE==='host'||G.locked) return;
  const myAnswers=MY_TEAM==='blue'?G.blueAnswers:G.redAnswers;
  const myPlayer=G.players.find(p=>p.name===MY_NAME&&p.team===MY_TEAM);
  const pid=myPlayer?myPlayer.id:MY_TEAM+'_default';
  if(myAnswers[pid]!==undefined) return;
  const elapsed=(Date.now()-G.qStartTime)/1000;
  const ans={idx,elapsed};
  if(MY_TEAM==='blue') G.blueAnswers[pid]=ans;
  else G.redAnswers[pid]=ans;
  document.querySelectorAll('.opt').forEach((b,i)=>{
    if(i===idx) b.classList.add('selected-'+MY_TEAM);
    b.disabled=true;
  });
  SFX.submit();
  updateAnswerStatus();
  const ansKey='quizzo_ans_'+ROOM_CODE+'_'+pid;
  try { localStorage.setItem(ansKey,JSON.stringify({team:MY_TEAM,pid,ans,qIdx:G.currentQ,round:G.currentRound,ts:Date.now()})); } catch(e){}
  sendMsg('answer',{code:ROOM_CODE,team:MY_TEAM,pid,ans,qIdx:G.currentQ,round:G.currentRound});
  // Note: in First Correct mode, only the HOST locks options â€” only after verifying the answer is correct
}

function updateAnswerStatus(){
  const blueAnswered=Object.keys(G.blueAnswers).length;
  const redAnswered=Object.keys(G.redAnswers).length;
  const blueTotal=G.players.filter(p=>p.team==='blue').length||1;
  const redTotal=G.players.filter(p=>p.team==='red').length||1;
  const aiB=document.getElementById('ai-blue');
  const aiR=document.getElementById('ai-red');
  const isClass=G.gameMode==='class';

  if(blueAnswered>0){
    aiB.className='ans-indicator answered blue';
    document.getElementById('ai-blue-text').textContent=
      isClass ? `${blueAnswered}/${blueTotal} ${G.blueN} answered` : `âš¡ ${G.blueN} buzzed in!`;
  } else {
    aiB.className='ans-indicator';
    document.getElementById('ai-blue-text').textContent=
      isClass ? `${G.blueN} â€” waiting (${blueTotal} players)` : `${G.blueN} â€” buzzing in...`;
  }

  if(redAnswered>0){
    aiR.className='ans-indicator answered red';
    document.getElementById('ai-red-text').textContent=
      isClass ? `${redAnswered}/${redTotal} ${G.redN} answered` : `âš¡ ${G.redN} buzzed in!`;
  } else {
    aiR.className='ans-indicator';
    document.getElementById('ai-red-text').textContent=
      isClass ? `${G.redN} â€” waiting (${redTotal} players)` : `${G.redN} â€” buzzing in...`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TIMER (HOST)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let answerPoll=null;

function startTimer(useExistingStart){
  clearInterval(G.timerID);
  // Only reset qStartTime if not already set by the ready-phase countdown
  if(!useExistingStart) G.qStartTime = Date.now();
  watchClientAnswers();

  // Use wall-clock for accuracy â€” no drifting counter
  function tickTimer(){
    const elapsed=(Date.now()-G.qStartTime)/1000;
    const remaining=Math.max(0,G.timerMax-elapsed);
    const pct=remaining/G.timerMax*100;
    const tn=document.getElementById('timer-num');
    const tf=document.getElementById('timer-bar-fill');
    const tr=document.getElementById('timer-row');
    if(!tn||!tf) return;
    tn.textContent=Math.ceil(remaining);
    tf.style.width=pct+'%';
    if(remaining<=5){tn.className='timer-num danger';tf.style.background='var(--red)';if(tr)tr.style.background='#fff5f5';}
    else if(remaining<=8){tn.className='timer-num warn';tf.style.background='var(--gold)';if(tr)tr.style.background='#fffbf0';}
    else{tn.className='timer-num safe';tf.style.background='var(--blue)';if(tr)tr.style.background='#fff';}
    maybeSfxTick(remaining);
    if(remaining<=0){
      clearInterval(G.timerID);
      clearInterval(answerPoll);
      resolveQ();
      return;
    }
  }
  tickTimer();
  G.timerID=setInterval(tickTimer,100);
}

function syncClientTimer(){
  // Clients also use wall-clock â€” stays perfectly in sync with host
  if(!G.qStartTime) return;
  let rafId=null;
  function tick(){
    const elapsed=(Date.now()-G.qStartTime)/1000;
    const remaining=Math.max(0,G.timerMax-elapsed);
    const pct=remaining/G.timerMax*100;
    const tn=document.getElementById('timer-num');
    const tf=document.getElementById('timer-bar-fill');
    const tr=document.getElementById('timer-row');
    if(!tn||!tf){ cancelAnimationFrame(rafId); return; }
    tn.textContent=Math.ceil(remaining);
    tf.style.width=pct+'%';
    if(remaining<=5){tn.className='timer-num danger';tf.style.background='var(--red)';if(tr)tr.style.background='#fff5f5';}
    else if(remaining<=8){tn.className='timer-num warn';tf.style.background='var(--gold)';if(tr)tr.style.background='#fffbf0';}
    else{tn.className='timer-num safe';tf.style.background='var(--blue)';if(tr)tr.style.background='#fff';}
    maybeSfxTick(remaining);
    if(remaining>0) rafId=requestAnimationFrame(tick);
  }
  rafId=requestAnimationFrame(tick);
}

function watchClientAnswers(){
  clearInterval(answerPoll);
  if(ROLE!=='host') return; // only host drives resolution

  answerPoll=setInterval(()=>{
    if(G.locked){ clearInterval(answerPoll); return; }

    const prefix='quizzo_ans_'+ROOM_CODE+'_';
    let newAnswer=false;

    // Scan localStorage for per-player answer keys written by same-browser players
    try {
      for(let i=0;i<localStorage.length;i++){
        const key=localStorage.key(i);
        if(!key||!key.startsWith(prefix)) continue;
        const raw=localStorage.getItem(key); if(!raw) continue;
        const p=JSON.parse(raw);
        if(p.qIdx!==G.currentQ||p.round!==G.currentRound) continue;
        const bucket=p.team==='blue'?G.blueAnswers:G.redAnswers;
        if(bucket[p.pid]===undefined){
          bucket[p.pid]=p.ans;
          localStorage.removeItem(key); i--; newAnswer=true;
        }
      }
    } catch(e){}

    if(newAnswer) updateAnswerStatus();

    const bluePlayers=G.players.filter(p=>p.team==='blue');
    const redPlayers=G.players.filter(p=>p.team==='red');
    const q=G.questions[G.currentQ];
    if(!q) return;

    if(G.gameMode==='speed'){
      const blueCorrect=bluePlayers.some(p=>G.blueAnswers[p.id]?.idx===q.a);
      const redCorrect=redPlayers.some(p=>G.redAnswers[p.id]?.idx===q.a);
      if((blueCorrect||redCorrect)&&!G.locked){
        const correctTeam=blueCorrect?'blue':'red';
        sendMsg('speed_correct',{code:ROOM_CODE,team:correctTeam,qIdx:G.currentQ,round:G.currentRound});
        clearInterval(answerPoll); setTimeout(resolveQ,250);
      }
    } else {
      const bAnswered=Object.keys(G.blueAnswers).length;
      const rAnswered=Object.keys(G.redAnswers).length;
      const allDone=bAnswered>=bluePlayers.length&&rAnswered>=redPlayers.length;
      if(allDone&&!G.locked){ clearInterval(answerPoll); resolveQ(); }
    }
  },80);
}

// Message bus for clients
if(bc){
  bc.addEventListener('message',e=>{
    if(ROLE!=='host') return;
    const msg=e.data;
    if(msg.type==='answer'&&msg.data.code===ROOM_CODE&&!G.locked){
      const p=msg.data;
      if(p.qIdx===G.currentQ&&p.round===G.currentRound){
        if(p.team==='blue') G.blueAnswers[p.pid]=p.ans;
        else G.redAnswers[p.pid]=p.ans;
        updateAnswerStatus();
        const bluePlayers=G.players.filter(pl=>pl.team==='blue');
        const redPlayers=G.players.filter(pl=>pl.team==='red');
        const q=G.questions[G.currentQ];
        if(G.gameMode==='speed'){
          // First Correct Wins: only resolve if this answer is actually correct
          if(p.ans.idx===q?.a && !G.locked){
            // Tell all clients a correct answer was submitted â€” lock their options
            sendMsg('speed_correct',{code:ROOM_CODE,team:p.team,qIdx:G.currentQ,round:G.currentRound});
            clearInterval(answerPoll); if(!G.locked) setTimeout(resolveQ,250);
          }
        } else {
          // Class: resolve when all players answered
          const allDone=Object.keys(G.blueAnswers).length>=bluePlayers.length&&Object.keys(G.redAnswers).length>=redPlayers.length;
          if(allDone&&!G.locked){ clearInterval(answerPoll); resolveQ(); }
        }
      }
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RESOLVE QUESTION (HOST ONLY)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getMult(streak){ return G.streaksEnabled!==false?MULT_TABLE[Math.min(streak,MULT_TABLE.length-1)]:1; }

function resolveQ(){
  if(G.locked) return;
  G.locked=true;
  clearInterval(G.timerID); clearInterval(answerPoll);
  const q=G.questions[G.currentQ];

  // Process each player
  G.players.forEach(p=>{
    const ans=(p.team==='blue'?G.blueAnswers:G.redAnswers)[p.id];
    p.answered=(p.answered||0)+1;
    if(!ans){ p.streak=0; p.mult=1; return; }
    const correct=ans.idx===q.a;
    if(correct){
      p.correct=(p.correct||0)+1;
      p.streak=(p.streak||0)+1;
      p.mult=getMult(p.streak);
      p.streakPeak=Math.max(p.streakPeak||0,p.streak); // track peak
      const tBonus=Math.max(0,1-ans.elapsed/G.timerMax);
      const pts=Math.round(DIFF_PTS[q.d]*(1+tBonus*0.5)*p.mult);
      p.score=(p.score||0)+pts;
      if(p.team==='blue'){G.blueScore+=pts;G.blueRoundScore+=pts;}
      else {G.redScore+=pts;G.redRoundScore+=pts;}
    } else {
      p.streak=0; p.mult=1;
    }
  });

  // Team-level correct answers
  const blueCorrectAns=G.players.filter(p=>p.team==='blue'&&(G.blueAnswers[p.id]?.idx===q.a));
  const redCorrectAns=G.players.filter(p=>p.team==='red'&&(G.redAnswers[p.id]?.idx===q.a));
  const blueAnyCorrect=blueCorrectAns.length>0;
  const redAnyCorrect=redCorrectAns.length>0;

  // Collect any activated power-ups this question
  collectActivePowerups();

  // Rope pull
  const BASE_PULL=0.10;
  let pullDelta=0;
  let pullMult=1;
  if(activePowerups.blue.double) pullMult=2;
  if(activePowerups.red.double) pullMult=2;

  if(blueAnyCorrect&&!redAnyCorrect){
    pullDelta = -(BASE_PULL * (activePowerups.blue.double?2:1));
    if(activePowerups.red.shield){ pullDelta=0; showPowerupBanner('shield'); }
  } else if(redAnyCorrect&&!blueAnyCorrect){
    pullDelta = BASE_PULL * (activePowerups.red.double?2:1);
    if(activePowerups.blue.shield){ pullDelta=0; showPowerupBanner('shield'); }
  } else if(blueAnyCorrect&&redAnyCorrect){
    // Speed tie-break: fastest correct on each team
    const bFastest=Math.min(...blueCorrectAns.map(p=>(G.blueAnswers[p.id]?.elapsed||99)));
    const rFastest=Math.min(...redCorrectAns.map(p=>(G.redAnswers[p.id]?.elapsed||99)));
    const diff=rFastest-bFastest;
    const edge=Math.min(0.05,Math.abs(diff)*0.03);
    if(diff>0.5) pullDelta=-edge;
    else if(diff<-0.5) pullDelta=edge;
  }

  // Power pull on 4+ streak (best player on team)
  const blueMaxStreak=Math.max(0,...G.players.filter(p=>p.team==='blue').map(p=>p.streak||0));
  const redMaxStreak=Math.max(0,...G.players.filter(p=>p.team==='red').map(p=>p.streak||0));
  if(blueMaxStreak>=4){pullDelta-=0.06;powerPull('blue');}
  else if(redMaxStreak>=4){pullDelta+=0.06;powerPull('red');}

  const newTarget=G.rope+pullDelta;
  animateRopeTo(newTarget,520);

  // Character animations: lunge winner, stumble loser
  if(blueAnyCorrect && !redAnyCorrect){ triggerLunge('blue'); triggerStumble('red'); SFX.correct(); SFX.pull(); }
  else if(redAnyCorrect && !blueAnyCorrect){ triggerLunge('red'); triggerStumble('blue'); SFX.correct(); SFX.pull(); }
  else if(blueAnyCorrect && redAnyCorrect){ triggerLunge('blue'); triggerLunge('red'); SFX.bothCorrect(); }
  else { SFX.noAnswer(); }

  // Log for analytics
  G.questionLog=(G.questionLog||[]);
  G.questionLog.push({
    qText:q.q,diff:q.d,correct:q.a,
    blueAnswered:Object.keys(G.blueAnswers).length,redAnswered:Object.keys(G.redAnswers).length,
    blueCorrect:blueCorrectAns.length,redCorrect:redCorrectAns.length,
    pullDelta,ropeAfter:Math.max(0.04,Math.min(0.96,newTarget)),
  });

  // Write resolving state for clients
  const room=buildRoomState('resolving');
  room.resolvedCorrect=q.a;
  room.resolvedBlueAnswers={...G.blueAnswers};
  room.resolvedRedAnswers={...G.redAnswers};
  room.ropeAfter=Math.max(0.04,Math.min(0.96,newTarget));
  writeRoom(room);

  revealAnswers(q.a,G.blueAnswers,G.redAnswers);
  if(blueAnyCorrect) flashPanel('blue',G.blueScore);
  if(redAnyCorrect) flashPanel('red',G.redScore);
  updateBattleUI();

  // Show explanation if available
  if(q.explanation||q.ex) showExplanation(q, 3000);

  // Freeze effect ends
  applyFreezeEffect(false);
  sendMsg('freeze_end',{code:ROOM_CODE});

  // Update power-up availability for local player
  const myPlayer=G.players.find(p=>p.name===MY_NAME&&p.team===MY_TEAM);
  if(myPlayer){ checkStreakPowerups(myPlayer); renderPowerupBar(); }

  // Advance after animation â€” longer pause so players can read result
  setTimeout(()=>{
    G.rope=Math.max(0.04,Math.min(0.96,newTarget));
    G.locked=false;
    hideExplanation();
    advanceGame();
  },q.explanation||q.ex ? 3500 : 2200);
}

function revealAnswers(correct,blueAnswers,redAnswers){
  document.querySelectorAll('.opt').forEach((b,i)=>{
    b.disabled=true;
    if(i===correct) b.classList.add('reveal-correct');
    else b.classList.add('reveal-wrong');
  });
  const blueHasCorrect=Object.values(blueAnswers||{}).some(a=>a.idx===correct);
  const redHasCorrect=Object.values(redAnswers||{}).some(a=>a.idx===correct);
  showTeamResult('blue',blueHasCorrect?'correct':(Object.keys(blueAnswers||{}).length>0?'wrong':'noans'));
  showTeamResult('red',redHasCorrect?'correct':(Object.keys(redAnswers||{}).length>0?'wrong':'noans'));
  if(blueHasCorrect&&!redHasCorrect) showPullArrow('blue');
  else if(redHasCorrect&&!blueHasCorrect) showPullArrow('red');
  else if(blueHasCorrect&&redHasCorrect) showPullArrow('both');
}

function showTeamResult(team,result){
  const bar=document.getElementById('bar-'+team);
  let ex=bar.querySelector('.team-result-badge'); if(ex) ex.remove();
  const badge=document.createElement('div');
  badge.className='team-result-badge result-'+result;
  badge.textContent=result==='correct'?'âœ“ CORRECT':result==='wrong'?'âœ— WRONG':'â€” NO ANSWER';
  bar.appendChild(badge);
  setTimeout(()=>badge.remove(),1400);
}

function showPullArrow(team){
  const pf=document.getElementById('pp-flash');
  const pt=document.getElementById('pp-text');
  const arena=document.getElementById('arena');
  if(team==='both'){pt.textContent='BOTH CORRECT â€” SPEED WINS';pt.className='pp-text both';}
  else{pt.textContent=(team==='blue'?'â—€ ':'')+G[team+'N']+' PULLS'+(team==='red'?' â–¶':'');pt.className='pp-text '+team;}
  pf.classList.add('show');
  arena.classList.remove('pull-shake'); void arena.offsetWidth; arena.classList.add('pull-shake');
  setTimeout(()=>{pf.classList.remove('show');arena.classList.remove('pull-shake');},1300);
}

function flashPanel(team,score){
  const bar=document.getElementById('bar-'+team);
  bar.classList.remove('burst-'+team); void bar.offsetWidth; bar.classList.add('burst-'+team);
  setTimeout(()=>bar.classList.remove('burst-'+team),600);
  const sc=document.getElementById('tb-score-'+team);
  sc.classList.remove('pop'); void sc.offsetWidth; sc.classList.add('pop');
  // Fly-up popup
  const el=document.createElement('div');
  el.className='score-pop';
  const pts=Object.values(team==='blue'?G.blueAnswers:G.redAnswers).length?'+score!':'';
  el.textContent='+pts';
  el.style.color=team==='blue'?'var(--blue-light)':'var(--red-light)';
  const rect=sc.getBoundingClientRect();
  el.style.left=(rect.left+rect.width/2-20)+'px';
  el.style.top=rect.top+'px';
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),1100);
}

function powerPull(team){
  const pf=document.getElementById('pp-flash');
  const pt=document.getElementById('pp-text');
  pt.textContent='POWER PULL'; pt.className='pp-text '+team;
  pf.classList.add('show'); setTimeout(()=>pf.classList.remove('show'),1800);
  SFX.powerPull();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADVANCE GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BETWEEN_Q_DELAY = 4000;  // ms between questions â€” enough for client poll to catch ready state
const BETWEEN_R_DELAY = 5000;  // ms between rounds (new round start)

function showReadyOverlay(secondsLeft, subText){
  const ov = document.getElementById('ready-overlay');
  const numEl = document.getElementById('ready-num');
  const subEl = document.getElementById('ready-sub');
  if(!ov) return;
  ov.classList.add('show');
  if(subEl) subEl.textContent = subText || 'Get ready...';
  numEl.textContent = Math.ceil(secondsLeft);
}

function hideReadyOverlay(){
  const ov = document.getElementById('ready-overlay');
  if(ov) ov.classList.remove('show');
}

function advanceGame(){
  const pos=ropeTarget!==undefined?ropeTarget:G.rope;
  if(pos<=0.10){hostEndRound('blue','rope pull');return;}
  if(pos>=0.90){hostEndRound('red','rope pull');return;}
  G.currentQ++;
  if(G.currentQ>=G.questions.length){
    const w=G.blueRoundScore>G.redRoundScore?'blue':G.redRoundScore>G.blueRoundScore?'red':null;
    hostEndRound(w,'score');return;
  }
  G.blueAnswers={}; G.redAnswers={}; G.locked=false;
  if(ROOM_CODE){try{const t=[];for(let i=0;i<localStorage.length;i++){const k=localStorage.key(i);if(k&&(k.startsWith('quizzo_ans_'+ROOM_CODE+'_')||k.startsWith('quizzo_speed_'+ROOM_CODE+'_')))t.push(k);}t.forEach(k=>localStorage.removeItem(k));}catch(e){}}

  // Write 'ready' state â€” clients show countdown, no one can answer yet
  const readyStart = Date.now() + BETWEEN_Q_DELAY;
  G.qStartTime = readyStart;
  const readyRoom = buildRoomState('ready');
  readyRoom.qStartTime = readyStart;
  writeRoom(readyRoom);

  // Host shows countdown overlay, then flips to playing
  renderQuestion(); updateBattleUI();
  showReadyOverlay(BETWEEN_Q_DELAY / 1000, `Q ${G.currentQ + 1} of ${G.questions.length}`);
  let _advanceReadyTimer;
  function tickReady(){
    const remaining = (readyStart - Date.now()) / 1000;
    const numEl = document.getElementById('ready-num');
    if(numEl) numEl.textContent = Math.max(0, Math.ceil(remaining));
    if(remaining <= 0){
      hideReadyOverlay();
      // Write playing state once with the synced qStartTime
      const room = buildRoomState('playing');
      room.qStartTime = readyStart;
      writeRoom(room);
      startTimer(true); // true = use existing G.qStartTime, don't reset
      return;
    }
    _advanceReadyTimer = setTimeout(tickReady, 200);
  }
  tickReady();
}

function hostEndRound(winner,how){
  clearInterval(G.timerID); clearInterval(answerPoll);
  if(winner) G.roundWins[winner]++;
  G.roundHistory.push(winner||'draw');
  const room=buildRoomState('round_end');
  room.roundWinner=winner; room.roundHow=how;
  writeRoom(room);
  showRoundResult(winner,how);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ROUND RESULT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showRoundResult(winner,how){
  const rw=document.getElementById('rc-winner');
  if(!winner){rw.textContent='DRAW';rw.className='rc-winner draw';}
  else{rw.textContent=(winner==='blue'?G.blueN:G.redN)+' WINS';rw.className='rc-winner '+winner;}
  document.getElementById('rc-how').textContent=`by ${how||'score'} Â· round ${G.currentRound}`;
  document.getElementById('rcs-blue').textContent=G.blueScore.toLocaleString();
  document.getElementById('rcs-name-blue').textContent=G.blueN;
  document.getElementById('rcs-red').textContent=G.redScore.toLocaleString();
  document.getElementById('rcs-name-red').textContent=G.redN;
  const pc2=document.getElementById('rc-pips'); pc2.innerHTML='';
  for(let i=0;i<G.totalR;i++){
    const d=document.createElement('div'); d.className='rc-pip';
    if(G.roundHistory[i]&&G.roundHistory[i]!=='draw') d.classList.add(G.roundHistory[i]);
    pc2.appendChild(d);
  }
  // Stats breakdown (team level)
  const bluePlayers=G.players.filter(p=>p.team==='blue');
  const redPlayers=G.players.filter(p=>p.team==='red');
  const bAns=bluePlayers.reduce((s,p)=>s+(p.answered||0),0);
  const rAns=redPlayers.reduce((s,p)=>s+(p.answered||0),0);
  const bCor=bluePlayers.reduce((s,p)=>s+(p.correct||0),0);
  const rCor=redPlayers.reduce((s,p)=>s+(p.correct||0),0);
  const bAcc=bAns?Math.round(bCor/bAns*100)+'%':'â€”';
  const rAcc=rAns?Math.round(rCor/rAns*100)+'%':'â€”';
  const bMaxStr=Math.max(0,...bluePlayers.map(p=>p.streak||0));
  const rMaxStr=Math.max(0,...redPlayers.map(p=>p.streak||0));
  document.getElementById('rc-stats').innerHTML=`
    <div class="rc-stat-col">
      <div class="rc-stat-val blue">${bAcc}</div><div class="rc-stat-label">ACCURACY</div>
      <div class="rc-stat-val blue" style="margin-top:8px">${bMaxStr}</div><div class="rc-stat-label">BEST STREAK</div>
    </div>
    <div class="rc-stat-divider"><div class="rc-divider-line"></div></div>
    <div class="rc-stat-col">
      <div class="rc-stat-val red">${rAcc}</div><div class="rc-stat-label">ACCURACY</div>
      <div class="rc-stat-val red" style="margin-top:8px">${rMaxStr}</div><div class="rc-stat-label">BEST STREAK</div>
    </div>`;
  const matchWinner=G.roundWins.blue>=G.toWin?'blue':G.roundWins.red>=G.toWin?'red':null;
  const isLast=G.currentRound>=G.totalR;
  const isTied=isLast&&!matchWinner&&G.roundWins.blue===G.roundWins.red;
  const btn=document.getElementById('btn-next-round');
  btn.style.display = ROLE==='host' ? 'block' : 'none';
  if(isTied){
    // Sudden death tiebreaker
    btn.innerHTML='<span class="sd-badge">âš¡ SUDDEN DEATH</span>';
    btn.onclick=()=>{ if(ROLE==='host') startSuddenDeath(); };
  } else if(matchWinner||isLast){
    btn.textContent='SEE RESULTS â†’';
    btn.onclick=()=>{
      if(ROLE==='host') hostShowVictory(matchWinner||(G.roundWins.blue>=G.roundWins.red?'blue':'red'));
      else showVictory(matchWinner||(G.roundWins.blue>=G.roundWins.red?'blue':'red'));
    };
  } else {
    btn.textContent='NEXT ROUND â†’';
    btn.onclick=()=>{
      if(ROLE==='host'){ hostNextRound(); }
      // Clients just wait â€” the poll in listenAsClient handles the state change
    };
  }
  showScreen('s-round');
  // Round end stinger â€” win/lose for players, neutral for host/draw
  if(ROLE==='host' || !winner) SFX.roundEnd();
  else if(MY_TEAM===winner) SFX.correct();
  else SFX.wrongReveal();
}

function hostNextRound(){
  G.currentRound++; G.currentQ=0; G.blueRoundScore=0; G.redRoundScore=0;
  G.rope=0.5; ropeTarget=0.5; G.locked=false; G.blueAnswers={}; G.redAnswers={};
  G.players.forEach(p=>{p.score=0;p.streak=0;p.mult=1;});
  G.questions=shufflePool();

  // Write ready state for the new round â€” longer delay so players can prepare
  const readyStart = Date.now() + BETWEEN_R_DELAY;
  G.qStartTime = readyStart;
  const readyRoom = buildRoomState('ready');
  readyRoom.qStartTime = readyStart;
  readyRoom.readyLabel = `Round ${G.currentRound}`;
  writeRoom(readyRoom);

  // Host: show lineup â†’ then game with countdown
  showLineup(()=>{
    enterGame();
    showReadyOverlay((readyStart - Date.now()) / 1000, `Round ${G.currentRound} â€” Q1 of ${G.questions.length}`);
    let _roundReadyTimer;
    function tickReady(){
      const remaining = (readyStart - Date.now()) / 1000;
      const numEl = document.getElementById('ready-num');
      if(numEl) numEl.textContent = Math.max(0, Math.ceil(remaining));
      if(remaining <= 0){
        hideReadyOverlay();
        const room = buildRoomState('playing');
        room.qStartTime = readyStart;
        writeRoom(room);
        startTimer(true);
        return;
      }
      _roundReadyTimer = setTimeout(tickReady, 200);
    }
    tickReady();
  });
}

function hostShowVictory(winner){
  const room=buildRoomState('match_end');
  room.matchWinner=winner; writeRoom(room); showVictory(winner);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VICTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showVictory(winner){
  showScreen('s-victory');
  const n=winner==='blue'?G.blueN:G.redN;
  const vn=document.getElementById('vp-name');
  vn.textContent=n; vn.className='vp-name '+winner;
  const vp=document.getElementById('victory-panel');
  vp.className='victory-panel '+(winner==='blue'?'blue-win':'red-win');
  document.getElementById('vc-bg-blue').style.display=winner==='blue'?'block':'none';
  document.getElementById('vc-bg-red').style.display=winner==='red'?'block':'none';
  const bluePlayers=G.players.filter(p=>p.team==='blue');
  const redPlayers=G.players.filter(p=>p.team==='red');
  const bAns=bluePlayers.reduce((s,p)=>s+(p.answered||0),0);
  const rAns=redPlayers.reduce((s,p)=>s+(p.answered||0),0);
  const bCor=bluePlayers.reduce((s,p)=>s+(p.correct||0),0);
  const rCor=redPlayers.reduce((s,p)=>s+(p.correct||0),0);
  document.getElementById('vp-stats').innerHTML=`
    <div class="vp-stat"><div class="vps-val blue">${G.blueScore.toLocaleString()}</div><div class="vps-label">${G.blueN} SCORE</div></div>
    <div class="vp-stat"><div class="vps-val gold">${G.roundWins.blue}â€“${G.roundWins.red}</div><div class="vps-label">ROUND WINS</div></div>
    <div class="vp-stat"><div class="vps-val red">${G.redScore.toLocaleString()}</div><div class="vps-label">${G.redN} SCORE</div></div>
    <div class="vp-stat"><div class="vps-val blue">${bAns?Math.round(bCor/bAns*100):0}%</div><div class="vps-label">${G.blueN} ACCURACY</div></div>
    <div class="vp-stat"><div class="vps-val gold">${(G.questionLog||[]).length}</div><div class="vps-label">QUESTIONS</div></div>
    <div class="vp-stat"><div class="vps-val red">${rAns?Math.round(rCor/rAns*100):0}%</div><div class="vps-label">${G.redN} ACCURACY</div></div>`;
  document.getElementById('btn-rematch').className='vp-btn primary-'+winner;

  // Host sees all controls; players only see Back to Lobby
  const isHost = ROLE==='host';
  document.getElementById('btn-rematch').style.display      = isHost ? '' : 'none';
  document.getElementById('btn-report-card').style.display  = isHost ? '' : 'none';
  document.getElementById('btn-view-analytics').style.display = isHost ? '' : 'none';

  launchConfetti(winner);
  // Win sound for winner's team/host, lose sound for the other team
  if(ROLE==='host' || MY_TEAM===winner) SFX.victory();
  else SFX.lose();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BATTLE UI UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateBattleUI(){
  document.getElementById('tb-score-blue').textContent=G.blueScore.toLocaleString();
  document.getElementById('tb-score-red').textContent=G.redScore.toLocaleString();
  const bluePlayers=G.players.filter(p=>p.team==='blue');
  const redPlayers=G.players.filter(p=>p.team==='red');
  const blueMaxStr=Math.max(0,...bluePlayers.map(p=>p.streak||0));
  const redMaxStr=Math.max(0,...redPlayers.map(p=>p.streak||0));
  const blueMult=blueMaxStr>0?getMult(blueMaxStr):1;
  const redMult=redMaxStr>0?getMult(redMaxStr):1;
  function stylePill(el,streak){
    if(streak<2){el.classList.remove('show','tier-1','tier-2','tier-3');return;}
    el.classList.add('show');el.classList.remove('tier-1','tier-2','tier-3');
    if(streak>=5) el.classList.add('tier-3');
    else if(streak>=3) el.classList.add('tier-2');
    else el.classList.add('tier-1');
    el.textContent=streak+' streak';
  }
  stylePill(document.getElementById('sp-blue'),blueMaxStr);
  stylePill(document.getElementById('sp-red'),redMaxStr);
  const mpB=document.getElementById('mp-blue'),mpR=document.getElementById('mp-red');
  if(blueMult>1){mpB.textContent='Ã—'+blueMult;mpB.classList.add('show');}else mpB.classList.remove('show');
  if(redMult>1){mpR.textContent='Ã—'+redMult;mpR.classList.add('show');}else mpR.classList.remove('show');
  const bbc=document.getElementById('bbc-rounds'); bbc.innerHTML='';
  for(let i=0;i<G.totalR;i++){
    const d=document.createElement('div'); d.className='rpip';
    if(i<G.roundHistory.length&&G.roundHistory[i]!=='draw') d.classList.add(G.roundHistory[i]);
    else if(i===G.currentRound-1) d.classList.add('current');
    bbc.appendChild(d);
  }
  document.getElementById('bbc-round').textContent='ROUND '+G.currentRound;
  updateAnswerStatus();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ANALYTICS DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildAnalytics(){
  showScreen('s-analytics');
  const bluePlayers=G.players.filter(p=>p.team==='blue');
  const redPlayers=G.players.filter(p=>p.team==='red');
  const bScore=G.blueScore, rScore=G.redScore;
  const bAns=bluePlayers.reduce((s,p)=>s+(p.answered||0),0);
  const rAns=redPlayers.reduce((s,p)=>s+(p.answered||0),0);
  const bCor=bluePlayers.reduce((s,p)=>s+(p.correct||0),0);
  const rCor=redPlayers.reduce((s,p)=>s+(p.correct||0),0);
  const bAcc=bAns?Math.round(bCor/bAns*100):0;
  const rAcc=rAns?Math.round(rCor/rAns*100):0;
  const totalQ=(G.questionLog||[]).length;
  const subject=SUBJ_NAMES[G.subject]||G.subject;
  const winner=G.roundWins.blue>G.roundWins.red?G.blueN:G.roundWins.red>G.roundWins.blue?G.redN:'DRAW';

  // All players sorted by score
  const allPlayers=[...G.players].sort((a,b)=>(b.score||0)-(a.score||0));
  const rankIcons=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];

  // Q-by-Q log
  const qLog=G.questionLog||[];

  document.getElementById('analytics-export-btns').innerHTML=`
    <button class="export-btn green-btn" onclick="exportCSVReport()">ğŸ“„ Export CSV</button>
    <button class="export-btn" onclick="exportTextReport()">ğŸ“‹ Export Text</button>`;

  document.getElementById('analytics-content').innerHTML=`
    <!-- Summary -->
    <div class="analytics-card">
      <div class="setup-section-title">Match Summary</div>
      <div style="font-size:12px;font-weight:700;color:var(--text-mid);margin-top:-8px;">
        ${subject} Â· ${G.fmt.toUpperCase()} Â· ${G.gameMode==='speed'?'First Correct Wins':'Class Mode'} Â· ${new Date().toLocaleDateString()}
      </div>
      <div class="analytics-grid-3">
        <div class="stat-box blue-box"><div class="stat-val blue">${bScore.toLocaleString()}</div><div class="stat-label">${G.blueN} SCORE</div></div>
        <div class="stat-box gold-box"><div class="stat-val gold">${G.roundWins.blue}â€“${G.roundWins.red}</div><div class="stat-label">ROUND WINS</div></div>
        <div class="stat-box red-box"><div class="stat-val red">${rScore.toLocaleString()}</div><div class="stat-label">${G.redN} SCORE</div></div>
        <div class="stat-box blue-box"><div class="stat-val blue">${bAcc}%</div><div class="stat-label">${G.blueN} ACCURACY</div></div>
        <div class="stat-box"><div class="stat-val purple">${totalQ}</div><div class="stat-label">QUESTIONS</div></div>
        <div class="stat-box red-box"><div class="stat-val red">${rAcc}%</div><div class="stat-label">${G.redN} ACCURACY</div></div>
      </div>
      <div style="text-align:center;margin-top:4px;">
        <span style="font-family:var(--font-d);font-size:20px;color:${G.roundWins.blue>G.roundWins.red?'var(--blue)':G.roundWins.red>G.roundWins.blue?'var(--red)':'var(--gold-dark)'};">
          ${G.roundWins.blue>G.roundWins.red?'ğŸ† '+G.blueN+' WINS THE MATCH':G.roundWins.red>G.roundWins.blue?'ğŸ† '+G.redN+' WINS THE MATCH':'ğŸ¤ DRAW'}
        </span>
      </div>
    </div>

    <!-- Player Rankings -->
    <div class="analytics-card">
      <div class="setup-section-title">Player Rankings</div>
      <table class="player-table">
        <thead><tr>
          <th>RANK</th><th>PLAYER</th><th>TEAM</th><th>SCORE</th>
          <th>ACCURACY</th><th>CORRECT</th><th>BEST STREAK</th>
        </tr></thead>
        <tbody>
          ${allPlayers.map((p,i)=>{
            const acc=p.answered?Math.round((p.correct||0)/p.answered*100):0;
            return `<tr>
              <td><span class="rank-num">${rankIcons[i]||'#'+(i+1)}</span></td>
              <td style="font-weight:800;">${p.name}</td>
              <td><span class="team-dot-cell ${p.team}"></span> ${p.team.toUpperCase()}</td>
              <td style="font-family:var(--font-d);font-size:15px;color:${p.team==='blue'?'var(--blue)':'var(--red)'};">${(p.score||0).toLocaleString()}</td>
              <td>
                <div style="display:flex;align-items:center;gap:8px;">
                  ${acc}%
                  <div class="acc-bar-wrap"><div class="acc-bar ${p.team}" style="width:${acc}%;"></div></div>
                </div>
              </td>
              <td>${p.correct||0}/${p.answered||0}</td>
              <td style="font-family:var(--font-d);">${p.streak||0}Ã—</td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>

    <!-- Q-by-Q Breakdown -->
    ${qLog.length?`
    <div class="analytics-card">
      <div class="setup-section-title">Question-by-Question Breakdown</div>
      <div style="max-height:300px;overflow-y:auto;">
        ${qLog.map((ql,i)=>`
          <div class="qbq-row">
            <span class="qbq-num">Q${i+1}</span>
            <span class="qbq-q" title="${ql.qText}">${ql.qText}</span>
            <span class="qe-badge ${ql.diff}">${ql.diff}</span>
            <span class="qbq-pull ${ql.pullDelta<-0.01?'blue':ql.pullDelta>0.01?'red':'tied'}">
              ${ql.pullDelta<-0.01?'â—€ '+G.blueN:ql.pullDelta>0.01?G.redN+' â–¶':'â€” TIED'}
            </span>
            <span style="font-size:11px;font-weight:700;color:var(--text-mid);min-width:80px;text-align:right;">
              B: ${ql.blueCorrect}/${ql.blueAnswered} Â· R: ${ql.redCorrect}/${ql.redAnswered}
            </span>
          </div>`).join('')}
      </div>
    </div>`:''}

    <!-- Team Comparison -->
    <div class="analytics-card">
      <div class="setup-section-title">Team Comparison</div>
      <div class="analytics-grid-2">
        <div>
          <div style="font-family:var(--font-d);font-size:16px;color:var(--blue);margin-bottom:12px;">${G.blueN} (BLUE)</div>
          ${bluePlayers.map(p=>`<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #f0eeff;font-size:12px;">
            <span style="font-weight:700;">${p.name}</span>
            <span style="color:var(--blue);font-family:var(--font-d);">${(p.score||0).toLocaleString()}</span>
          </div>`).join('')}
          <div style="margin-top:8px;padding:8px;background:#e8f4ff;border-radius:var(--r10);text-align:center;">
            <div style="font-family:var(--font-d);font-size:22px;color:var(--blue);">${bScore.toLocaleString()}</div>
            <div style="font-size:10px;font-weight:800;color:var(--text-mid);letter-spacing:1px;">TOTAL SCORE</div>
          </div>
        </div>
        <div>
          <div style="font-family:var(--font-d);font-size:16px;color:var(--red);margin-bottom:12px;">${G.redN} (RED)</div>
          ${redPlayers.map(p=>`<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #f0eeff;font-size:12px;">
            <span style="font-weight:700;">${p.name}</span>
            <span style="color:var(--red);font-family:var(--font-d);">${(p.score||0).toLocaleString()}</span>
          </div>`).join('')}
          <div style="margin-top:8px;padding:8px;background:#ffe8ec;border-radius:var(--r10);text-align:center;">
            <div style="font-family:var(--font-d);font-size:22px;color:var(--red);">${rScore.toLocaleString()}</div>
            <div style="font-size:10px;font-weight:800;color:var(--text-mid);letter-spacing:1px;">TOTAL SCORE</div>
          </div>
        </div>
      </div>
    </div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT REPORTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportTextReport(){
  const lines=[
    'QUIZZO â€” MATCH REPORT',
    '='+'='.repeat(40),
    `Date: ${new Date().toLocaleString()}`,
    `Subject: ${SUBJ_NAMES[G.subject]||G.subject}`,
    `Format: ${G.fmt} | Mode: ${G.gameMode}`,
    `Teams: ${G.blueN} (Blue) vs ${G.redN} (Red)`,
    '',
    'RESULTS',
    '-'.repeat(40),
    `${G.blueN} Score: ${G.blueScore}`,
    `${G.redN} Score: ${G.redScore}`,
    `Round Wins: Blue ${G.roundWins.blue} â€” Red ${G.roundWins.red}`,
    '',
    'PLAYER BREAKDOWN',
    '-'.repeat(40),
    ...[...G.players].sort((a,b)=>(b.score||0)-(a.score||0)).map((p,i)=>{
      const acc=p.answered?Math.round((p.correct||0)/p.answered*100):0;
      return `${i+1}. ${p.name} (${p.team.toUpperCase()}) | Score: ${p.score||0} | Accuracy: ${acc}% | Streak: ${p.streak||0}`;
    }),
    '',
    'QUESTION LOG',
    '-'.repeat(40),
    ...(G.questionLog||[]).map((ql,i)=>`Q${i+1} [${ql.diff}]: ${ql.qText.slice(0,60)} | Blue: ${ql.blueCorrect}/${ql.blueAnswered} Red: ${ql.redCorrect}/${ql.redAnswered}`),
  ];
  downloadFile('quizzo_report_'+Date.now()+'.txt',lines.join('\n'),'text/plain');
}

function exportCSVReport(){
  const rows=[
    ['Match Report - Quizzo'],
    ['Date',new Date().toLocaleString()],
    ['Subject',SUBJ_NAMES[G.subject]||G.subject],
    ['Format',G.fmt,'Mode',G.gameMode],
    ['Blue Team',G.blueN,'Red Team',G.redN],
    [],
    ['Player','Team','Score','Correct','Answered','Accuracy%','Best Streak'],
    ...[...G.players].sort((a,b)=>(b.score||0)-(a.score||0)).map(p=>[
      p.name, p.team, p.score||0, p.correct||0, p.answered||0,
      p.answered?Math.round((p.correct||0)/p.answered*100):0,
      p.streak||0
    ]),
    [],
    ['Q#','Question','Difficulty','Blue Correct','Blue Answered','Red Correct','Red Answered','Pull Direction'],
    ...(G.questionLog||[]).map((ql,i)=>[
      i+1, ql.qText, ql.diff, ql.blueCorrect, ql.blueAnswered, ql.redCorrect, ql.redAnswered,
      ql.pullDelta<-0.01?G.blueN:ql.pullDelta>0.01?G.redN:'TIED'
    ]),
  ];
  const csv=rows.map(r=>r.map(c=>'"'+String(c).replace(/"/g,'""')+'"').join(',')).join('\n');
  downloadFile('quizzo_report_'+Date.now()+'.csv',csv,'text/csv');
}

function downloadFile(filename,content,type){
  const blob=new Blob([content],{type});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=filename; a.click();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFETTI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function launchConfetti(winner){
  const c=document.getElementById('vc-canvas');
  const cx=c.getContext('2d');
  c.width=window.innerWidth; c.height=window.innerHeight;
  const cols=winner==='blue'?['#1368ce','#46a6ff','#ffffff','#ffa602']:['#e21b3c','#ff6b8a','#ffffff','#ffa602'];
  const p=Array.from({length:200},()=>({
    x:Math.random()*c.width,y:-30-Math.random()*100,
    vx:(Math.random()-0.5)*8,vy:3+Math.random()*7,rot:Math.random()*6,
    rotV:(Math.random()-0.5)*0.3,col:cols[Math.floor(Math.random()*cols.length)],
    shape:Math.random()>0.4?'r':'c',r:3+Math.random()*5,w:6+Math.random()*14,h:4+Math.random()*8
  }));
  let f=0;
  (function tick(){
    cx.clearRect(0,0,c.width,c.height);
    const fade=Math.max(0,1-f/200);
    p.forEach(q=>{
      q.x+=q.vx;q.y+=q.vy;q.vy+=0.08;q.rot+=q.rotV;
      cx.save();cx.translate(q.x,q.y);cx.rotate(q.rot);cx.globalAlpha=fade;cx.fillStyle=q.col;
      if(q.shape==='c'){cx.beginPath();cx.arc(0,0,q.r,0,Math.PI*2);cx.fill();}
      else cx.fillRect(-q.w/2,-q.h/2,q.w,q.h);
      cx.restore();
    });
    f++;
    if(f<260) requestAnimationFrame(tick);
    else cx.clearRect(0,0,c.width,c.height);
  })();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BUTTONS WIRING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ANSWER EXPLANATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let explTimer=null;
function showExplanation(q, durationMs=3500){
  const overlay=document.getElementById('explanation-overlay');
  const ansEl=document.getElementById('expl-answer');
  const txtEl=document.getElementById('expl-text');
  const timerEl=document.getElementById('expl-timer');
  if(!overlay) return;
  const opts=['A','B','C','D'];
  ansEl.textContent=opts[q.a]+' â€” '+(q.o[q.a]||'');
  txtEl.textContent=q.explanation||q.ex||'';
  if(!txtEl.textContent){ overlay.style.display='none'; return; }
  overlay.classList.add('show');
  timerEl.style.transition='none'; timerEl.style.width='100%';
  requestAnimationFrame(()=>{
    requestAnimationFrame(()=>{
      timerEl.style.transition=`width ${durationMs}ms linear`;
      timerEl.style.width='0%';
    });
  });
  clearTimeout(explTimer);
  explTimer=setTimeout(()=>{ overlay.classList.remove('show'); },durationMs);
}
function hideExplanation(){ document.getElementById('explanation-overlay').classList.remove('show'); clearTimeout(explTimer); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  POWER-UP SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Each player has { shield:0, double:0, freeze:0 } â€” 0=locked, 1=available, 2=used
// Earned at streak milestones
const PU_DEFS={
  shield:{ label:'ğŸ›¡ Shield', cls:'pu-shield', streak:2, desc:'Block rope pull if wrong once' },
  double:{ label:'âš¡ Double Pull', cls:'pu-double', streak:4, desc:'Next correct = 2Ã— rope pull' },
  freeze:{ label:'â„ Freeze', cls:'pu-freeze', streak:6, desc:"Cut opponent's timer to 5s" }
};
let myPowerups={ shield:0, double:0, freeze:0 };
let activePowerups={ blue:{}, red:{} }; // track which are active per team this question

function checkStreakPowerups(player){
  if(player.streak>=2 && !myPowerups.shield) myPowerups.shield=1;
  if(player.streak>=4 && !myPowerups.double) myPowerups.double=1;
  if(player.streak>=6 && !myPowerups.freeze) myPowerups.freeze=1;
}

function renderPowerupBar(){
  const bar=document.getElementById('powerup-bar');
  if(!bar||ROLE==='host') return;
  bar.style.display='flex';
  bar.innerHTML='';
  Object.entries(PU_DEFS).forEach(([key,def])=>{
    const state=myPowerups[key]; // 0=locked,1=available,2=used
    const btn=document.createElement('button');
    btn.className='pu-btn '+def.cls+(state===2?' pu-used':'');
    btn.disabled=state!==1;
    btn.title=def.desc+' (earn at '+def.streak+' streak)';
    btn.innerHTML=def.label+(state===0?`<span class="pu-badge">${def.streak}ğŸ”¥</span>`:'');
    if(state===1) btn.onclick=()=>activatePowerup(key);
    bar.appendChild(btn);
  });
}

function activatePowerup(key){
  if(myPowerups[key]!==1) return;
  myPowerups[key]=2;
  SFX.powerup(key);
  // Write to room so host can read it
  const puKey='quizzo_pu_'+ROOM_CODE+'_'+MY_TEAM+'_'+key;
  try{ localStorage.setItem(puKey, JSON.stringify({team:MY_TEAM,key,qIdx:G.currentQ,round:G.currentRound,ts:Date.now()})); }catch(e){}
  sendMsg('powerup',{code:ROOM_CODE,team:MY_TEAM,key,qIdx:G.currentQ,round:G.currentRound});
  showPowerupBanner(key);
  renderPowerupBar();
}

function showPowerupBanner(key){
  const def=PU_DEFS[key];
  const b=document.createElement('div');
  b.className='pu-active-banner';
  b.textContent=def.label+' ACTIVATED!';
  if(key==='double') b.style.background='linear-gradient(135deg,var(--gold),var(--gold-dark))';
  if(key==='freeze') b.style.background='linear-gradient(135deg,#2980b9,#1a5a80)';
  document.body.appendChild(b);
  setTimeout(()=>b.remove(),2000);
}

function applyFreezeEffect(active){
  const fo=document.getElementById('freeze-overlay');
  if(fo) fo.classList.toggle('show',active);
  if(active){
    // Shrink timer
    G.timerSec=Math.min(G.timerSec,5);
  }
}

// Host reads power-up keys each resolve
function collectActivePowerups(){
  activePowerups={blue:{},red:{}};
  try{
    for(let i=0;i<localStorage.length;i++){
      const k=localStorage.key(i);
      if(!k||!k.startsWith('quizzo_pu_'+ROOM_CODE+'_')) continue;
      const raw=localStorage.getItem(k);
      if(!raw) continue;
      const p=JSON.parse(raw);
      if(p.qIdx===G.currentQ&&p.round===G.currentRound){
        activePowerups[p.team][p.key]=true;
        localStorage.removeItem(k); i--;
      }
    }
  }catch(e){}
  // Also pick up from BroadcastChannel (already applied via onMsg below)
}

// Listen for power-up messages on client side
onMsg(msg=>{
  if(msg.type==='powerup'&&msg.data.code===ROOM_CODE){
    const {team,key}=msg.data;
    if(ROLE==='host') return; // host handles via localStorage scan
    if(key==='freeze'&&team!==MY_TEAM) applyFreezeEffect(true);
  }
  if(msg.type==='freeze_end') applyFreezeEffect(false);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUDDEN DEATH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let G_suddenDeath=false;

function startSuddenDeath(){
  G_suddenDeath=true;
  SFX.suddenDeath();
  G.currentQ=0;
  G.questions=shufflePool().slice(0,1); // one question
  G.blueAnswers={}; G.redAnswers={}; G.locked=false;
  G.blueRoundScore=0; G.redRoundScore=0;
  // Update round card to sudden death
  const rc=document.getElementById('rc-winner');
  const rh=document.getElementById('rc-how');
  if(rc){ rc.innerHTML='<span class="sd-badge">âš¡ SUDDEN DEATH</span>'; }
  if(rh){ rh.textContent='First team to answer correctly wins!'; }
  // Write ready state with delay
  const readyStart = Date.now() + BETWEEN_R_DELAY;
  G.qStartTime = readyStart;
  const readyRoom = buildRoomState('ready');
  readyRoom.qStartTime = readyStart;
  readyRoom.readyLabel = 'âš¡ Sudden Death';
  writeRoom(readyRoom);
  showScreen('s-game');
  renderQuestion(); updateBattleUI();
  showReadyOverlay((readyStart - Date.now()) / 1000, 'âš¡ Sudden Death â€” First correct wins!');
  let _sdReadyTimer;
  function tickSD(){
    const remaining = (readyStart - Date.now()) / 1000;
    const numEl = document.getElementById('ready-num');
    if(numEl) numEl.textContent = Math.max(0, Math.ceil(remaining));
    if(remaining <= 0){
      hideReadyOverlay();
      const room = buildRoomState('playing');
      room.qStartTime = readyStart; room.suddenDeath = true;
      writeRoom(room);
      startTimer(true);
      return;
    }
    _sdReadyTimer = setTimeout(tickSD, 200);
  }
  tickSD();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  REPORT CARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildReportCards(){
  showScreen('s-report');
  const sub=document.getElementById('report-sub');
  if(sub) sub.textContent=`${G.blueN} vs ${G.redN} Â· ${(G.questionLog||[]).length} Questions`;

  const allPlayers=[...G.players].sort((a,b)=>(b.score||0)-(a.score||0));
  const rankIcons=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','4ï¸âƒ£','5ï¸âƒ£','6ï¸âƒ£','7ï¸âƒ£','8ï¸âƒ£','9ï¸âƒ£','ğŸ”Ÿ'];
  const container=document.getElementById('report-cards');
  container.innerHTML='';

  allPlayers.forEach((p,i)=>{
    const acc=p.answered?Math.round((p.correct||0)/p.answered*100):0;
    const streakPeak=p.streakPeak||p.streak||0;
    const team=p.team;
    const tc=team==='blue'?'#1368ce':'#e21b3c';

    // Find missed questions
    const missed=(G.questionLog||[]).filter(q=>{
      const answers=team==='blue'?q.blueAnswers:q.redAnswers;
      return answers&&answers[p.id]&&answers[p.id].idx!==q.correct;
    }).map(q=>q.qText||'').filter(Boolean).slice(0,3);

    const card=document.createElement('div');
    card.className='report-card';
    card.style.borderColor=team==='blue'?'rgba(19,104,206,0.3)':'rgba(226,27,60,0.3)';

    // Avatar canvas
    const av=p.avatar||{skin:0,hair:0,eyes:0,accessory:0};
    const cvs=makeLineupCanvas(av,tc,3);

    const avatarWrap=document.createElement('div');
    avatarWrap.className='rc-avatar';
    const avInner=document.createElement('div');
    avInner.style.cssText=`background:#1a1a2e;border-radius:8px;padding:3px;border:2px solid ${tc};`;
    avInner.appendChild(cvs);
    avatarWrap.appendChild(avInner);

    const info=document.createElement('div');
    info.className='rc-info';
    info.innerHTML=`
      <div class="rc-name">${p.name}</div>
      <span class="rc-team ${team}">${team.toUpperCase()} TEAM</span>
      <div class="rc-stats">
        <div class="rc-stat"><div class="rc-stat-val gold">${(p.score||0).toLocaleString()}</div><div class="rc-stat-label">Score</div></div>
        <div class="rc-stat"><div class="rc-stat-val ${acc>=70?'green':acc>=40?'gold':'red'}">${acc}%</div><div class="rc-stat-label">Accuracy</div></div>
        <div class="rc-stat"><div class="rc-stat-val">${p.correct||0}/${p.answered||0}</div><div class="rc-stat-label">Correct</div></div>
        <div class="rc-stat"><div class="rc-stat-val">${streakPeak}ğŸ”¥</div><div class="rc-stat-label">Best Streak</div></div>
      </div>
      ${missed.length?`<div class="rc-missed"><div class="rc-missed-title">Missed Questions</div>${missed.map(q=>`<div class="rc-missed-q">â€¢ ${q}</div>`).join('')}</div>`:''}
    `;

    const rank=document.createElement('div');
    rank.className='rc-rank';
    rank.textContent=rankIcons[i]||`#${i+1}`;

    card.appendChild(avatarWrap);
    card.appendChild(info);
    card.appendChild(rank);
    container.appendChild(card);
  });
}

function exportReportCSV(){
  const rows=[['Rank','Name','Team','Score','Accuracy%','Correct','Answered','BestStreak']];
  [...G.players].sort((a,b)=>(b.score||0)-(a.score||0)).forEach((p,i)=>{
    const acc=p.answered?Math.round((p.correct||0)/p.answered*100):0;
    rows.push([i+1,p.name,p.team,p.score||0,acc,p.correct||0,p.answered||0,p.streakPeak||p.streak||0]);
  });
  const csv=rows.map(r=>r.join(',')).join('\n');
  const a=document.createElement('a');
  a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
  a.download='quizzo_report_'+Date.now()+'.csv';
  a.click();
}

let _ac = null;
let sfxMuted = (localStorage.getItem('quizzo_mute')==='1');

function getAC(){
  if(!_ac) _ac = new (window.AudioContext||window.webkitAudioContext)();
  if(_ac.state==='suspended') _ac.resume();
  return _ac;
}

function sfxTone(freqs, type='sine', vol=0.18, dur=0.18, attack=0.01, release=0.12){
  if(sfxMuted) return;
  try{
    const ac=getAC(), now=ac.currentTime;
    const gain=ac.createGain();
    gain.connect(ac.destination);
    gain.gain.setValueAtTime(0,now);
    gain.gain.linearRampToValueAtTime(vol,now+attack);
    gain.gain.exponentialRampToValueAtTime(0.001,now+dur);
    freqs.forEach((f,i)=>{
      const osc=ac.createOscillator();
      osc.type=type;
      osc.frequency.setValueAtTime(f,now+i*0.001);
      osc.connect(gain);
      osc.start(now);
      osc.stop(now+dur+release);
    });
  }catch(e){}
}

function sfxSeq(notes, gap=0.08){
  // notes: [{freq,dur,vol,type}]
  if(sfxMuted) return;
  try{
    const ac=getAC(), now=ac.currentTime;
    let t=now;
    notes.forEach(n=>{
      const gain=ac.createGain();
      gain.connect(ac.destination);
      gain.gain.setValueAtTime(0,t);
      gain.gain.linearRampToValueAtTime(n.vol||0.15,t+0.01);
      gain.gain.exponentialRampToValueAtTime(0.001,t+(n.dur||0.15));
      const osc=ac.createOscillator();
      osc.type=n.type||'sine';
      osc.frequency.setValueAtTime(n.freq,t);
      osc.connect(gain);
      osc.start(t);
      osc.stop(t+(n.dur||0.15)+0.05);
      t+=gap+(n.dur||0.15);
    });
  }catch(e){}
}

function sfxNoise(vol=0.1, dur=0.12, filter=800){
  if(sfxMuted) return;
  try{
    const ac=getAC(), now=ac.currentTime;
    const buf=ac.createBuffer(1,ac.sampleRate*dur,ac.sampleRate);
    const d=buf.getChannelData(0);
    for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1);
    const src=ac.createBufferSource(); src.buffer=buf;
    const bq=ac.createBiquadFilter(); bq.type='bandpass'; bq.frequency.value=filter;
    const gain=ac.createGain();
    gain.gain.setValueAtTime(vol,now);
    gain.gain.exponentialRampToValueAtTime(0.001,now+dur);
    src.connect(bq); bq.connect(gain); gain.connect(ac.destination);
    src.start(now); src.stop(now+dur+0.05);
  }catch(e){}
}

// â”€â”€ Named sound effects â”€â”€
const SFX = {
  // Button click â€” subtle tick
  click(){    sfxTone([900,700],'square',0.06,0.07,0.005,0.05); },

  // Answer submitted by player
  submit(){   sfxTone([440,550],'sine',0.12,0.12,0.01,0.08); },

  // Correct answer revealed
  correct(){
    sfxSeq([
      {freq:523,dur:0.10,vol:0.18,type:'sine'},
      {freq:659,dur:0.10,vol:0.18,type:'sine'},
      {freq:784,dur:0.18,vol:0.20,type:'sine'},
    ],0.05);
  },

  // Wrong answer
  wrong(){
    sfxSeq([
      {freq:300,dur:0.12,vol:0.14,type:'sawtooth'},
      {freq:220,dur:0.18,vol:0.14,type:'sawtooth'},
    ],0.04);
  },

  // No answer / time out
  noAnswer(){ sfxTone([200,180],'triangle',0.08,0.25,0.01,0.20); },

  // Rope pull â€” whoosh
  pull(){
    sfxNoise(0.18,0.22,600);
    sfxTone([120,80],'sine',0.12,0.20,0.01,0.15);
  },

  // Both teams correct â€” speed tie
  bothCorrect(){
    sfxSeq([
      {freq:440,dur:0.08,vol:0.14,type:'sine'},
      {freq:554,dur:0.08,vol:0.14,type:'sine'},
      {freq:659,dur:0.12,vol:0.16,type:'sine'},
    ],0.04);
  },

  // Power pull (4+ streak)
  powerPull(){
    sfxNoise(0.22,0.15,400);
    sfxSeq([
      {freq:150,dur:0.10,vol:0.16,type:'sawtooth'},
      {freq:200,dur:0.10,vol:0.18,type:'sawtooth'},
      {freq:280,dur:0.15,vol:0.20,type:'sawtooth'},
    ],0.04);
  },

  // Timer ticking â€” plays each second under 6s
  tick(){     sfxTone([880],'square',0.06,0.04,0.002,0.03); },

  // Timer urgent â€” last 3 seconds
  tickUrgent(){ sfxTone([1100],'square',0.10,0.05,0.002,0.04); },

  // Round end
  roundEnd(){
    sfxSeq([
      {freq:392,dur:0.12,vol:0.16,type:'triangle'},
      {freq:330,dur:0.12,vol:0.16,type:'triangle'},
      {freq:262,dur:0.22,vol:0.18,type:'triangle'},
    ],0.05);
  },

  // Victory fanfare
  victory(){
    sfxSeq([
      {freq:523,dur:0.10,vol:0.18,type:'sine'},
      {freq:659,dur:0.10,vol:0.18,type:'sine'},
      {freq:784,dur:0.10,vol:0.18,type:'sine'},
      {freq:1047,dur:0.28,vol:0.22,type:'sine'},
    ],0.06);
    setTimeout(()=>sfxSeq([
      {freq:784,dur:0.10,vol:0.15,type:'sine'},
      {freq:1047,dur:0.22,vol:0.18,type:'sine'},
    ],0.07),420);
  },

  // Defeat sound â€” descending sad tones
  lose(){
    sfxSeq([
      {freq:392,dur:0.12,vol:0.16,type:'sine'},
      {freq:330,dur:0.14,vol:0.16,type:'sine'},
      {freq:262,dur:0.14,vol:0.15,type:'sine'},
      {freq:196,dur:0.30,vol:0.18,type:'sine'},
    ],0.06);
  },

  // Low heartbeat thump â€” plays at 10â†’7s for tension
  heartbeat(){
    sfxTone([60,55],'sine',0.14,0.10,0.005,0.09);
    setTimeout(()=>sfxTone([55,50],'sine',0.10,0.08,0.005,0.07),160);
  },

  // Wrong reveal for clients
  wrongReveal(){
    sfxSeq([
      {freq:280,dur:0.10,vol:0.12,type:'sawtooth'},
      {freq:200,dur:0.20,vol:0.13,type:'sawtooth'},
    ],0.04);
  },
  countdown(){ sfxTone([660],'sine',0.16,0.14,0.005,0.10); },

  // GO!
  go(){
    sfxSeq([
      {freq:523,dur:0.08,vol:0.20,type:'square'},
      {freq:784,dur:0.08,vol:0.20,type:'square'},
      {freq:1047,dur:0.18,vol:0.22,type:'square'},
    ],0.03);
  },

  // Power-up activated
  powerup(key){
    if(key==='shield')  sfxSeq([{freq:400,dur:0.08,vol:0.16,type:'sine'},{freq:600,dur:0.14,vol:0.18,type:'sine'}],0.06);
    else if(key==='double') sfxSeq([{freq:500,dur:0.08,vol:0.16,type:'sawtooth'},{freq:700,dur:0.08,vol:0.18,type:'sawtooth'},{freq:900,dur:0.14,vol:0.20,type:'sawtooth'}],0.05);
    else if(key==='freeze') sfxSeq([{freq:800,dur:0.06,vol:0.14,type:'sine'},{freq:1000,dur:0.06,vol:0.14,type:'sine'},{freq:1200,dur:0.12,vol:0.16,type:'sine'}],0.04);
  },

  // Sudden death sting
  suddenDeath(){
    sfxNoise(0.25,0.18,300);
    setTimeout(()=>sfxSeq([
      {freq:220,dur:0.10,vol:0.18,type:'sawtooth'},
      {freq:180,dur:0.22,vol:0.20,type:'sawtooth'},
    ],0.05),80);
  },
};

// Mute toggle button (injected into game UI)
function initMuteButton(){
  const btn=document.createElement('button');
  btn.id='sfx-mute-btn';
  btn.title='Toggle sound';
  btn.style.cssText='position:fixed;bottom:16px;right:16px;z-index:999;background:rgba(255,255,255,0.15);border:2px solid rgba(255,255,255,0.3);border-radius:50%;width:40px;height:40px;font-size:18px;cursor:pointer;backdrop-filter:blur(8px);transition:all .15s;';
  btn.textContent=sfxMuted?'ğŸ”‡':'ğŸ”Š';
  btn.onclick=()=>{
    sfxMuted=!sfxMuted;
    localStorage.setItem('quizzo_mute',sfxMuted?'1':'0');
    btn.textContent=sfxMuted?'ğŸ”‡':'ğŸ”Š';
    if(sfxMuted){
      stopLobbyMusic(0.3);
      if(typeof stopMatchMusic==='function') stopMatchMusic(0.3);
    } else {
      SFX.click();
      // Restart appropriate music based on current screen
      const active = document.querySelector('.screen.active');
      if(active){
        if(['s-portal','s-host','s-join','s-pin','s-lineup'].includes(active.id)) startLobbyMusic();
        if(['s-game','s-round'].includes(active.id) && typeof startMatchMusic==='function' && !_matchPlaying) startMatchMusic();
      }
    }
  };
  document.body.appendChild(btn);
}
initMuteButton();

// Timer tick hook â€” fires from the wall-clock timer loop
let _lastTickSec = -1;
function maybeSfxTick(remaining){
  const s = Math.ceil(remaining);
  if(s !== _lastTickSec && s > 0){
    _lastTickSec = s;
    if(s <= 3)       SFX.tickUrgent();          // sharp high beep â€” last 3s
    else if(s <= 6)  SFX.tick();                // quick tick â€” 6-4s
    else if(s <= 10) SFX.heartbeat();           // low thump â€” 10-7s builds tension
  }
  if(remaining <= 0) _lastTickSec = -1;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOBBY MUSIC ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _lobbyNodes = null;   // holds all active lobby audio nodes
let _lobbyPlaying = false;
let _lobbyTimeout = null;

function startLobbyMusic(){
  if(sfxMuted || _lobbyPlaying) return;
  try{
    const ac = getAC();
    _lobbyPlaying = true;
    _lobbyNodes = [];

    // Master gain (for fade in/out)
    const master = ac.createGain();
    master.gain.setValueAtTime(0, ac.currentTime);
    master.gain.linearRampToValueAtTime(0.22, ac.currentTime + 1.2);
    master.connect(ac.destination);
    _lobbyNodes.push(master);

    // === BASS PULSE ===
    // Low sine that pulses rhythmically via LFO
    const bass = ac.createOscillator();
    bass.type = 'sine';
    bass.frequency.setValueAtTime(55, ac.currentTime);
    const bassGain = ac.createGain();
    bassGain.gain.setValueAtTime(0.5, ac.currentTime);
    bass.connect(bassGain); bassGain.connect(master);
    bass.start();
    _lobbyNodes.push(bass, bassGain);

    // Pulse LFO for bass (creates rhythmic throb ~120bpm)
    const bassLFO = ac.createOscillator();
    bassLFO.type = 'sine';
    bassLFO.frequency.setValueAtTime(2.0, ac.currentTime); // 2 Hz = 120bpm
    const bassLFOGain = ac.createGain();
    bassLFOGain.gain.setValueAtTime(0.45, ac.currentTime);
    bassLFO.connect(bassLFOGain); bassLFOGain.connect(bassGain.gain);
    bassLFO.start();
    _lobbyNodes.push(bassLFO, bassLFOGain);

    // === CHORD PAD ===
    // Three detuned oscillators for a warm pad chord (C minor feel)
    const padFreqs = [131, 156, 196, 233]; // C3 Eb3 G3 Bb3
    padFreqs.forEach((f, i) => {
      const osc = ac.createOscillator();
      osc.type = 'sawtooth';
      osc.frequency.setValueAtTime(f, ac.currentTime);
      osc.detune.setValueAtTime((i % 2 === 0 ? -8 : 8), ac.currentTime);
      const g = ac.createGain();
      g.gain.setValueAtTime(0.04, ac.currentTime);
      // Low-pass filter to smooth the sawtooth
      const filt = ac.createBiquadFilter();
      filt.type = 'lowpass';
      filt.frequency.setValueAtTime(600 + i*80, ac.currentTime);
      filt.Q.setValueAtTime(1.5, ac.currentTime);
      osc.connect(filt); filt.connect(g); g.connect(master);
      osc.start();
      _lobbyNodes.push(osc, g, filt);
    });

    // Filter sweep LFO (slowly opens and closes the filter for movement)
    const sweepLFO = ac.createOscillator();
    sweepLFO.type = 'sine';
    sweepLFO.frequency.setValueAtTime(0.12, ac.currentTime); // very slow sweep
    const sweepGain = ac.createGain();
    sweepGain.gain.setValueAtTime(300, ac.currentTime);
    sweepLFO.connect(sweepGain);
    sweepLFO.start();
    _lobbyNodes.push(sweepLFO, sweepGain);

    // === ARPEGGIO ===
    // Bright plucky arpeggio pattern on top
    const arpNotes = [523, 659, 784, 1047, 784, 659, 523, 392]; // C major arp
    const arpBpm = 120;
    const arpStep = 60 / arpBpm / 2; // 8th notes
    let arpIdx = 0;

    function scheduleArp(){
      if(!_lobbyPlaying) return;
      try{
        const now = ac.currentTime;
        const freq = arpNotes[arpIdx % arpNotes.length];
        arpIdx++;

        const o = ac.createOscillator();
        o.type = 'triangle';
        o.frequency.setValueAtTime(freq, now);
        const g = ac.createGain();
        g.gain.setValueAtTime(0, now);
        g.gain.linearRampToValueAtTime(0.07, now + 0.015);
        g.gain.exponentialRampToValueAtTime(0.001, now + arpStep * 0.7);
        const flt = ac.createBiquadFilter();
        flt.type = 'bandpass';
        flt.frequency.setValueAtTime(freq, now);
        flt.Q.setValueAtTime(2, now);
        o.connect(flt); flt.connect(g); g.connect(master);
        o.start(now); o.stop(now + arpStep);

        _lobbyTimeout = setTimeout(scheduleArp, arpStep * 1000);
      }catch(e){ _lobbyPlaying = false; }
    }
    scheduleArp();

    // === HI-HAT RHYTHM ===
    // Percussive noise hits on beat
    function scheduleHat(){
      if(!_lobbyPlaying) return;
      try{
        const now = ac.currentTime;
        const buf = ac.createBuffer(1, ac.sampleRate * 0.04, ac.sampleRate);
        const d = buf.getChannelData(0);
        for(let i = 0; i < d.length; i++) d[i] = (Math.random() * 2 - 1);
        const src = ac.createBufferSource(); src.buffer = buf;
        const flt = ac.createBiquadFilter(); flt.type = 'highpass'; flt.frequency.value = 8000;
        const g = ac.createGain();
        g.gain.setValueAtTime(0.04, now);
        g.gain.exponentialRampToValueAtTime(0.001, now + 0.04);
        src.connect(flt); flt.connect(g); g.connect(master);
        src.start(now);
        setTimeout(scheduleHat, 500); // quarter-note hi-hat
      }catch(e){ _lobbyPlaying = false; }
    }
    setTimeout(scheduleHat, 250); // offset hi-hat slightly

  }catch(e){ _lobbyPlaying = false; }
}

function stopLobbyMusic(fadeDuration = 0.8){
  if(!_lobbyPlaying) return;
  _lobbyPlaying = false;
  clearTimeout(_lobbyTimeout);
  if(_lobbyNodes){
    try{
      const ac = getAC();
      const now = ac.currentTime;
      // Fade master gain to 0
      _lobbyNodes.forEach(n=>{
        if(n && n.gain && typeof n.gain.cancelScheduledValues === 'function'){
          try{
            n.gain.cancelScheduledValues(now);
            n.gain.setValueAtTime(n.gain.value, now);
            n.gain.linearRampToValueAtTime(0, now + fadeDuration);
          }catch(e){}
        }
        // Stop oscillators after fade
        if(n && typeof n.stop === 'function'){
          try{ n.stop(now + fadeDuration + 0.05); }catch(e){}
        }
      });
    }catch(e){}
    setTimeout(()=>{ _lobbyNodes = null; }, (fadeDuration + 0.1) * 1000);
  }
}

// Start lobby music on first user interaction (browsers require a gesture before AudioContext)
let _musicStarted = false;
function _tryStartLobbyMusic(){
  if(_musicStarted || sfxMuted) return;
  _musicStarted = true;
  try{
    // Create context now (inside a user gesture â€” guaranteed to work)
    if(!_ac) _ac = new (window.AudioContext||window.webkitAudioContext)();
    const resume = _ac.state === 'suspended' ? _ac.resume() : Promise.resolve();
    resume.then(()=>{ if(!_lobbyPlaying) startLobbyMusic(); });
  }catch(e){ _musicStarted = false; }
}
// Capture on every possible first gesture
['pointerdown','touchstart','click','keydown'].forEach(evt=>{
  window.addEventListener(evt, _tryStartLobbyMusic, {once:false, capture:true, passive:true});
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MATCH MUSIC ENGINE (in-game â€” energetic)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _matchNodes = null;
let _matchPlaying = false;
let _matchTimeouts = [];

function startMatchMusic(){
  if(sfxMuted || _matchPlaying) return;
  try{
    const ac = getAC();
    _matchPlaying = true;
    _matchNodes = [];
    _matchTimeouts = [];

    // Master gain â€” fade in
    const master = ac.createGain();
    master.gain.setValueAtTime(0, ac.currentTime);
    master.gain.linearRampToValueAtTime(0.18, ac.currentTime + 1.0);
    master.connect(ac.destination);
    _matchNodes.push(master);

    // === DRIVING BASS LINE ===
    // Faster bass at 140bpm with walking pattern
    const bassNotes = [55, 55, 65, 73, 55, 55, 49, 55]; // walking bass
    const bpm = 140;
    const beat = 60 / bpm;
    let bIdx = 0;

    function scheduleBass(){
      if(!_matchPlaying) return;
      try{
        const now = ac.currentTime;
        const freq = bassNotes[bIdx % bassNotes.length];
        bIdx++;
        const o = ac.createOscillator();
        o.type = 'square';
        o.frequency.setValueAtTime(freq, now);
        const g = ac.createGain();
        g.gain.setValueAtTime(0, now);
        g.gain.linearRampToValueAtTime(0.3, now + 0.01);
        g.gain.exponentialRampToValueAtTime(0.001, now + beat * 0.8);
        const flt = ac.createBiquadFilter();
        flt.type = 'lowpass'; flt.frequency.value = 300; flt.Q.value = 2;
        o.connect(flt); flt.connect(g); g.connect(master);
        o.start(now); o.stop(now + beat);
        const t = setTimeout(scheduleBass, beat * 1000);
        _matchTimeouts.push(t);
      }catch(e){ _matchPlaying = false; }
    }
    scheduleBass();

    // === CHORD STABS ===
    // Short punchy chord hits on the 1 and 3 of every bar
    const chordFreqs = [
      [196, 247, 294], // G4 B4 D5
      [220, 277, 330], // A4 C#5 E5
      [175, 220, 262], // F4 A4 C5
      [196, 247, 294], // G4 B4 D5
    ];
    let cIdx = 0;
    const barLen = beat * 4;

    function scheduleChord(){
      if(!_matchPlaying) return;
      try{
        const now = ac.currentTime;
        const chord = chordFreqs[cIdx % chordFreqs.length];
        cIdx++;
        chord.forEach(freq => {
          const o = ac.createOscillator();
          o.type = 'sawtooth';
          o.frequency.setValueAtTime(freq, now);
          const g = ac.createGain();
          g.gain.setValueAtTime(0, now);
          g.gain.linearRampToValueAtTime(0.06, now + 0.01);
          g.gain.exponentialRampToValueAtTime(0.001, now + beat * 1.5);
          const flt = ac.createBiquadFilter();
          flt.type = 'lowpass'; flt.frequency.value = 1200; flt.Q.value = 1;
          o.connect(flt); flt.connect(g); g.connect(master);
          o.start(now); o.stop(now + beat * 2);
        });
        const t = setTimeout(scheduleChord, barLen * 1000);
        _matchTimeouts.push(t);
      }catch(e){ _matchPlaying = false; }
    }
    scheduleChord();

    // === MELODY / LEAD ===
    // Upbeat lead melody line
    const melodyNotes = [784,784,880,784,659,698,784,0,784,784,880,1047,988,880,784,0];
    const mStep = beat / 2; // 8th notes
    let mIdx = 0;

    function scheduleMelody(){
      if(!_matchPlaying) return;
      try{
        const now = ac.currentTime;
        const freq = melodyNotes[mIdx % melodyNotes.length];
        mIdx++;
        if(freq > 0){
          const o = ac.createOscillator();
          o.type = 'triangle';
          o.frequency.setValueAtTime(freq, now);
          const g = ac.createGain();
          g.gain.setValueAtTime(0, now);
          g.gain.linearRampToValueAtTime(0.08, now + 0.01);
          g.gain.exponentialRampToValueAtTime(0.001, now + mStep * 0.85);
          const flt = ac.createBiquadFilter();
          flt.type = 'bandpass'; flt.frequency.value = freq; flt.Q.value = 3;
          o.connect(flt); flt.connect(g); g.connect(master);
          o.start(now); o.stop(now + mStep);
        }
        const t = setTimeout(scheduleMelody, mStep * 1000);
        _matchTimeouts.push(t);
      }catch(e){ _matchPlaying = false; }
    }
    scheduleMelody();

    // === KICK DRUM ===
    function scheduleKick(){
      if(!_matchPlaying) return;
      try{
        const now = ac.currentTime;
        const o = ac.createOscillator();
        o.type = 'sine';
        o.frequency.setValueAtTime(150, now);
        o.frequency.exponentialRampToValueAtTime(50, now + 0.1);
        const g = ac.createGain();
        g.gain.setValueAtTime(0.5, now);
        g.gain.exponentialRampToValueAtTime(0.001, now + 0.15);
        o.connect(g); g.connect(master);
        o.start(now); o.stop(now + 0.2);
        const t = setTimeout(scheduleKick, beat * 2 * 1000); // on beats 1 and 3
        _matchTimeouts.push(t);
      }catch(e){ _matchPlaying = false; }
    }
    scheduleKick();

    // === SNARE ===
    function scheduleSnare(){
      if(!_matchPlaying) return;
      try{
        const now = ac.currentTime;
        const buf = ac.createBuffer(1, ac.sampleRate * 0.12, ac.sampleRate);
        const d = buf.getChannelData(0);
        for(let i = 0; i < d.length; i++) d[i] = (Math.random() * 2 - 1);
        const src = ac.createBufferSource(); src.buffer = buf;
        const flt = ac.createBiquadFilter(); flt.type = 'bandpass'; flt.frequency.value = 2500; flt.Q.value = 0.5;
        const g = ac.createGain();
        g.gain.setValueAtTime(0.15, now);
        g.gain.exponentialRampToValueAtTime(0.001, now + 0.12);
        src.connect(flt); flt.connect(g); g.connect(master);
        src.start(now);
        const t = setTimeout(scheduleSnare, beat * 2 * 1000); // on beats 2 and 4
        _matchTimeouts.push(t);
      }catch(e){ _matchPlaying = false; }
    }
    setTimeout(scheduleSnare, beat * 1000); // offset by 1 beat = beats 2 & 4

    // === OPEN HI-HAT ===
    function scheduleHH(){
      if(!_matchPlaying) return;
      try{
        const now = ac.currentTime;
        const buf = ac.createBuffer(1, ac.sampleRate * 0.05, ac.sampleRate);
        const d = buf.getChannelData(0);
        for(let i = 0; i < d.length; i++) d[i] = (Math.random() * 2 - 1);
        const src = ac.createBufferSource(); src.buffer = buf;
        const flt = ac.createBiquadFilter(); flt.type = 'highpass'; flt.frequency.value = 9000;
        const g = ac.createGain();
        g.gain.setValueAtTime(0.05, now);
        g.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
        src.connect(flt); flt.connect(g); g.connect(master);
        src.start(now);
        const t = setTimeout(scheduleHH, beat * 500); // 8th note hi-hat
        _matchTimeouts.push(t);
      }catch(e){ _matchPlaying = false; }
    }
    scheduleHH();

  }catch(e){ _matchPlaying = false; }
}

function stopMatchMusic(fadeDuration = 0.8){
  if(!_matchPlaying) return;
  _matchPlaying = false;
  _matchTimeouts.forEach(t => clearTimeout(t));
  _matchTimeouts = [];
  if(_matchNodes){
    try{
      const ac = getAC();
      const now = ac.currentTime;
      _matchNodes.forEach(n=>{
        if(n && n.gain && typeof n.gain.cancelScheduledValues === 'function'){
          try{
            n.gain.cancelScheduledValues(now);
            n.gain.setValueAtTime(n.gain.value, now);
            n.gain.linearRampToValueAtTime(0, now + fadeDuration);
          }catch(e){}
        }
        if(n && typeof n.stop === 'function'){
          try{ n.stop(now + fadeDuration + 0.05); }catch(e){}
        }
      });
    }catch(e){}
    setTimeout(()=>{ _matchNodes = null; }, (fadeDuration + 0.1) * 1000);
  }
}

document.getElementById('btn-join-card').addEventListener('click',()=>{
  SFX.click();
  // Reset join form state
  const nameInp=document.getElementById('inp-join-name');
  const joinBtn=document.getElementById('btn-join');
  const err=document.getElementById('join-error');
  if(nameInp){ nameInp.value=''; nameInp.style.borderColor=''; nameInp.style.boxShadow=''; }
  if(joinBtn) joinBtn.disabled=true;
  if(err) err.classList.remove('show');
  showScreen('s-join');
});
document.getElementById('back-from-host').addEventListener('click',()=>{
  clearInterval(lobbyPollInterval);
  if(ROOM_CODE) clearRoom(ROOM_CODE);
  showScreen('s-portal'); requestAnimationFrame(animPortal);
});
document.getElementById('back-from-join').addEventListener('click',()=>{showScreen('s-portal');requestAnimationFrame(animPortal);});
document.getElementById('btn-join').addEventListener('click',()=>{ SFX.click(); joinRoom(); });

document.getElementById('code-input').addEventListener('keydown',e=>{if(e.key==='Enter')joinRoom();});
document.getElementById('code-input').addEventListener('input',e=>{e.target.value=e.target.value.toUpperCase().replace(/[^A-Z0-9]/g,'');});
document.getElementById('btn-start-host').addEventListener('click',()=>{ SFX.click(); launchGame(); });
document.getElementById('btn-rematch').addEventListener('click',()=>{
  SFX.click();
  if(ROLE!=='host') return;
  G.players.forEach(p=>{p.score=0;p.streak=0;p.mult=1;p.correct=0;p.answered=0;p.lastAns=null;});
  G.blueScore=0;G.redScore=0;G.blueRoundScore=0;G.redRoundScore=0;
  G.roundWins={blue:0,red:0};G.roundHistory=[];G.questionLog=[];
  G.currentRound=1;G.currentQ=0;G.rope=0.5;ropeTarget=0.5;G.locked=false;
  G.blueAnswers={};G.redAnswers={};
  G_suddenDeath=false; myPowerups={shield:0,double:0,freeze:0}; activePowerups={blue:{},red:{}};
  G.questions=shufflePool();
  enterGame();
  const rematchReadyStart = Date.now() + BETWEEN_Q_DELAY;
  G.qStartTime = rematchReadyStart;
  const rematchReadyRoom = buildRoomState('ready');
  rematchReadyRoom.qStartTime = rematchReadyStart;
  writeRoom(rematchReadyRoom);
  showReadyOverlay(BETWEEN_Q_DELAY / 1000, `Q 1 of ${G.questions.length}`);
  function tickRematch(){
    const remaining = (rematchReadyStart - Date.now()) / 1000;
    const numEl = document.getElementById('ready-num');
    if(numEl) numEl.textContent = Math.max(0, Math.ceil(remaining));
    if(remaining <= 0){
      hideReadyOverlay();
      const room = buildRoomState('playing');
      room.qStartTime = rematchReadyStart;
      writeRoom(room); startTimer(true);
      return;
    }
    setTimeout(tickRematch, 200);
  }
  tickRematch();
});
document.getElementById('btn-view-analytics').addEventListener('click',()=>{ SFX.click(); buildAnalytics(); });
document.getElementById('btn-report-card').addEventListener('click',()=>{ SFX.click(); buildReportCards(); });
document.getElementById('btn-back-lobby').addEventListener('click',()=>{
  SFX.click();
  clearInterval(G.timerID);clearInterval(answerPoll);clearInterval(lobbyPollInterval);
  if(ROOM_CODE) clearRoom(ROOM_CODE);
  if(ropeRAF) cancelAnimationFrame(ropeRAF);
  ROLE=null;ROOM_CODE=null;
  document.getElementById('role-badge').style.display='none';
  showScreen('s-portal');initPortal();requestAnimationFrame(animPortal);
});
document.getElementById('back-from-analytics').addEventListener('click',()=>showScreen('s-victory'));
document.getElementById('inp-blue').addEventListener('input',()=>{ G.blueN=document.getElementById('inp-blue').value.trim().toUpperCase()||'APEX'; });
document.getElementById('inp-red').addEventListener('input',()=>{ G.redN=document.getElementById('inp-red').value.trim().toUpperCase()||'VORTEX'; });
window.addEventListener('resize',()=>{resizeRope();pc.width=window.innerWidth;pc.height=window.innerHeight;});

// Projection mode
let projMode=false;
function toggleProjection(){
  projMode=!projMode;
  document.body.classList.toggle('projection',projMode);
  document.getElementById('proj-toggle').textContent=projMode?'EXIT PROJECTION':'PROJECTION MODE';
}
const obs=new MutationObserver(()=>{
  const gameActive=document.getElementById('s-game').classList.contains('active');
  document.getElementById('proj-toggle').classList.toggle('visible',gameActive);
});
obs.observe(document.getElementById('s-game'),{attributes:true,attributeFilter:['class']});
</script>

<!-- â•â• PIN SYSTEM â•â• -->
<script>
// â”€â”€ Storage keys â”€â”€
const PIN_KEY      = 'quizzo_pin_h';
const PASS_KEY     = 'quizzo_pass_h';
const RECOVERY_KEY = 'quizzo_recovery_h';
const LOCKOUT_KEY  = 'quizzo_lockout';

// â”€â”€ State â”€â”€
let pinAuthed = false, pinVisible = false;
let pinStep = 1;
let pinBuf1='', pinBuf2='', pinBufL='', pinBufR1='', pinBufR2='';
let lockoutTimer = null;

// â”€â”€ Crypto â”€â”€
async function sha256(str){
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

// â”€â”€ Storage helpers â”€â”€
function getH(key){ try{ return localStorage.getItem(key)||''; }catch(e){ return ''; } }
function setH(key,v){ try{ localStorage.setItem(key,v); }catch(e){} }
function delH(key){ try{ localStorage.removeItem(key); }catch(e){} }
function isSetUp(){ return !!(getH(PIN_KEY) && getH(PASS_KEY)); }

// â”€â”€ Recovery code â”€â”€
function genRecoveryCode(){
  const ch = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  return Array.from(crypto.getRandomValues(new Uint8Array(8))).map(b=>ch[b%ch.length]).join('');
}

// â”€â”€ Lockout â”€â”€
function getLockout(){ try{ return JSON.parse(localStorage.getItem(LOCKOUT_KEY))||{attempts:0,until:0}; }catch(e){ return {attempts:0,until:0}; } }
function saveLockout(o){ try{ localStorage.setItem(LOCKOUT_KEY,JSON.stringify(o)); }catch(e){} }
function clearLockout(){ try{ localStorage.removeItem(LOCKOUT_KEY); }catch(e){} }
function checkLockout(){ const l=getLockout(); return l.until>Date.now()?l.until:0; }
function recordFailedAttempt(){
  const l=getLockout(); l.attempts=(l.attempts||0)+1;
  if(l.attempts>=3){ l.until=Date.now()+30000; l.attempts=0; saveLockout(l); return true; }
  saveLockout(l); return false;
}
function startLockoutUI(until){
  const np=document.getElementById('pin-numpad'), lw=document.getElementById('pin-lockout-wrap');
  if(np) np.style.pointerEvents='none';
  if(lw) lw.style.display='block';
  if(lockoutTimer) clearInterval(lockoutTimer);
  lockoutTimer=setInterval(()=>{
    const rem=Math.max(0,Math.ceil((until-Date.now())/1000));
    const el=document.getElementById('pin-lockout-timer'); if(el) el.textContent=rem;
    if(rem<=0){ clearInterval(lockoutTimer); lockoutTimer=null; if(np) np.style.pointerEvents=''; if(lw) lw.style.display='none'; hidePinMsg(); }
  },250);
}

// â”€â”€ UI helpers â”€â”€
function getPinDots(){ return document.querySelectorAll('#pin-dots .pin-dot'); }
function renderPinDots(buf,state){
  getPinDots().forEach((d,i)=>{ d.className='pin-dot'; if(i<buf.length) d.classList.add(state==='error'?'error-dot':state==='match'?'match':'filled'); });
}
function showPinMsg(txt,type){
  const el=document.getElementById('pin-msg'); el.textContent=txt; el.style.display='block';
  const s={err:{color:'var(--red)',background:'#ffe8ec',border:'2px solid var(--red-light)'},ok:{color:'var(--green)',background:'#e8f9e0',border:'2px solid var(--green-light)'},info:{color:'var(--blue)',background:'#e8f4ff',border:'2px solid var(--blue-light)'}};
  Object.assign(el.style,s[type]||s.info); el.style.borderRadius='var(--r10)';
}
function hidePinMsg(){ const el=document.getElementById('pin-msg'); el.textContent=''; el.style.display='none'; }
function showNumpad(){ document.getElementById('pin-numpad').style.display=''; }
function hideNumpad(){ document.getElementById('pin-numpad').style.display='none'; }
function showPassInput(){
  document.getElementById('pin-passphrase-wrap').style.display='';
  setTimeout(()=>document.getElementById('pin-passphrase-input').focus(),100);
}
function hidePassInput(){ document.getElementById('pin-passphrase-wrap').style.display='none'; }
function togglePassphraseVis(){ const i=document.getElementById('pin-passphrase-input'); i.type=i.type==='password'?'text':'password'; }

// â”€â”€ Init â”€â”€
function initPinScreen(){
  pinBuf1=''; pinBuf2=''; pinBufL=''; pinBufR1=''; pinBufR2='';
  hidePinMsg(); renderPinDots('','normal'); hidePassInput(); showNumpad();
  document.getElementById('pin-recovery-wrap').style.display='none';
  document.getElementById('pin-lockout-wrap').style.display='none';
  document.getElementById('pin-numpad').style.pointerEvents='';
  const lockedUntil=checkLockout(); if(lockedUntil) startLockoutUI(lockedUntil);
  if(!isSetUp()){
    pinStep=1;
    document.getElementById('pin-screen-title').textContent='SET HOST PIN';
    document.getElementById('pin-screen-desc').innerHTML='Create a 4-digit PIN to secure your host session.<br><strong style="color:var(--blue);">Only share with trusted co-hosts.</strong>';
    document.getElementById('pin-step-lbl').textContent='STEP 1 OF 3 â€” SET PIN';
  } else {
    pinStep='login';
    document.getElementById('pin-screen-title').textContent='HOST LOGIN';
    document.getElementById('pin-screen-desc').innerHTML='Enter your host PIN to access the dashboard.<br><span style="font-size:11px;color:var(--text-mid);">Forgot? <span style="color:var(--blue);cursor:pointer;font-weight:800;text-decoration:underline;" onclick="startResetFlow()">Reset PIN</span></span>';
    document.getElementById('pin-step-lbl').textContent='ENTER YOUR HOST PIN';
  }
}

// â”€â”€ Reset flow â”€â”€
function startResetFlow(){
  pinStep='reset-verify-pin'; pinBufR1='';
  hidePinMsg(); renderPinDots('','normal'); hidePassInput(); showNumpad();
  document.getElementById('pin-screen-title').textContent='RESET PIN';
  document.getElementById('pin-screen-desc').innerHTML='Confirm your <strong>current PIN</strong> to proceed.<br><span style="font-size:11px;color:var(--text-mid);">No access? <span style="color:var(--blue);cursor:pointer;font-weight:800;text-decoration:underline;" onclick="startRecoveryFlow()">Use recovery code</span></span>';
  document.getElementById('pin-step-lbl').textContent='STEP 1 OF 3 â€” CURRENT PIN';
}

function startRecoveryFlow(){
  pinStep='recovery';
  hidePinMsg(); renderPinDots('','normal'); hideNumpad();
  document.getElementById('pin-screen-title').textContent='RECOVERY';
  document.getElementById('pin-screen-desc').innerHTML='Enter your 8-character recovery code.<br><span style="font-size:11px;color:var(--red);font-weight:700;">This will wipe all host credentials.</span>';
  document.getElementById('pin-step-lbl').textContent='ENTER RECOVERY CODE';
  const inp=document.getElementById('pin-passphrase-input');
  inp.type='text'; inp.maxLength=8; inp.value=''; inp.placeholder='Recovery codeâ€¦';
  const btn=document.getElementById('pin-passphrase-btn');
  btn.textContent='VERIFY CODE'; btn.onclick=submitRecoveryCode;
  showPassInput();
}

async function submitRecoveryCode(){
  const code=document.getElementById('pin-passphrase-input').value.trim().toUpperCase();
  if(code.length<8){ showPinMsg('Enter the full 8-character code','err'); return; }
  const h=await sha256(code);
  if(h===getH(RECOVERY_KEY)){
    delH(PIN_KEY); delH(PASS_KEY); delH(RECOVERY_KEY); clearLockout();
    showPinMsg('Credentials reset â€” please set a new PIN','ok');
    setTimeout(()=>initPinScreen(),1200);
  } else { showPinMsg('Incorrect recovery code','err'); }
}

async function submitPassphrase(){
  const pass=document.getElementById('pin-passphrase-input').value.trim();
  if(pass.length<4){ showPinMsg('Passphrase must be at least 4 characters','err'); return; }
  if(pinStep==='pass-set'){
    const passH=await sha256(pass), pinH=await sha256(pinBuf1);
    const rc=genRecoveryCode(), rcH=await sha256(rc);
    setH(PIN_KEY,pinH); setH(PASS_KEY,passH); setH(RECOVERY_KEY,rcH); clearLockout();
    hidePassInput(); hideNumpad();
    document.getElementById('pin-recovery-code').textContent=rc;
    document.getElementById('pin-recovery-wrap').style.display='block';
    document.getElementById('pin-screen-title').textContent='SAVE RECOVERY CODE';
    document.getElementById('pin-step-lbl').textContent='STEP 3 OF 3';
    document.getElementById('pin-screen-desc').textContent='Shown only once â€” store it safely!';
    window._pendingRC=rc;
  } else if(pinStep==='reset-verify-pass'){
    const h=await sha256(pass);
    if(h!==getH(PASS_KEY)){ showPinMsg('Incorrect passphrase','err'); return; }
    pinStep='reset-set'; pinBufR1='';
    hidePassInput(); showNumpad(); renderPinDots('','normal'); hidePinMsg();
    document.getElementById('pin-screen-title').textContent='RESET PIN';
    document.getElementById('pin-step-lbl').textContent='STEP 3 OF 3 â€” NEW PIN';
    document.getElementById('pin-screen-desc').innerHTML='Enter your new 4-digit PIN.';
  }
}

function copyRecoveryCode(){ navigator.clipboard?.writeText(window._pendingRC||'').then(()=>showPinMsg('Copied!','ok')).catch(()=>{}); }
function dismissRecoveryCode(){
  window._pendingRC='';
  document.getElementById('pin-recovery-wrap').style.display='none';
  pinAuthed=true; SESSION_PIN=pinBuf1;
  showPinMsg('All set! Entering host panelâ€¦','ok');
  setTimeout(()=>enterHostSetup(),700);
}

// â”€â”€ Main key handler â”€â”€
function handlePinKey(val){
  const lu=checkLockout(); if(lu){ startLockoutUI(lu); return; }
  hidePinMsg();
  if(pinStep===1){
    if(val==='del'){ pinBuf1=pinBuf1.slice(0,-1); renderPinDots(pinBuf1,'normal'); return; }
    if(val==='ok'){
      if(pinBuf1.length<4){ showPinMsg('Enter all 4 digits','err'); return; }
      pinStep=2; document.getElementById('pin-step-lbl').textContent='STEP 2 OF 3 â€” CONFIRM PIN';
      showPinMsg('Re-enter your PIN to confirm','info'); renderPinDots('','normal'); return;
    }
    if(pinBuf1.length<4) pinBuf1+=val; renderPinDots(pinBuf1,'normal');
    if(pinBuf1.length===4) setTimeout(()=>handlePinKey('ok'),220);
  } else if(pinStep===2){
    if(val==='del'){ pinBuf2=pinBuf2.slice(0,-1); renderPinDots(pinBuf2,'normal'); return; }
    if(val==='ok'){
      if(pinBuf2.length<4){ showPinMsg('Enter all 4 digits','err'); return; }
      if(pinBuf1!==pinBuf2){ renderPinDots(pinBuf2,'error'); showPinMsg("PINs don\'t match â€” try again",'err'); setTimeout(()=>{ pinBuf2=''; renderPinDots('','normal'); hidePinMsg(); },1200); return; }
      pinStep='pass-set'; hideNumpad(); renderPinDots(pinBuf2,'match');
      const inp=document.getElementById('pin-passphrase-input');
      inp.type='password'; inp.maxLength=64; inp.value=''; inp.placeholder='Type your passphraseâ€¦';
      const btn=document.getElementById('pin-passphrase-btn');
      btn.textContent='SET PASSPHRASE â†’'; btn.onclick=submitPassphrase;
      document.getElementById('pin-step-lbl').textContent='STEP 3 OF 3 â€” SET PASSPHRASE';
      document.getElementById('pin-screen-desc').innerHTML='Create a secret passphrase.<br><span style="font-size:11px;color:var(--text-mid);">Needed to reset your PIN. Min 4 characters.</span>';
      showPinMsg('PIN confirmed! Now set a passphrase.','ok');
      setTimeout(()=>{ hidePinMsg(); showPassInput(); },600); return;
    }
    if(pinBuf2.length<4) pinBuf2+=val; renderPinDots(pinBuf2,'normal');
    if(pinBuf2.length===4) setTimeout(()=>handlePinKey('ok'),220);
  } else if(pinStep==='login'){
    if(val==='del'){ pinBufL=pinBufL.slice(0,-1); renderPinDots(pinBufL,'normal'); return; }
    if(val==='ok'){
      if(pinBufL.length<4){ showPinMsg('Enter all 4 digits','err'); return; }
      sha256(pinBufL).then(h=>{
        if(h===getH(PIN_KEY)){ clearLockout(); SESSION_PIN=pinBufL; pinAuthed=true; renderPinDots(pinBufL,'match'); showPinMsg('Access granted!','ok'); setTimeout(()=>enterHostSetup(),700); }
        else {
          renderPinDots(pinBufL,'error');
          const locked=recordFailedAttempt(), l=getLockout();
          if(locked){ showPinMsg('Too many attempts â€” locked for 30s','err'); startLockoutUI(l.until); }
          else { const left=3-(l.attempts||0); showPinMsg(`Incorrect PIN â€” ${left} attempt${left!==1?'s':''} left`,'err'); }
          setTimeout(()=>{ pinBufL=''; renderPinDots('','normal'); if(!checkLockout()) hidePinMsg(); },1200);
        }
      }); return;
    }
    if(pinBufL.length<4) pinBufL+=val; renderPinDots(pinBufL,'normal');
    if(pinBufL.length===4) setTimeout(()=>handlePinKey('ok'),220);
  } else if(pinStep==='reset-verify-pin'){
    if(val==='del'){ pinBufR1=pinBufR1.slice(0,-1); renderPinDots(pinBufR1,'normal'); return; }
    if(val==='ok'){
      if(pinBufR1.length<4){ showPinMsg('Enter all 4 digits','err'); return; }
      sha256(pinBufR1).then(h=>{
        if(h===getH(PIN_KEY)){
          clearLockout(); pinStep='reset-verify-pass'; hideNumpad(); renderPinDots(pinBufR1,'match');
          const inp=document.getElementById('pin-passphrase-input');
          inp.type='password'; inp.maxLength=64; inp.value=''; inp.placeholder='Type your passphraseâ€¦';
          const btn=document.getElementById('pin-passphrase-btn');
          btn.textContent='VERIFY PASSPHRASE â†’'; btn.onclick=submitPassphrase;
          document.getElementById('pin-step-lbl').textContent='STEP 2 OF 3 â€” VERIFY PASSPHRASE';
          document.getElementById('pin-screen-desc').innerHTML='Enter your <strong>secret passphrase</strong> to confirm.';
          showPinMsg('PIN verified â€” enter your passphrase','ok');
          setTimeout(()=>{ hidePinMsg(); showPassInput(); },600);
        } else {
          renderPinDots(pinBufR1,'error');
          const locked=recordFailedAttempt(), l=getLockout();
          if(locked){ showPinMsg('Too many attempts â€” locked for 30s','err'); startLockoutUI(l.until); }
          else showPinMsg('Incorrect PIN','err');
          setTimeout(()=>{ pinBufR1=''; renderPinDots('','normal'); if(!checkLockout()) hidePinMsg(); },1200);
        }
      }); return;
    }
    if(pinBufR1.length<4) pinBufR1+=val; renderPinDots(pinBufR1,'normal');
    if(pinBufR1.length===4) setTimeout(()=>handlePinKey('ok'),220);
  } else if(pinStep==='reset-set'){
    if(val==='del'){ pinBufR1=pinBufR1.slice(0,-1); renderPinDots(pinBufR1,'normal'); return; }
    if(val==='ok'){
      if(pinBufR1.length<4){ showPinMsg('Enter all 4 digits','err'); return; }
      pinStep='reset-confirm'; pinBufR2='';
      document.getElementById('pin-step-lbl').textContent='CONFIRM NEW PIN';
      showPinMsg('Re-enter to confirm','info'); renderPinDots('','normal'); return;
    }
    if(pinBufR1.length<4) pinBufR1+=val; renderPinDots(pinBufR1,'normal');
    if(pinBufR1.length===4) setTimeout(()=>handlePinKey('ok'),220);
  } else if(pinStep==='reset-confirm'){
    if(val==='del'){ pinBufR2=pinBufR2.slice(0,-1); renderPinDots(pinBufR2,'normal'); return; }
    if(val==='ok'){
      if(pinBufR2.length<4){ showPinMsg('Enter all 4 digits','err'); return; }
      if(pinBufR1!==pinBufR2){ renderPinDots(pinBufR2,'error'); showPinMsg("PINs don\'t match",'err'); setTimeout(()=>{ pinBufR2=''; renderPinDots('','normal'); hidePinMsg(); },1200); return; }
      sha256(pinBufR1).then(h=>{ setH(PIN_KEY,h); clearLockout(); renderPinDots(pinBufR2,'match'); showPinMsg('PIN updated! Entering host panelâ€¦','ok'); SESSION_PIN=pinBufR1; pinAuthed=true; setTimeout(()=>enterHostSetup(),800); }); return;
    }
    if(pinBufR2.length<4) pinBufR2+=val; renderPinDots(pinBufR2,'normal');
    if(pinBufR2.length===4) setTimeout(()=>handlePinKey('ok'),220);
  }
}

document.querySelectorAll('#s-pin .pin-key').forEach(k=>k.addEventListener('click',()=>handlePinKey(k.dataset.v)));
document.addEventListener('keydown',e=>{
  if(!document.getElementById('s-pin').classList.contains('active')) return;
  if(e.key>='0'&&e.key<='9') handlePinKey(e.key);
  else if(e.key==='Backspace') handlePinKey('del');
  else if(e.key==='Enter'){
    if(document.getElementById('pin-passphrase-wrap').style.display!=='none') submitPassphrase();
    else handlePinKey('ok');
  }
});
document.getElementById('pin-back-row').addEventListener('click',()=>{showScreen('s-portal');requestAnimationFrame(animPortal);});
document.getElementById('toggle-pin-btn').addEventListener('click',()=>{
  pinVisible=!pinVisible;
  document.getElementById('host-pin-display').textContent=pinVisible?SESSION_PIN:'â€¢â€¢â€¢â€¢';
});

function enterHostSetup(){
  document.getElementById('host-pin-display').textContent='â€¢â€¢â€¢â€¢';
  pinVisible=false; startHost();
}
document.getElementById('btn-host-card').addEventListener('click',()=>{initPinScreen();showScreen('s-pin');});
</script>

<!-- â•â• GAME MODE SELECTION â•â• -->
<script>
function selectGameMode(mode){
  GAME_MODE=mode;
  document.getElementById('gm-speed').classList.toggle('selected',mode==='speed');
  document.getElementById('gm-class').classList.toggle('selected',mode==='class');
  document.getElementById('class-mode-config').classList.toggle('show',mode==='class');
}
function selectQType(type){
  QUESTION_TYPE=type;
  document.getElementById('qt-abcd').classList.toggle('selected',type==='abcd');
  document.getElementById('qt-tf').classList.toggle('selected',type==='tf');
}
</script>

<!-- â•â• QUESTION BANK EDITOR â•â• -->
<script>
let customBanks={};

function getActiveBank(){
  const s=document.getElementById('sel-subject').value;
  if(!customBanks[s]) customBanks[s]=JSON.parse(JSON.stringify(QB[s]||QB.math));
  return customBanks[s];
}

function renderQEList(){
  const bank=getActiveBank(), subj=document.getElementById('sel-subject').value;
  document.getElementById('qe-meta').textContent=`${bank.length} questions Â· ${(subj).toUpperCase()} â€” click to edit`;
  const list=document.getElementById('qe-list');
  if(!bank.length){list.innerHTML='<div style="padding:20px;text-align:center;font-size:12px;font-weight:700;color:var(--text-mid);">No questions. Add one above.</div>';return;}
  list.innerHTML=bank.map((q,i)=>`
    <div class="qe-row">
      <span style="font-size:10px;font-weight:800;color:var(--text-mid);min-width:22px;">${String(i+1).padStart(2,'0')}</span>
      <span style="flex:1;font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${q.q}</span>
      <span class="qe-badge ${q.d}">${q.d.toUpperCase()}</span>
      <button class="qe-icon-btn edit" data-i="${i}" title="Edit">âœ</button>
      <button class="qe-icon-btn del" data-i="${i}" title="Delete">âœ•</button>
    </div>`).join('');
  list.querySelectorAll('.edit').forEach(b=>b.addEventListener('click',e=>{e.stopPropagation();openQModal(+b.dataset.i);}));
  list.querySelectorAll('.del').forEach(b=>b.addEventListener('click',e=>{e.stopPropagation();getActiveBank().splice(+b.dataset.i,1);renderQEList();}));
}

document.getElementById('sel-subject').addEventListener('change',()=>{
  document.getElementById('qe-list').innerHTML='<div style="padding:20px;text-align:center;font-size:12px;font-weight:700;color:var(--text-mid);">Subject changed. Click "Load Bank" to view.</div>';
  document.getElementById('qe-meta').textContent='Load questions from the selected subject';
});
document.getElementById('btn-load-qs').addEventListener('click',renderQEList);
document.getElementById('btn-add-q').addEventListener('click',()=>openQModal(-1));

let qEditIdx=-1;
function openQModal(idx){
  qEditIdx=idx;
  const bank=getActiveBank(), isEdit=idx>=0&&idx<bank.length;
  document.getElementById('qm-title').textContent=isEdit?'EDIT QUESTION':'ADD QUESTION';
  const q=isEdit?bank[idx]:{q:'',o:['','','',''],a:0,d:'medium'};
  document.getElementById('qm-q').value=q.q;
  [0,1,2,3].forEach(i=>document.getElementById('qm-o'+i).value=q.o[i]||'');
  document.querySelector(`input[name="qm-cor"][value="${q.a}"]`).checked=true;
  document.getElementById('qm-diff').value=q.d||'medium';
  document.getElementById('qm-explanation').value=q.explanation||'';
  document.getElementById('q-modal').style.display='flex';
  document.getElementById('qm-q').focus();
}
function closeQModal(){ document.getElementById('q-modal').style.display='none'; }
function saveQModal(){
  const txt=document.getElementById('qm-q').value.trim();
  if(!txt){alert('Enter a question.');return;}
  const opts=[0,1,2,3].map(i=>document.getElementById('qm-o'+i).value.trim());
  if(opts.some(o=>!o)){alert('Fill in all 4 options.');return;}
  const cor=document.querySelector('input[name="qm-cor"]:checked');
  if(!cor){alert('Select the correct answer.');return;}
  const q={q:txt,o:opts,a:+cor.value,d:document.getElementById('qm-diff').value,explanation:document.getElementById('qm-explanation').value.trim()};
  const bank=getActiveBank();
  if(qEditIdx>=0&&qEditIdx<bank.length) bank[qEditIdx]=q; else bank.push(q);
  renderQEList();closeQModal();
}
document.getElementById('qm-cancel').addEventListener('click',closeQModal);
document.getElementById('qm-save').addEventListener('click',saveQModal);
document.getElementById('q-modal').addEventListener('click',e=>{if(e.target===document.getElementById('q-modal'))closeQModal();});
</script>

<!-- â•â• CSV UPLOAD â•â• -->
<script>
function downloadCsvTemplate(){
  const header='question,option_a,option_b,option_c,option_d,correct,difficulty,explanation\n';
  const rows=[
    'What is the derivative of xÂ²?,2x,xÂ²,2,x,A,easy,The power rule: d/dx(xâ¿) = nxâ¿â»Â¹ so d/dx(xÂ²) = 2x',
    'Speed of light in a vacuum?,3Ã—10â¸ m/s,3Ã—10â¶ m/s,3Ã—10Â¹â° m/s,1.5Ã—10â¸ m/s,A,medium,Einstein\'s special relativity defines c â‰ˆ 299792458 m/s',
    'Who wrote Romeo and Juliet?,Shakespeare,Dickens,Austen,Hemingway,A,easy,William Shakespeare wrote Romeo and Juliet around 1595'
  ].join('\n');
  const blob=new Blob([header+rows],{type:'text/csv'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='quizzo_template.csv';a.click();
}

// Robust built-in CSV parser â€” handles quotes, commas inside quotes, CRLF, BOM
function parseCSV(text){
  // Strip BOM and normalise line endings
  text = text.replace(/^\uFEFF/,'').replace(/\r\n/g,'\n').replace(/\r/g,'\n');
  const rows=[];
  const lines=text.split('\n');
  for(let li=0;li<lines.length;li++){
    const line=lines[li];
    if(!line.trim()) continue;
    const row=[];
    let cur='', inQ=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='"'){
        if(inQ&&line[i+1]==='"'){ cur+='"'; i++; } // escaped quote
        else inQ=!inQ;
      } else if(ch===','&&!inQ){
        row.push(cur.trim()); cur='';
      } else {
        cur+=ch;
      }
    }
    row.push(cur.trim());
    rows.push(row);
  }
  return rows;
}

function parseCsvRows(rawText){
  const questions=[],errors=[];
  const allRows = parseCSV(rawText);
  if(allRows.length<2){ errors.push('File appears empty or has no data rows'); return{questions,errors}; }

  // Normalise header â€” lowercase, strip spaces/underscores
  const norm = s => s.toLowerCase().replace(/[\s_\-]/g,'');
  const header = allRows[0].map(norm);

  // Flexible column matching
  function col(aliases){
    for(const a of aliases){ const i=header.indexOf(norm(a)); if(i>=0) return i; }
    return -1;
  }
  const iQ   = col(['question','q','questions','text']);
  const iOA  = col(['option_a','optiona','a','opt_a','choice_a','answer_a','1']);
  const iOB  = col(['option_b','optionb','b','opt_b','choice_b','answer_b','2']);
  const iOC  = col(['option_c','optionc','c','opt_c','choice_c','answer_c','3']);
  const iOD  = col(['option_d','optiond','d','opt_d','choice_d','answer_d','4']);
  const iCor = col(['correct','answer','correct_answer','key','ans']);
  const iDif = col(['difficulty','diff','level','hard']);
  const iEx  = col(['explanation','explain','ex','hint','note','reason']);

  if(iQ<0||iOA<0||iOB<0||iCor<0){
    errors.push('Missing required columns. Need at least: question, option_a, option_b, correct');
    return{questions,errors};
  }

  // Map correct answer to index â€” accept A/B/C/D or 0/1/2/3 or 1/2/3/4
  const cmap={'A':0,'B':1,'C':2,'D':3,'0':0,'1':1,'2':2,'3':3};
  const cmap1={'1':0,'2':1,'3':2,'4':3}; // 1-indexed

  for(let i=1;i<allRows.length;i++){
    const row=allRows[i];
    const n=i+1;
    const q=(row[iQ]||'').trim();
    const oa=(row[iOA]||'').trim();
    const ob=(iOB>=0?(row[iOB]||''):'').trim();
    const oc=(iOC>=0?(row[iOC]||''):'').trim();
    const od=(iOD>=0?(row[iOD]||''):'').trim();
    const corRaw=(row[iCor]||'').trim().toUpperCase();
    const diff=((iDif>=0?row[iDif]:'') || 'medium').trim().toLowerCase();
    const explanation=(iEx>=0?(row[iEx]||''):'').trim();

    if(!q){ errors.push(`Row ${n}: Missing question â€” skipped`); continue; }
    if(!oa||!ob){ errors.push(`Row ${n}: Need at least 2 options â€” skipped`); continue; }
    if(!corRaw){ errors.push(`Row ${n}: Missing correct answer â€” skipped`); continue; }

    // Resolve correct answer index
    let aIdx = cmap.hasOwnProperty(corRaw) ? cmap[corRaw]
             : cmap1.hasOwnProperty(corRaw) ? cmap1[corRaw]
             : -1;
    if(aIdx<0){ errors.push(`Row ${n}: correct="${corRaw}" not recognised (use A/B/C/D or 1/2/3/4) â€” skipped`); continue; }

    // Build options array â€” allow 2-option questions (True/False style)
    const opts=[oa,ob];
    if(oc) opts.push(oc);
    if(od) opts.push(od);
    if(aIdx>=opts.length){ errors.push(`Row ${n}: correct index out of range for ${opts.length} options â€” skipped`); continue; }

    questions.push({
      q, o:opts, a:aIdx,
      d:['easy','medium','hard'].includes(diff)?diff:'medium',
      explanation
    });
  }
  return{questions,errors};
}

function processUploadedFile(file){
  const preview=document.getElementById('upload-preview');
  preview.innerHTML='<div class="upload-stat" style="color:#888">Reading file...</div>';
  preview.classList.add('show');
  const reader=new FileReader();
  reader.onload=e=>{
    const text=e.target.result;
    const{questions,errors}=parseCsvRows(text);
    preview.innerHTML='';
    if(!questions.length){
      preview.innerHTML=`<div class="upload-stat err">âœ— No valid questions found</div>`
        +(errors.length?`<div class="upload-error-list">${errors.map(e=>`â€¢ ${e}`).join('<br>')}</div>`:'');
      return;
    }
    // Store under its own key â€” never overwrite built-in banks
    customBanks['custom_upload']=questions;
    let sel=document.getElementById('sel-subject');
    let opt=sel.querySelector('option[value="custom_upload"]');
    if(!opt){ opt=document.createElement('option'); opt.value='custom_upload'; sel.appendChild(opt); }
    opt.textContent=`ğŸ“‚ Uploaded (${questions.length} Qs)`;
    sel.value='custom_upload';
    renderQEList();
    preview.innerHTML=`<div class="upload-stat ok">âœ“ ${questions.length} question${questions.length!==1?'s':''} imported</div>`
      +(errors.length?`<div class="upload-stat warn">âš  ${errors.length} row${errors.length!==1?'s':''} skipped</div><div class="upload-error-list">${errors.map(e=>`â€¢ ${e}`).join('<br>')}</div>`:'');
  };
  reader.onerror=()=>{ preview.innerHTML='<div class="upload-stat err">âœ— Could not read file</div>'; };
  reader.readAsText(file, 'UTF-8');
}

(function(){
  const zone=document.getElementById('upload-drop-zone');
  const input=document.getElementById('csv-file-input');
  const btn=document.getElementById('btn-upload-csv');
  if(btn) btn.addEventListener('click',()=>input.click());
  if(zone) zone.addEventListener('click',()=>input.click());
  if(input) input.addEventListener('change',e=>{ if(e.target.files[0]) processUploadedFile(e.target.files[0]); input.value=''; });
  if(zone){
    zone.addEventListener('dragover',e=>{e.preventDefault();zone.classList.add('drag-over');});
    zone.addEventListener('dragleave',()=>zone.classList.remove('drag-over'));
    zone.addEventListener('drop',e=>{e.preventDefault();zone.classList.remove('drag-over');const f=e.dataTransfer.files[0];if(f)processUploadedFile(f);});
  }
})();
</script>

<!-- â•â• DARK MODE â•â• -->
<script>
(function(){
  const btn=document.getElementById('dark-mode-toggle');
  let dark=localStorage.getItem('quizzo_dark')==='1';
  function applyDark(){
    document.body.classList.toggle('dark-mode',dark);
    btn.innerHTML=dark?'<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg> LIGHT':'<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg> DARK';
  }
  applyDark();
  btn.addEventListener('click',()=>{dark=!dark;localStorage.setItem('quizzo_dark',dark?'1':'0');applyDark();});
})();
</script>

<!-- â•â• INIT â•â• -->
<script>
initPortal();
animPortal();
</script>
</body>
</html>